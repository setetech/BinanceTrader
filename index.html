<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Binance Recovery Bot</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0b0e11;
  --bg-secondary: #1e2329;
  --bg-card: #181c22;
  --accent: #f0b90b;
  --green: #0ecb81;
  --red: #f6465d;
  --blue: #1e90ff;
  --text: #eaecef;
  --text-muted: #848e9c;
  --border: #2b3139;
  --purple: #a855f7;
}

html, body {
  height: 100%;
  background: var(--bg-primary);
  color: var(--text);
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  overflow: hidden;
  user-select: none;
  padding-bottom: 28px;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ===== APP SHELL ===== */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* ===== TOP BAR ===== */
#topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 50px;
  flex-shrink: 0;
}

#topbar .logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
}

#topbar .logo .sub {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 400;
}

#topbar .status-bar {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 12px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 4px;
}

.status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
.status-dot.offline { background: var(--red); }

/* ===== TABS ===== */
#tab-bar {
  display: flex;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--border);
  flex-shrink: 0;
}

.tab-btn {
  padding: 12px 24px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  white-space: nowrap;
}

.tab-btn:hover { color: var(--text); background: rgba(240,185,11,0.05); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

/* ===== TAB CONTENT ===== */
#tab-content {
  flex: 1;
  overflow: hidden;
}

.tab-panel {
  display: none;
  height: 100%;
  overflow: auto;
}

.tab-panel.active { display: block; }

/* ===== SCANNER TAB ===== */
#scanner-panel {
  display: none;
  height: 100%;
  overflow: hidden;
}
#scanner-panel.active {
  display: grid;
  grid-template-columns: 60% 40%;
  gap: 0;
}

.scanner-left {
  padding: 16px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}

.scanner-right {
  padding: 16px;
  overflow-y: auto;
}

/* ===== TRADING TAB ===== */
#trading-panel {
  display: none;
  height: 100%;
  overflow: hidden;
}
#trading-panel.active {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
}

.trading-left {
  padding: 16px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}

.trading-right {
  padding: 16px;
  overflow-y: auto;
}

/* ===== CONFIG TAB ===== */
#config-panel {
  padding: 16px;
  overflow-y: auto;
}

.config-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.config-actions {
  position: sticky;
  bottom: 0;
  display: flex;
  justify-content: flex-end;
  padding: 14px 0;
  background: linear-gradient(transparent, var(--bg) 30%);
  z-index: 10;
}

/* ===== GA OPTIMIZER ===== */
.stat-box {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
  text-align: center;
}
.stat-label {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 4px;
}
.stat-value {
  font-size: 18px;
  font-weight: 700;
}
.ga-progress-bar {
  background: var(--border);
  border-radius: 4px;
  height: 8px;
  overflow: hidden;
}
.ga-progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 4px;
  width: 0%;
  transition: width 0.3s;
}
.ga-params-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 6px;
  font-size: 12px;
}
.ga-params-grid b { color: var(--text-muted); }

/* ===== LOG TAB ===== */
#log-panel {
  padding: 16px;
  display: none;
  flex-direction: column;
  height: 100%;
}
#log-panel.active { display: flex; }

#log-container {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  overflow-y: auto;
  font-family: 'Cascadia Code', 'Consolas', 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.8;
}

.log-entry {
  display: flex;
  gap: 10px;
  padding: 2px 0;
}

.log-time {
  color: var(--text-muted);
  flex-shrink: 0;
}

.log-tag {
  padding: 1px 8px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  flex-shrink: 0;
  min-width: 65px;
  text-align: center;
}

.log-tag.binance { background: rgba(240,185,11,0.15); color: var(--accent); }
.log-tag.ia { background: rgba(168,85,247,0.15); color: var(--purple); }
.log-tag.bot { background: rgba(30,144,255,0.15); color: var(--blue); }
.log-tag.trade { background: rgba(14,203,129,0.15); color: var(--green); }
.log-tag.erro { background: rgba(246,70,93,0.15); color: var(--red); }
.log-tag.system { background: rgba(132,142,156,0.15); color: var(--text-muted); }

.log-message { color: var(--text); word-break: break-word; }

/* ===== HELP/MANUAL TAB ===== */
#help-panel {
  padding: 24px 32px;
  display: none;
  height: 100%;
  overflow-y: auto;
}
#help-panel.active { display: block; }

.help-container {
  max-width: 960px;
  margin: 0 auto;
}

.help-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 20px;
  overflow: hidden;
}

.help-section-header {
  background: var(--bg-secondary);
  padding: 14px 20px;
  font-size: 16px;
  font-weight: 700;
  color: var(--accent);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
}

.help-section-header:hover { background: rgba(240,185,11,0.06); }

.help-section-header .chevron {
  margin-left: auto;
  font-size: 12px;
  color: var(--text-muted);
  transition: transform 0.2s;
}

.help-section.open .chevron { transform: rotate(180deg); }

.help-section-body {
  padding: 20px;
  display: none;
  line-height: 1.8;
  color: var(--text);
  font-size: 13px;
}

.help-section.open .help-section-body { display: block; }

.help-param {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 16px;
  margin: 10px 0;
}

.help-param-name {
  font-weight: 700;
  color: var(--accent);
  font-size: 14px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.help-param-name .badge {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
}

.help-param-name .badge.required { background: rgba(246,70,93,0.15); color: var(--red); }
.help-param-name .badge.optional { background: rgba(132,142,156,0.15); color: var(--text-muted); }
.help-param-name .badge.danger { background: rgba(246,70,93,0.25); color: var(--red); }

.help-param-desc {
  color: var(--text-muted);
  font-size: 12px;
  line-height: 1.6;
}

.help-param-desc strong { color: var(--text); }

.help-tip {
  background: rgba(30,144,255,0.08);
  border-left: 3px solid var(--blue);
  padding: 10px 14px;
  border-radius: 0 6px 6px 0;
  margin: 12px 0;
  font-size: 12px;
  color: var(--blue);
  line-height: 1.6;
}

.help-warning {
  background: rgba(246,70,93,0.08);
  border-left: 3px solid var(--red);
  padding: 10px 14px;
  border-radius: 0 6px 6px 0;
  margin: 12px 0;
  font-size: 12px;
  color: var(--red);
  line-height: 1.6;
}

.help-flow {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin: 12px 0;
}

.help-flow-step {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
}

.help-flow-arrow {
  color: var(--accent);
  font-size: 16px;
  font-weight: 700;
}

.help-table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
  font-size: 12px;
}

.help-table th {
  text-align: left;
  padding: 8px 12px;
  background: var(--bg-secondary);
  color: var(--accent);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}

.help-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}

.help-table tr:hover td { background: rgba(240,185,11,0.03); }

/* ===== CARDS ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.card-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

/* ===== BUTTONS ===== */
.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-accent { background: var(--accent); color: #0b0e11; }
.btn-accent:hover { background: #d4a30a; }
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { background: #0bb574; }
.btn-red { background: var(--red); color: #fff; }
.btn-red:hover { background: #e03b50; }
.btn-blue { background: var(--blue); color: #fff; }
.btn-blue:hover { background: #1a7de0; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.ai-preset-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-lg { padding: 12px 32px; font-size: 16px; }

/* ===== TABLE ===== */
.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th {
  text-align: left;
  padding: 10px 12px;
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
  border-bottom: 1px solid var(--border);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(43,49,57,0.5);
  font-size: 13px;
}

.data-table tr:hover { background: rgba(240,185,11,0.03); }
.data-table tr.selected-row { background: rgba(240,185,11,0.08); border-left: 2px solid var(--accent); }
.data-table tr { cursor: pointer; }

.positive { color: var(--green); }
.negative { color: var(--red); }

/* ===== COIN DETAIL ===== */
.coin-header {
  display: flex;
  align-items: baseline;
  gap: 12px;
  margin-bottom: 4px;
}

.coin-symbol { font-size: 22px; font-weight: 700; color: var(--accent); }
.coin-price { font-size: 28px; font-weight: 700; }
.coin-change { font-size: 14px; font-weight: 600; }

/* ===== CHART ===== */
.chart-container {
  position: relative;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 12px;
}

.chart-container canvas { display: block; width: 100%; }

.chart-tooltip {
  position: absolute;
  top: 8px;
  left: 8px;
  background: rgba(11,14,17,0.92);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 8px 10px;
  font-size: 11px;
  pointer-events: none;
  display: none;
  z-index: 10;
  color: var(--text);
  line-height: 1.6;
}

/* ===== INDICATORS GRID ===== */
.indicators-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}

.indicator-item {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
}

.indicator-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.indicator-value { font-size: 16px; font-weight: 600; }

/* ===== SIGNAL CARD ===== */
.signal-card { border-left: 3px solid var(--text-muted); }
.signal-card.STRONG_BUY, .signal-card.BUY { border-left-color: var(--green); }
.signal-card.SELL, .signal-card.STRONG_SELL { border-left-color: var(--red); }
.signal-card.HOLD { border-left-color: var(--accent); }

.signal-name { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
.signal-name.STRONG_BUY, .signal-name.BUY { color: var(--green); }
.signal-name.SELL, .signal-name.STRONG_SELL { color: var(--red); }
.signal-name.HOLD { color: var(--accent); }

.confidence-bar-bg {
  width: 100%;
  height: 8px;
  background: var(--bg-primary);
  border-radius: 4px;
  overflow: hidden;
  margin: 8px 0;
}

.confidence-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.signal-reasoning {
  font-size: 13px;
  color: var(--text-muted);
  line-height: 1.5;
  margin: 10px 0;
  font-style: italic;
}

.signal-prices {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  margin-top: 10px;
}

.signal-price-item {
  text-align: center;
  padding: 6px;
  background: var(--bg-primary);
  border-radius: 4px;
}

.signal-price-label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
}

.signal-price-value {
  font-size: 14px;
  font-weight: 600;
  margin-top: 2px;
}

/* ===== INPUTS ===== */
.input-group { margin-bottom: 14px; }

.input-group label {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.input-wrapper {
  display: flex;
  align-items: center;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
}
.input-wrapper:focus-within { border-color: var(--accent); }

.input-wrapper input,
.input-wrapper select {
  flex: 1;
  background: transparent;
  border: none;
  padding: 10px 12px;
  color: var(--text);
  font-size: 14px;
  outline: none;
}

.input-wrapper .suffix {
  padding: 0 12px;
  color: var(--text-muted);
  font-size: 13px;
  font-weight: 500;
}

input, select, textarea {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  color: var(--text);
  font-size: 14px;
  outline: none;
  width: 100%;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }

/* ===== TRADE BUTTONS ===== */
.trade-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 16px;
}

/* ===== BOT ===== */
.bot-controls {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

.bot-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: var(--bg-primary);
  border-radius: 6px;
  font-size: 13px;
}

/* ===== TOGGLE ===== */
.toggle-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
  flex-shrink: 0;
}
.toggle-switch.active { background: var(--accent); }

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.3s;
}
.toggle-switch.active::after { transform: translateX(20px); }

/* ===== WARNING ===== */
.warning-box {
  background: rgba(246,70,93,0.1);
  border: 1px solid rgba(246,70,93,0.3);
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 12px;
  color: var(--red);
  margin-top: 10px;
  line-height: 1.5;
}

/* ===== MISC ===== */
.scan-progress {
  font-size: 12px;
  color: var(--accent);
  margin-left: 12px;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.placeholder-text {
  color: var(--text-muted);
  font-size: 14px;
  text-align: center;
  padding: 40px 20px;
}

.no-selection {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  gap: 10px;
}
.no-selection .icon { font-size: 48px; opacity: 0.3; }
.no-selection .text { font-size: 14px; }

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}
.badge-testnet { background: rgba(240,185,11,0.15); color: var(--accent); }
.badge-mainnet { background: rgba(14,203,129,0.15); color: var(--green); }

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 28px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  font-size: 11px;
  color: var(--text-muted);
  font-family: 'Consolas', monospace;
  z-index: 100;
}
.footer span { display: flex; align-items: center; gap: 8px; }
.footer .accent { color: var(--accent); }

/* ===== PERFORMANCE TAB ===== */
.perf-panel { padding: 16px; overflow-y: auto; height: 100%; }

.perf-cards-row {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}
.perf-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  text-align: center;
}
.perf-card-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.perf-card-value { font-size: 22px; font-weight: 700; }
.perf-card-value.positive { color: var(--green); }
.perf-card-value.negative { color: var(--red); }
.perf-card-value.neutral { color: var(--text); }
.perf-card-sub { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

.perf-chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 16px;
}
.perf-chart-card .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block; }
#equity-canvas { width: 100%; height: 220px; display: block; border-radius: 4px; }

.perf-tables-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
.perf-table-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  overflow-x: auto;
}
.perf-table-card .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block; }
.perf-table-card table { width: 100%; }
.perf-full-width { grid-column: 1 / -1; }

.perf-row-positive { background: rgba(14,203,129,0.06); }
.perf-row-negative { background: rgba(246,70,93,0.06); }

/* ===== WALLET (CARTEIRA) TAB ===== */
.wallet-panel { padding: 16px; overflow-y: auto; height: 100%; }
.wallet-summary-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.wallet-total-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.wallet-total-value { font-size: 28px; font-weight: 700; color: var(--accent); }
.wallet-total-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.wallet-table-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  overflow-x: auto;
}
.wallet-table-card .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block; }
.wallet-table-card table { width: 100%; }
.wallet-loading { text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px; }

/* ===== CHAT TAB ===== */
.tab-panel.chat-panel.active {
  display: flex; flex-direction: column; padding: 0; overflow: hidden;
}
.chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  background: var(--bg-secondary); height: 45px; min-height: 45px;
}
.chat-title { font-weight: 700; font-size: 14px; color: var(--accent); }
.chat-messages {
  overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;
  height: calc(100vh - 50px - 42px - 28px - 45px - 64px);
}
.chat-welcome {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 40px 20px; text-align: center; color: var(--text-muted); gap: 12px; flex: 1;
}
.chat-welcome-icon { font-size: 48px; }
.chat-welcome-text { font-size: 14px; line-height: 1.6; max-width: 500px; }
.chat-msg {
  max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 13px;
  line-height: 1.55; word-wrap: break-word; white-space: pre-wrap;
}
.chat-msg-user {
  align-self: flex-end; background: var(--accent); color: #000;
  border-bottom-right-radius: 4px;
}
.chat-msg-ai {
  align-self: flex-start; background: var(--bg-card); border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}
.chat-msg-ai p { margin: 0 0 8px 0; }
.chat-msg-ai p:last-child { margin-bottom: 0; }
.chat-msg-ai strong { color: var(--accent); }
.chat-msg-ai code {
  background: var(--bg-primary); padding: 1px 5px; border-radius: 3px; font-size: 12px;
}
.chat-msg-ai ul, .chat-msg-ai ol { margin: 4px 0 8px 18px; }
.chat-msg-ai li { margin-bottom: 3px; }
.chat-msg-error { color: var(--red); font-style: italic; }
.chat-msg-time {
  font-size: 10px; color: var(--text-muted); margin-top: 4px;
}
.chat-typing {
  align-self: flex-start; padding: 10px 14px; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: 12px; border-bottom-left-radius: 4px;
  color: var(--text-muted); font-size: 13px;
}
.chat-typing-dots::after {
  content: ''; animation: typingDots 1.4s infinite;
}
@keyframes typingDots {
  0% { content: '.'; }
  33% { content: '..'; }
  66% { content: '...'; }
}
.chat-input-area {
  display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border);
  background: var(--bg-secondary); min-height: 64px; align-items: flex-end;
}
.chat-input-area textarea {
  flex: 1; resize: none; background: var(--bg-primary); border: 1px solid var(--border);
  color: var(--text); border-radius: 8px; padding: 10px 12px; font-size: 13px;
  font-family: inherit; outline: none; max-height: 120px; min-height: 40px;
  line-height: 1.4;
}
.chat-input-area textarea:focus { border-color: var(--accent); }
.chat-send-btn { padding: 10px 20px; font-size: 13px; min-height: 40px; }

/* ===== COIN HISTORY MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal-content {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  width: 560px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  animation: modalIn 0.2s ease-out;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.modal-header-left { display: flex; align-items: baseline; gap: 10px; }
.modal-symbol { font-size: 18px; font-weight: 700; color: var(--accent); }
.modal-price { font-size: 16px; font-weight: 600; }
.modal-change { font-size: 13px; font-weight: 600; }
.modal-close-btn {
  background: none; border: none; color: var(--text-muted);
  font-size: 22px; cursor: pointer; padding: 4px 8px; border-radius: 4px;
}
.modal-close-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.modal-body { padding: 16px 20px; }
.modal-tf-btns { display: flex; gap: 8px; margin-bottom: 12px; }
.modal-tf-btn {
  padding: 5px 16px; border: 1px solid var(--border); border-radius: 4px;
  background: transparent; color: var(--text-muted); font-size: 12px;
  font-weight: 600; cursor: pointer;
}
.modal-tf-btn.active { background: var(--accent); color: #0b0e11; border-color: var(--accent); }
.modal-chart-wrapper {
  background: var(--bg-primary); border-radius: 6px; padding: 8px; margin-bottom: 16px;
}
.modal-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.modal-stat-item {
  text-align: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;
}
.modal-stat-label {
  font-size: 10px; color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 4px;
}
.modal-stat-value { font-size: 14px; font-weight: 600; }
.modal-loading { text-align: center; padding: 40px; color: var(--text-muted); font-size: 13px; }
.wallet-row-clickable:hover { background: rgba(255,255,255,0.04); }
</style>
</head>
<body>

<div id="app">

  <!-- ====== TOP BAR ====== -->
  <div id="topbar">
    <div class="logo">
      <span>&#x1F680; Binance Recovery Bot</span>
      <span class="sub">v1.0</span>
    </div>
    <div class="status-bar">
      <span id="scan-progress-bar"></span>
      <span id="connection-status">
        <span class="status-dot offline" id="conn-dot"></span>
        <span id="conn-text">Desconectado</span>
      </span>
      <span id="net-badge" class="badge badge-testnet" style="display:none;">TESTNET</span>
    </div>
  </div>

  <!-- ====== TAB BAR ====== -->
  <div id="tab-bar">
    <button class="tab-btn active" data-tab="scanner">&#x1F50D; Scanner</button>
    <button class="tab-btn" data-tab="trading">&#x1F4B9; Trading</button>
    <button class="tab-btn" data-tab="config">&#x2699;&#xFE0F; Configuracoes</button>
    <button class="tab-btn" data-tab="log">&#x1F4CB; Log</button>
    <button class="tab-btn" data-tab="optimizer">&#x1F9EC; Otimizador GA</button>
    <button class="tab-btn" data-tab="help">&#x1F4D6; Manual</button>
    <button class="tab-btn" data-tab="performance">&#x1F4CA; Desempenho</button>
    <button class="tab-btn" data-tab="wallet">&#x1F4B0; Carteira</button>
    <button class="tab-btn" data-tab="chat">&#x1F4AC; Chat IA</button>
  </div>

  <!-- ====== TAB CONTENT ====== -->
  <div id="tab-content">

    <!-- ==================== SCANNER TAB ==================== -->
    <div id="scanner-panel" class="tab-panel active" data-tab-panel="scanner">
      <div class="scanner-left">
        <div class="card">
          <div class="card-header">
            <span class="card-title" id="scanner-title">&#x1F3C6; Top Recovery Coins (24h)</span>
            <div style="display:flex;align-items:center;gap:10px;">
              <span id="last-scan-time" style="font-size:11px;color:var(--text-muted);"></span>
              <button class="btn btn-accent btn-sm" id="btn-scan" onclick="doScan()">&#x1F504; Scan Now</button>
            </div>
          </div>
          <table class="data-table" id="coins-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Moeda</th>
                <th>Preco</th>
                <th id="th-variation">Variacao 24h</th>
                <th>Volume</th>
                <th>Acao</th>
              </tr>
            </thead>
            <tbody id="coins-tbody">
              <tr><td colspan="6" class="placeholder-text">Clique em "Scan Now" para buscar as moedas com melhor recuperacao.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="scanner-right" id="scanner-detail">
        <div class="no-selection" id="no-coin-selected">
          <div class="icon">&#x1F4C8;</div>
          <div class="text">Selecione uma moeda para ver detalhes</div>
        </div>

        <div id="coin-detail" style="display:none;">
          <!-- Coin Header -->
          <div class="card">
            <div class="coin-header">
              <span class="coin-symbol" id="detail-symbol">--</span>
              <span class="coin-change" id="detail-change">--</span>
            </div>
            <div class="coin-price" id="detail-price">--</div>
          </div>

          <!-- Chart -->
          <div class="card" style="padding:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <span style="font-size:12px; color:var(--text-dim);">Grafico de Candles</span>
              <button class="btn" onclick="sendChartToTelegram()" title="Enviar grafico para o Telegram" style="font-size:12px; padding:5px 14px; background:var(--accent); color:#000; font-weight:600;">
                &#x1F4E4; Enviar Telegram
              </button>
            </div>
            <div class="chart-container" id="chart-wrapper">
              <canvas id="candle-chart" height="300"></canvas>
              <div class="chart-tooltip" id="chart-tooltip"></div>
            </div>
          </div>

          <!-- Indicators -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">&#x1F4CA; Indicadores Tecnicos</span>
            </div>
            <div class="indicators-grid" id="indicators-grid">
              <div class="indicator-item">
                <div class="indicator-label">RSI (14)</div>
                <div class="indicator-value" id="ind-rsi">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">MACD</div>
                <div class="indicator-value" id="ind-macd">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">SMA 20</div>
                <div class="indicator-value" id="ind-sma20">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">SMA 50</div>
                <div class="indicator-value" id="ind-sma50">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">Bollinger Sup</div>
                <div class="indicator-value" id="ind-boll-up">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">Bollinger Inf</div>
                <div class="indicator-value" id="ind-boll-low">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">EMA 12</div>
                <div class="indicator-value" id="ind-ema12">--</div>
              </div>
              <div class="indicator-item">
                <div class="indicator-label">ATR</div>
                <div class="indicator-value" id="ind-atr">--</div>
              </div>
            </div>
          </div>

          <!-- Signal -->
          <div class="card signal-card" id="signal-card">
            <div class="card-header">
              <span class="card-title">&#x1F916; Sinal IA</span>
              <button class="btn btn-blue btn-sm" id="btn-analyze" onclick="doAnalyze()">&#x1F9E0; Analisar com IA</button>
            </div>
            <div id="signal-content">
              <div class="placeholder-text">Clique em "Analisar com IA" para gerar sinal.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TRADING TAB ==================== -->
    <div id="trading-panel" class="tab-panel" data-tab-panel="trading">
      <div class="trading-left">
        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F4B0; Negociacao</span>
          </div>
          <div style="margin-bottom:14px;">
            <span style="font-size:12px;color:var(--text-muted);">MOEDA SELECIONADA</span>
            <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
              <div style="font-size:18px;font-weight:700;color:var(--accent);" id="trade-selected-coin">Nenhuma selecionada</div>
              <button class="btn btn-sm" onclick="openCoinSelectorModal()" style="font-size:11px;padding:4px 10px;">&#x1F50D; Selecionar</button>
            </div>
            <div style="font-size:14px;color:var(--text-muted);margin-top:2px;" id="trade-selected-price">--</div>
          </div>
          <div class="input-group">
            <label>Quantidade</label>
            <div class="input-wrapper">
              <input type="number" id="trade-amount" placeholder="0.00" step="0.01" min="0">
              <span class="suffix">USDT</span>
            </div>
          </div>
          <div class="trade-buttons">
            <button class="btn btn-green btn-lg" onclick="doBuy()">&#x1F7E2; COMPRAR</button>
            <button class="btn btn-red btn-lg" onclick="doSell()">&#x1F534; VENDER</button>
          </div>
          <div style="margin-top:8px;text-align:center;">
            <button class="btn btn-sm" onclick="doRegisterPosition()" style="font-size:11px;padding:4px 12px;opacity:0.7;">
              &#x1F4CB; Registrar Posicao (moeda ja comprada fora do bot)
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F916; Bot Automatico</span>
          </div>
          <div class="bot-status">
            <span class="status-dot offline" id="bot-dot"></span>
            <span id="bot-status-text">Bot parado</span>
          </div>
          <div class="bot-controls">
            <button class="btn btn-green" id="btn-start-bot" onclick="doStartBot()">&#x25B6; Iniciar Bot</button>
            <button class="btn btn-red" id="btn-stop-bot" onclick="doStopBot()" disabled>&#x23F9; Parar Bot</button>
          </div>
          <div class="toggle-wrapper" style="margin-top:14px;">
            <div>
              <div style="font-size:13px;font-weight:600;">Auto-Trade</div>
              <div style="font-size:11px;color:var(--text-muted);">Execucao automatica de ordens</div>
            </div>
            <div class="toggle-switch" id="toggle-autotrade" onclick="toggleAutoTrade()"></div>
          </div>
          <div class="warning-box" id="autotrade-warning" style="display:none;">
            &#x26A0;&#xFE0F; <strong>Atencao:</strong> Auto-trade executara ordens reais automaticamente. Use com cautela e sempre em testnet primeiro.
          </div>
        </div>
      </div>

      <div class="trading-right">
        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F4B3; Saldo</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Base (<span id="bal-base-asset">--</span>)</div>
              <div style="font-size:18px;font-weight:700;margin-top:4px;" id="bal-base-free">0.00</div>
              <div style="font-size:11px;color:var(--text-muted);">Bloqueado: <span id="bal-base-locked">0.00</span></div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Quote (<span id="bal-quote-asset">USDT</span>)</div>
              <div style="font-size:18px;font-weight:700;margin-top:4px;" id="bal-quote-free">0.00</div>
              <div style="font-size:11px;color:var(--text-muted);">Bloqueado: <span id="bal-quote-locked">0.00</span></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F4DC; Historico de Trades</span>
            <button class="btn btn-outline btn-sm" onclick="sendToDelphi('loadBinanceTrades',{})">&#x1F504; Atualizar da Binance</button>
          </div>
          <div style="max-height:400px;overflow-y:auto;">
            <table class="data-table" id="trades-table">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Par</th>
                  <th>Lado</th>
                  <th>Preco</th>
                  <th>Qtd</th>
                  <th>Sinal</th>
                </tr>
              </thead>
              <tbody id="trades-tbody">
                <tr><td colspan="6" class="placeholder-text">Nenhum trade registrado.</td></tr>
              </tbody>
            </table>
          </div>
          <div id="trade-error-banner" style="display:none;background:rgba(246,70,93,0.15);border:1px solid var(--red);color:var(--red);padding:8px 12px;border-radius:6px;margin-top:8px;font-size:12px;word-break:break-word;"></div>
        </div>
      </div>
    </div>

    <!-- ==================== CONFIG TAB ==================== -->
    <div id="config-panel" class="tab-panel" data-tab-panel="config">
      <div class="config-grid">
        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F511; Binance API</span>
          </div>
          <div class="toggle-wrapper" style="margin-bottom:12px;">
            <div>
              <div style="font-size:13px;font-weight:600;">Modo de Operacao</div>
              <div style="font-size:11px;color:var(--text-muted);" id="cfg-mode-label">Testnet (rede de teste)</div>
            </div>
            <div class="toggle-switch" id="cfg-testnet" onclick="toggleConfigSwitch('cfg-testnet'); updateApiKeyVisibility();"></div>
          </div>
          <div id="keys-testnet-group">
            <div style="font-size:11px;font-weight:600;color:#f0b90b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Chaves Testnet</div>
            <div class="input-group">
              <label>API Key (Testnet)</label>
              <input type="password" id="cfg-apiKeyTest" placeholder="API Key da Testnet">
            </div>
            <div class="input-group">
              <label>Secret Key (Testnet)</label>
              <input type="password" id="cfg-secretKeyTest" placeholder="Secret Key da Testnet">
            </div>
          </div>
          <div id="keys-prod-group">
            <div style="font-size:11px;font-weight:600;color:#0ecb81;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Chaves Producao</div>
            <div class="input-group">
              <label>API Key (Producao)</label>
              <input type="password" id="cfg-apiKeyProd" placeholder="API Key de Producao">
            </div>
            <div class="input-group">
              <label>Secret Key (Producao)</label>
              <input type="password" id="cfg-secretKeyProd" placeholder="Secret Key de Producao">
            </div>
          </div>
          <button class="btn btn-outline" style="margin-top:8px;" onclick="doTestConnection()">&#x1F50C; Testar Conexao</button>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F9E0; IA / LLM</span>
            <span id="ai-vision-badge" style="display:none;font-size:10px;background:var(--accent);color:#000;padding:2px 8px;border-radius:10px;font-weight:700;">VISION</span>
          </div>
          <div style="margin-bottom:12px;">
            <label style="font-size:11px;color:var(--text-muted);margin-bottom:6px;display:block;">Preset Rapido</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button class="btn btn-outline ai-preset-btn" data-preset="openai" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('openai')">OpenAI</button>
              <button class="btn btn-outline ai-preset-btn" data-preset="groq" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('groq')">Groq (Gratis)</button>
              <button class="btn btn-outline ai-preset-btn" data-preset="mistral" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('mistral')">Mistral (Gratis)</button>
              <button class="btn btn-outline ai-preset-btn" data-preset="cerebras" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('cerebras')">Cerebras (Gratis)</button>
              <button class="btn btn-outline ai-preset-btn" data-preset="deepseek" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('deepseek')">DeepSeek</button>
              <button class="btn btn-outline ai-preset-btn" data-preset="lmstudio" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('lmstudio')">LM Studio (Local)</button>
              <button class="btn btn-outline ai-preset-btn" data-preset="ollama" style="font-size:11px;padding:4px 10px;" onclick="applyAIPreset('ollama')">Ollama (Local)</button>
            </div>
          </div>
          <div class="input-group">
            <label>API Key IA</label>
            <input type="password" id="cfg-aiKey" placeholder="API Key da IA">
          </div>
          <div class="input-group">
            <label>Modelo</label>
            <select id="cfg-aiModel" onchange="onAIModelChange()">
              <optgroup label="OpenAI">
                <option value="gpt-4o">GPT-4o (Vision)</option>
                <option value="gpt-4o-mini">GPT-4o Mini (Vision)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              </optgroup>
              <optgroup label="Anthropic">
                <option value="claude-sonnet-4-20250514">Claude Sonnet</option>
                <option value="claude-haiku-4-20250506">Claude Haiku</option>
              </optgroup>
              <optgroup label="Groq (Gratis)">
                <option value="llama-3.3-70b-versatile">Llama 3.3 70B</option>
                <option value="llama-3.1-8b-instant">Llama 3.1 8B (Rapido)</option>
                <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                <option value="gemma2-9b-it">Gemma 2 9B</option>
              </optgroup>
              <optgroup label="Mistral (Gratis)">
                <option value="mistral-small-latest">Mistral Small</option>
                <option value="mistral-medium-latest">Mistral Medium</option>
                <option value="open-mistral-nemo">Mistral Nemo 12B</option>
              </optgroup>
              <optgroup label="Cerebras (Gratis)">
                <option value="llama-3.3-70b">Llama 3.3 70B</option>
                <option value="llama-3.1-8b">Llama 3.1 8B</option>
              </optgroup>
              <optgroup label="DeepSeek">
                <option value="deepseek-chat">DeepSeek Chat</option>
              </optgroup>
              <optgroup label="LM Studio (Local)">
                <option value="qwen3-vl-8b">Qwen3-VL-8B (Vision)</option>
                <option value="qwen3-8b">Qwen3-8B</option>
                <option value="qwen2.5-7b-instruct">Qwen2.5-7B</option>
                <option value="gemma-3n-e4b-it-text">Gemma 3N 4B (Rapido)</option>
                <option value="gemma-3-12b-it">Gemma 3 12B</option>
              </optgroup>
              <optgroup label="Outro">
                <option value="custom">Custom</option>
              </optgroup>
            </select>
          </div>
          <div class="input-group" id="ai-custom-model-group" style="display:none;">
            <label>Nome do Modelo (Custom)</label>
            <input type="text" id="cfg-aiModelCustom" placeholder="nome-do-modelo" oninput="onAIModelChange()">
          </div>
          <div class="input-group">
            <label>Base URL</label>
            <input type="text" id="cfg-aiBaseURL" placeholder="https://api.openai.com/v1">
          </div>
          <div class="input-group" style="margin-top:8px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="cfg-aiVision" onchange="onAIModelChange()" style="width:16px;height:16px;">
              Enviar grafico (Vision) - usa mais tokens e e mais lento
            </label>
          </div>
          <div id="ai-vision-info" style="display:none;margin-top:8px;padding:8px 12px;background:rgba(0,200,150,0.1);border:1px solid rgba(0,200,150,0.3);border-radius:6px;font-size:11px;color:var(--text-muted);">
            &#x1F441; <strong>Vision ativado:</strong> Um grafico de candles (800x450) sera gerado e enviado junto com os indicadores. Usa mais tokens mas permite analise visual de padroes.
          </div>
          <div class="input-group" style="margin-top:8px;">
            <label>Cache IA (minutos) - evita re-analisar moeda recente</label>
            <input type="number" id="cfg-aiCacheMins" placeholder="15" step="1" min="0" value="15">
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
            <button class="btn btn-outline" id="btn-test-ai" onclick="doTestAI()">Testar Conexao IA</button>
            <span id="ai-test-result" style="font-size:12px;"></span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">&#x1F4C9; Parametros de Trading</span>
          </div>
          <div class="input-group">
            <label>Valor por Trade (USDT)</label>
            <input type="number" id="cfg-tradeAmount" placeholder="10" step="1" min="1">
          </div>
          <div class="input-group">
            <label>Trailing Stop (%)</label>
            <input type="number" id="cfg-trailingStop" placeholder="3" step="0.1" min="0">
          </div>
          <div class="input-group">
            <label>Take Profit (%)</label>
            <input type="number" id="cfg-takeProfit" placeholder="3" step="0.1" min="0">
          </div>
          <div class="input-group">
            <label>Confianca Minima (%)</label>
            <input type="number" id="cfg-minConfidence" placeholder="70" step="1" min="0" max="100">
          </div>
          <div class="input-group">
            <label>Score Minimo (pre-filtro IA)</label>
            <input type="number" id="cfg-minScore" placeholder="25" step="5" min="0" max="80">
          </div>
          <div class="input-group">
            <label>Intervalo do Bot (segundos)</label>
            <input type="number" id="cfg-botInterval" placeholder="60" step="1" min="5">
          </div>
          <div class="input-group">
            <label>Modo de Scan</label>
            <select id="cfg-scanMode" onchange="updateScanModeUI()">
              <option value="multi">Multi-Scan (todos os filtros)</option>
              <option value="recovery">Recuperacao (moedas em alta)</option>
              <option value="volume">Volume (mais negociadas)</option>
              <option value="rsi">RSI Extremos (sobrevendido/sobrecomprado)</option>
              <option value="breakout">Breakout (squeeze Bollinger)</option>
              <option value="macd">MACD Crossover (cruzamento fresco)</option>
              <option value="momentum">Momentum (tendencia forte)</option>
              <option value="flashdip">Flash Dip (queda subita 1h)</option>
              <option value="aiselect">AI Select (Binance)</option>
            </select>
          </div>
          <div class="input-group" id="group-recoveryHours">
            <label>Periodo de Recuperacao (horas)</label>
            <input type="number" id="cfg-recoveryHours" placeholder="24" step="1" min="1" max="168">
          </div>
          <div class="input-group">
            <label>Moedas no Scanner (top N)</label>
            <input type="number" id="cfg-topCoins" placeholder="30" step="1" min="1" max="100">
          </div>
          <div class="input-group">
            <label>Timeout Lateralizacao (horas)</label>
            <input type="number" id="cfg-lateralTimeout" placeholder="24" step="1" min="1" max="168">
          </div>
          <div class="input-group">
            <label>Cooldown entre Trades (minutos)</label>
            <input type="number" id="cfg-tradeCooldown" placeholder="30" step="5" min="5" max="1440">
          </div>
          <div class="input-group">
            <label>Snapshot Carteira (minutos)</label>
            <input type="number" id="cfg-snapshotInterval" placeholder="30" step="5" min="5" max="1440">
          </div>
          <div class="input-group">
            <label>Intervalo de Candles</label>
            <select id="cfg-interval">
              <option value="1h">1 hora</option>
              <option value="4h" selected>4 horas (Recomendado)</option>
              <option value="1d">1 dia</option>
            </select>
          </div>
          <div class="toggle-wrapper">
            <div>
              <div style="font-size:13px;font-weight:600;">Auto-Trade</div>
              <div style="font-size:11px;color:var(--text-muted);">Habilitar execucao automatica</div>
            </div>
            <div class="toggle-switch" id="cfg-autoTrade" onclick="toggleConfigSwitch('cfg-autoTrade')"></div>
          </div>
          <div class="toggle-wrapper">
            <div>
              <div style="font-size:13px;font-weight:600;">DCA Automatico</div>
              <div style="font-size:11px;color:var(--text-muted);">Comprar mais em degraus de queda</div>
            </div>
            <div class="toggle-switch" id="cfg-dcaEnabled" onclick="toggleConfigSwitch('cfg-dcaEnabled')"></div>
          </div>
          <div class="input-group">
            <label>Max DCA (compras extras)</label>
            <input type="number" id="cfg-dcaMax" placeholder="3" step="1" min="1" max="3">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <div class="input-group">
              <label>DCA 1 (%)</label>
              <input type="number" id="cfg-dcaLevel1" placeholder="3" step="0.5" min="1">
            </div>
            <div class="input-group">
              <label>DCA 2 (%)</label>
              <input type="number" id="cfg-dcaLevel2" placeholder="5" step="0.5" min="1">
            </div>
            <div class="input-group">
              <label>DCA 3 (%)</label>
              <input type="number" id="cfg-dcaLevel3" placeholder="8" step="0.5" min="1">
            </div>
          </div>
        </div>

        <!-- Telegram -->
        <div class="card">
          <h3>Telegram</h3>
          <div class="toggle-wrapper">
            <div>
              <div style="font-size:13px;font-weight:600;">Notificacoes Telegram</div>
              <div style="font-size:11px;color:var(--text-muted);">Receber alertas de compra, venda e oportunidades</div>
            </div>
            <div class="toggle-switch" id="cfg-telegramEnabled" onclick="toggleConfigSwitch('cfg-telegramEnabled')"></div>
          </div>
          <div class="input-group">
            <label>Bot Token</label>
            <input type="text" id="cfg-telegramToken" placeholder="123456789:ABCdefGhi..." style="font-family:monospace;font-size:12px;">
          </div>
          <div class="input-group">
            <label>Chat ID</label>
            <input type="text" id="cfg-telegramChatId" placeholder="123456789" style="font-family:monospace;font-size:12px;">
          </div>
          <div style="margin-top:8px;">
            <button class="btn" onclick="doTestTelegram()" style="font-size:12px;padding:6px 14px;">Enviar Teste</button>
            <span style="font-size:11px;color:var(--text-muted);margin-left:8px;">Crie um bot no @BotFather e envie /start</span>
          </div>
        </div>
      </div>
      <div class="config-actions">
        <button class="btn btn-accent btn-lg" onclick="doSaveConfig()">&#x1F4BE; Salvar Configuracoes</button>
      </div>
    </div>

    <!-- ==================== LOG TAB ==================== -->
    <div id="log-panel" class="tab-panel" data-tab-panel="log">
      <div id="ai-stats-bar" style="display:none; margin-bottom:12px; padding:10px 14px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:8px;">
        <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
          <span style="font-size:13px; font-weight:600; color:var(--text-primary);">AI Stats</span>
          <span style="font-size:11px; color:var(--text-muted);">(ref. GPT-4o-mini)</span>
        </div>
        <div style="display:grid; grid-template-columns:repeat(6,1fr); gap:8px;">
          <div class="stat-box" style="padding:8px;">
            <div class="stat-label">Chamadas</div>
            <div class="stat-value" id="ai-st-calls" style="font-size:16px; color:var(--primary);">0</div>
          </div>
          <div class="stat-box" style="padding:8px;">
            <div class="stat-label">Tempo Medio</div>
            <div class="stat-value" id="ai-st-avg" style="font-size:16px; color:var(--warning);">0s</div>
          </div>
          <div class="stat-box" style="padding:8px;">
            <div class="stat-label">Tokens In</div>
            <div class="stat-value" id="ai-st-tkin" style="font-size:16px; color:var(--text-primary);">0</div>
          </div>
          <div class="stat-box" style="padding:8px;">
            <div class="stat-label">Tokens Out</div>
            <div class="stat-value" id="ai-st-tkout" style="font-size:16px; color:var(--text-primary);">0</div>
          </div>
          <div class="stat-box" style="padding:8px;">
            <div class="stat-label">Custo/Analise</div>
            <div class="stat-value" id="ai-st-cavg" style="font-size:16px; color:var(--success);">$0</div>
          </div>
          <div class="stat-box" style="padding:8px;">
            <div class="stat-label">Custo Total</div>
            <div class="stat-value" id="ai-st-ctotal" style="font-size:16px; color:var(--danger);">$0</div>
          </div>
        </div>
      </div>
      <div class="card-header" style="margin-bottom:10px;">
        <span class="card-title">&#x1F4CB; Registro de Atividades</span>
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <span class="log-tag binance" style="font-size:10px; padding:2px 6px; cursor:default;">BINANCE</span><span style="font-size:10px; color:var(--text-muted);">API</span>
            <span class="log-tag ia" style="font-size:10px; padding:2px 6px; cursor:default;">IA</span><span style="font-size:10px; color:var(--text-muted);">Decisao da IA</span>
            <span class="log-tag bot" style="font-size:10px; padding:2px 6px; cursor:default;">BOT</span><span style="font-size:10px; color:var(--text-muted);">Score tecnico</span>
            <span class="log-tag trade" style="font-size:10px; padding:2px 6px; cursor:default;">TRADE</span><span style="font-size:10px; color:var(--text-muted);">Compra/Venda</span>
            <span class="log-tag erro" style="font-size:10px; padding:2px 6px; cursor:default;">ERRO</span><span style="font-size:10px; color:var(--text-muted);">Falhas</span>
            <span class="log-tag system" style="font-size:10px; padding:2px 6px; cursor:default;">SISTEMA</span><span style="font-size:10px; color:var(--text-muted);">Geral</span>
          </div>
          <button class="btn btn-outline btn-sm" id="log-pause-btn" onclick="toggleLogPause()">&#x23F8; Pausar</button>
          <span id="log-pause-count" style="display:none; font-size:11px; color:var(--accent); font-weight:600;"></span>
          <button class="btn btn-outline btn-sm" onclick="clearLogs()">&#x1F5D1; Limpar</button>
        </div>
      </div>
      <div id="log-container"></div>
    </div>

    <!-- ==================== OPTIMIZER GA TAB ==================== -->
    <div id="optimizer-panel" class="tab-panel" data-tab-panel="optimizer">
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <span class="card-title">&#x1F9EC; Otimizador Genetico (GA)</span>
          <span id="ga-status" style="font-size:12px;color:var(--text-muted);">Pronto</span>
        </div>
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">
          Otimiza os parametros de trading usando algoritmo genetico sobre dados historicos.
          Faca um <strong>Scan</strong> primeiro para definir as moedas de teste.
          <br>Populacao: 100 individuos | 50 geracoes | Top 15 moedas do scanner | 500 candles cada
        </p>

        <div id="ga-progress-area" style="display:none;margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
            <span id="ga-progress-msg">Iniciando...</span>
            <span id="ga-progress-pct">0%</span>
          </div>
          <div class="ga-progress-bar">
            <div class="ga-progress-fill" id="ga-progress-fill"></div>
          </div>
        </div>

        <div style="display:flex;gap:10px;">
          <button class="btn btn-accent" id="btn-start-ga" onclick="doStartOptimize()">
            &#x25B6; Iniciar Otimizacao
          </button>
          <button class="btn btn-outline" id="btn-cancel-ga" style="display:none;" onclick="doCancelOptimize()">
            &#x23F9; Cancelar
          </button>
        </div>
      </div>

      <div class="card" id="ga-results-card" style="display:none;">
        <div class="card-header" style="margin-bottom:12px;">
          <span class="card-title">&#x1F3C6; Resultados do Backtest</span>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px;">
          <div class="stat-box">
            <div class="stat-label">Lucro Liquido</div>
            <div class="stat-value" id="ga-net-profit">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="ga-num-trades">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Max Drawdown</div>
            <div class="stat-value" id="ga-max-dd" style="color:var(--red);">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="ga-win-rate">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Fitness</div>
            <div class="stat-value" id="ga-fitness">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Moedas</div>
            <div class="stat-value" id="ga-symbols-used">--</div>
          </div>
        </div>

        <div class="card-header" style="margin-bottom:8px;">
          <span class="card-title" style="font-size:13px;">Parametros Otimizados</span>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 20px;margin-bottom:20px;">
          <div style="font-size:13px;font-weight:700;color:var(--accent);grid-column:1/-1;margin-bottom:4px;">Trading</div>
          <div class="ga-params-grid" style="grid-column:1/-1;">
            <div><b>Trailing Stop:</b> <span id="ga-param-sl">--</span>%</div>
            <div><b>Take Profit:</b> <span id="ga-param-tp">--</span>%</div>
            <div><b>Min Score:</b> <span id="ga-param-ms">--</span></div>
            <div><b>RSI Oversold:</b> <span id="ga-param-rsi-os">--</span></div>
            <div><b>RSI Overbought:</b> <span id="ga-param-rsi-ob">--</span></div>
          </div>
          <div style="font-size:13px;font-weight:700;color:var(--accent);grid-column:1/-1;margin:8px 0 4px;">Pesos dos Indicadores</div>
          <div class="ga-params-grid" style="grid-column:1/-1;">
            <div><b>RSI:</b> <span id="ga-param-wrsi">--</span></div>
            <div><b>MACD Hist:</b> <span id="ga-param-wmacdh">--</span></div>
            <div><b>MACD Signal:</b> <span id="ga-param-wmacds">--</span></div>
            <div><b>Preco/SMA:</b> <span id="ga-param-wpsma">--</span></div>
            <div><b>SMA Trend:</b> <span id="ga-param-wsmat">--</span></div>
            <div><b>Bollinger:</b> <span id="ga-param-wboll">--</span></div>
          </div>
        </div>

        <button class="btn btn-accent btn-lg" onclick="doApplyOptimizedParams()">
          &#x2705; Aplicar Parametros Otimizados
        </button>
        <p style="font-size:11px;color:var(--text-muted);margin-top:8px;">
          Aplica Trailing Stop, Take Profit e Min Score nas configuracoes do bot.
        </p>
      </div>
    </div>

    <!-- ==================== HELP/MANUAL TAB ==================== -->
    <div id="help-panel" class="tab-panel" data-tab-panel="help">
      <div class="help-container">

        <div style="margin-bottom:24px;">
          <h1 style="font-size:22px;font-weight:800;color:var(--accent);margin-bottom:6px;">&#x1F4D6; Manual do Binance Recovery Bot</h1>
          <p style="color:var(--text-muted);font-size:13px;">Guia completo de todas as funcionalidades, parametros e estrategias do sistema.</p>
        </div>

        <!-- ===== VISAO GERAL ===== -->
        <div class="help-section open">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F3AF; Visao Geral do Sistema
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>O <strong>Binance Recovery Bot</strong> e um robo de trading automatizado que identifica as <strong>N melhores moedas em recuperacao</strong> (configuravel) em um periodo configuravel (padrao 24h) no mercado da Binance, analisa indicadores tecnicos e utiliza Inteligencia Artificial para recomendar operacoes de compra e venda.</p>

            <div class="help-tip">&#x1F4A1; "Recuperacao" significa moedas que tiveram valorizacao positiva no periodo configurado, com volume significativo (acima de 1 milhao USDT), indicando que o mercado esta comprando ativamente.</div>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Entendendo os Pares de Trading:</p>
            <p>Os pares sao exibidos no formato <strong>BASE-QUOTE</strong> (ex: <strong>BTC-USDT</strong>):</p>
            <table class="help-table">
              <tr><th>Parte</th><th>Significado</th><th>Exemplo</th></tr>
              <tr><td><strong>BASE</strong> (esquerda)</td><td>O ativo que voce compra ou vende</td><td>BTC, ETH, MUBARAK</td></tr>
              <tr><td><strong>QUOTE</strong> (direita)</td><td>A moeda usada para pagar</td><td>USDT (dolar digital)</td></tr>
            </table>
            <p style="margin-top:8px;font-size:12px;color:var(--text-muted);">Quando o bot exibe "MUBARAK-USDT | Compra", significa que gastou <strong>USDT</strong> para comprar tokens <strong>MUBARAK</strong>. Na venda, voce vende MUBARAK e recebe USDT de volta.</p>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Fluxo de operacao:</p>
            <div class="help-flow">
              <span class="help-flow-step">&#x1F50D; Scan do Mercado</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x1F3C6; Top N Recovery</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x1F4CA; Indicadores Tecnicos</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x1F916; Analise IA</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x1F4B0; Trade</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x1F4F1; Alerta Telegram</span>
            </div>
            <div class="help-flow" style="margin-top:8px;">
              <span class="help-flow-step">&#x1F6D1; Trailing Stop</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x1F504; DCA (se preco cai)</span>
              <span class="help-flow-arrow">&#x2192;</span>
              <span class="help-flow-step">&#x23F1; Timeout Lateral</span>
            </div>

            <table class="help-table" style="margin-top:16px;">
              <tr><th>Funcionalidade</th><th>Descricao</th></tr>
              <tr><td><strong>Scanner</strong></td><td>Escaneia todos os pares USDT na Binance e seleciona os N melhores com maior variacao positiva no periodo configurado (quantidade e periodo configuraveis em Configuracoes)</td></tr>
              <tr><td><strong>Grafico Candlestick</strong></td><td>Exibe os ultimos 50 candles da moeda selecionada com Open, High, Low, Close e Volume</td></tr>
              <tr><td><strong>Indicadores Tecnicos</strong></td><td>RSI, MACD, SMA, EMA, Bollinger Bands, ATR - calculados automaticamente</td></tr>
              <tr><td><strong>Analise IA</strong></td><td>Envia indicadores para um LLM (GPT, Claude, DeepSeek) que retorna sinal, confianca e precos sugeridos</td></tr>
              <tr><td><strong>Trading Manual</strong></td><td>Compra e venda a mercado com confirmacao</td></tr>
              <tr><td><strong>Bot Automatico</strong></td><td>Escaneia, analisa e executa trades automaticamente em intervalos configuraveis</td></tr>
              <tr><td><strong>Trailing Stop</strong></td><td>Stop loss dinamico que acompanha o preco maximo, vendendo ao cair X% do pico</td></tr>
              <tr><td><strong>DCA</strong></td><td>Dollar Cost Averaging: compra mais em degraus de queda (-3%, -5%, -8%) para baixar o preco medio</td></tr>
              <tr><td><strong>Telegram</strong></td><td>Notificacoes em tempo real no celular via Telegram (compras, vendas, oportunidades)</td></tr>
            </table>
          </div>
        </div>

        <!-- ===== ABA SCANNER ===== -->
        <div class="help-section open">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F50D; Aba Scanner
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>A aba Scanner e a tela principal. Ela se divide em duas areas:</p>

            <p style="margin-top:12px;font-weight:600;">&#x1F4CB; Painel Esquerdo &mdash; Tabela Top N</p>
            <p>Mostra as N melhores moedas com maior recuperacao (variacao positiva) nas ultimas 24 horas. O valor de N e configuravel na aba Configuracoes (padrao: 30).</p>

            <table class="help-table">
              <tr><th>Coluna</th><th>Significado</th></tr>
              <tr><td><strong>#</strong></td><td>Ranking de recuperacao (1 = maior alta)</td></tr>
              <tr><td><strong>Moeda</strong></td><td>Par de trading (ex: BTCUSDT, ETHUSDT)</td></tr>
              <tr><td><strong>Preco</strong></td><td>Ultimo preco negociado</td></tr>
              <tr><td><strong>Variacao 24h</strong></td><td>Variacao percentual do preco nas ultimas 24 horas. Valores verdes indicam alta</td></tr>
              <tr><td><strong>Volume</strong></td><td>Volume de negociacao em USDT nas ultimas 24h. Filtro minimo: 1M USDT</td></tr>
              <tr><td><strong>Acao</strong></td><td>Botao para selecionar a moeda e carregar seus dados no painel direito</td></tr>
            </table>

            <div class="help-param">
              <div class="help-param-name">&#x1F504; Botao "Scan Now"</div>
              <div class="help-param-desc">Forca um scan imediato do mercado. O scan automatico ocorre a cada <strong>60 segundos</strong>. O scan consulta a API da Binance com o periodo de recuperacao configurado (padrao 24h), filtra pares USDT com volume significativo, remove os que estao em queda, e ordena por variacao decrescente. Para periodos diferentes de 24h, o sistema faz consultas em lote usando a API <strong>/v3/ticker</strong> com janela customizada.</div>
            </div>

            <p style="margin-top:16px;font-weight:600;">&#x1F4C8; Painel Direito &mdash; Detalhes da Moeda</p>
            <p>Ao clicar em uma moeda na tabela, o painel direito carrega:</p>

            <div class="help-param">
              <div class="help-param-name">&#x1F5BC; Grafico Candlestick</div>
              <div class="help-param-desc">
                Exibe os ultimos <strong>50 candles</strong> da moeda no intervalo configurado (padrao: 1h).
                Cada candle mostra: <strong>Abertura (Open)</strong>, <strong>Maxima (High)</strong>, <strong>Minima (Low)</strong>, <strong>Fechamento (Close)</strong>.
                <br>&#x2022; Candles <strong style="color:var(--green);">verdes</strong>: preco subiu (Close &gt; Open)
                <br>&#x2022; Candles <strong style="color:var(--red);">vermelhos</strong>: preco caiu (Close &lt; Open)
                <br>&#x2022; A <strong>sombra/pavio</strong> (linha fina) mostra a maxima e minima do periodo
                <br>&#x2022; Passe o mouse sobre o grafico para ver detalhes do candle
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">&#x1F4CA; Indicadores Tecnicos</div>
              <div class="help-param-desc">Calculados automaticamente a partir dos candles carregados. Veja a secao "Indicadores Tecnicos" abaixo para detalhes de cada um.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">&#x1F916; Sinal da IA</div>
              <div class="help-param-desc">
                Apos clicar em <strong>"Analisar com IA"</strong>, o sistema envia os indicadores e ultimos candles para o modelo de IA configurado.
                A IA retorna: <strong>Sinal</strong> (COMPRA FORTE / COMPRA / MANTER / VENDA / VENDA FORTE), <strong>Confianca</strong> (0-100%), <strong>Reasoning</strong> (explicacao), e precos sugeridos de <strong>Entrada</strong>, <strong>Stop Loss</strong> e <strong>Take Profit</strong>.
                <br><br>Se nenhuma IA estiver configurada, o sistema usa o <strong>Score Tecnico</strong> (baseado apenas nos indicadores) como fallback.
              </div>
            </div>
          </div>
        </div>

        <!-- ===== INDICADORES TECNICOS ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4CA; Indicadores Tecnicos (Detalhado)
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>Todos os indicadores sao calculados localmente a partir dos dados de candles da Binance.</p>

            <div class="help-param">
              <div class="help-param-name">RSI (Relative Strength Index) &mdash; Periodo: 14</div>
              <div class="help-param-desc">
                Mede a forca relativa dos movimentos de alta vs baixa. Oscila de 0 a 100.
                <br>&#x2022; <strong style="color:var(--green);">RSI &lt; 30</strong>: Sobrevendido &mdash; possivel oportunidade de <strong>compra</strong>
                <br>&#x2022; <strong style="color:var(--red);">RSI &gt; 70</strong>: Sobrecomprado &mdash; possivel oportunidade de <strong>venda</strong>
                <br>&#x2022; RSI entre 30-70: Zona neutra
                <br><br><strong>Score:</strong> RSI &lt; 30 = +30pts | RSI &lt; 45 = +10pts | RSI &gt; 70 = -30pts | RSI &gt; 55 = -10pts
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">MACD (Moving Average Convergence Divergence)</div>
              <div class="help-param-desc">
                Calculado com EMA de 12 e 26 periodos. A linha de sinal usa EMA de 9 periodos.
                <br>&#x2022; <strong>MACD</strong>: Diferenca entre EMA(12) e EMA(26)
                <br>&#x2022; <strong>Signal</strong>: EMA(9) do MACD
                <br>&#x2022; <strong>Histograma</strong>: MACD - Signal
                <br><br>&#x2022; <strong style="color:var(--green);">Histograma &gt; 0</strong>: Tendencia de <strong>alta</strong> (+15pts)
                <br>&#x2022; <strong style="color:var(--red);">Histograma &lt; 0</strong>: Tendencia de <strong>baixa</strong> (-15pts)
                <br>&#x2022; MACD cruza acima do Signal: Sinal de <strong>compra</strong> (+10pts)
                <br>&#x2022; MACD cruza abaixo do Signal: Sinal de <strong>venda</strong> (-10pts)
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">SMA 20 e SMA 50 (Simple Moving Average)</div>
              <div class="help-param-desc">
                Medias moveis simples dos ultimos 20 e 50 periodos de fechamento.
                <br>&#x2022; <strong style="color:var(--green);">Preco &gt; SMA20</strong>: Tendencia de curto prazo em alta (+10pts)
                <br>&#x2022; <strong style="color:var(--green);">SMA20 &gt; SMA50</strong>: "Golden Cross" &mdash; tendencia de medio prazo em alta (+15pts)
                <br>&#x2022; <strong style="color:var(--red);">SMA20 &lt; SMA50</strong>: "Death Cross" &mdash; tendencia de medio prazo em baixa (-15pts)
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">EMA 12 e EMA 26 (Exponential Moving Average)</div>
              <div class="help-param-desc">
                Medias moveis exponenciais que dao mais peso aos precos recentes. A EMA de 12 periodos reage mais rapido que a de 26.
                Usadas internamente no calculo do MACD.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Bollinger Bands (Bandas de Bollinger) &mdash; Periodo: 20, Desvio: 2</div>
              <div class="help-param-desc">
                Tres linhas baseadas na SMA(20) e desvio padrao:
                <br>&#x2022; <strong>Upper</strong>: SMA20 + 2 x DesvPad
                <br>&#x2022; <strong>Middle</strong>: SMA20
                <br>&#x2022; <strong>Lower</strong>: SMA20 - 2 x DesvPad
                <br><br>&#x2022; <strong style="color:var(--green);">Preco &le; Lower</strong>: Ativo pode estar sobrevendido, possivel "bounce" (+20pts)
                <br>&#x2022; <strong style="color:var(--red);">Preco &ge; Upper</strong>: Ativo pode estar sobrecomprado (-20pts)
                <br>&#x2022; Bandas se estreitando = volatilidade baixa (possivel rompimento iminente)
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">ATR (Average True Range) &mdash; Periodo: 14</div>
              <div class="help-param-desc">
                Mede a volatilidade media do ativo. Quanto maior o ATR, mais volatil o ativo.
                <br>&#x2022; Util para definir <strong>Stop Loss</strong>: tipicamente 1.5x a 2x ATR abaixo do preco de entrada
                <br>&#x2022; Nao indica direcao, apenas a magnitude dos movimentos de preco
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">&#x1F4AF; Score Tecnico (Tech Score)</div>
              <div class="help-param-desc">
                Pontuacao composta de -100 a +100 calculada somando os pontos de cada indicador:
                <br><br>
                <table class="help-table">
                  <tr><th>Indicador</th><th>Condicao</th><th>Pontos</th></tr>
                  <tr><td>RSI &lt; 30</td><td>Sobrevendido</td><td style="color:var(--green);">+30</td></tr>
                  <tr><td>RSI &lt; 45</td><td>Tendencia de compra</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>RSI &gt; 70</td><td>Sobrecomprado</td><td style="color:var(--red);">-30</td></tr>
                  <tr><td>RSI &gt; 55</td><td>Tendencia de venda</td><td style="color:var(--red);">-10</td></tr>
                  <tr><td>Histograma &gt; 0</td><td>MACD positivo</td><td style="color:var(--green);">+15</td></tr>
                  <tr><td>Histograma &lt; 0</td><td>MACD negativo</td><td style="color:var(--red);">-15</td></tr>
                  <tr><td>MACD &gt; Signal</td><td>Cruzamento alta</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>MACD &lt; Signal</td><td>Cruzamento baixa</td><td style="color:var(--red);">-10</td></tr>
                  <tr><td>Preco &gt; SMA20</td><td>Acima da media</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>SMA20 &gt; SMA50</td><td>Golden Cross</td><td style="color:var(--green);">+15</td></tr>
                  <tr><td>SMA20 &lt; SMA50</td><td>Death Cross</td><td style="color:var(--red);">-15</td></tr>
                  <tr><td>Preco &le; Boll Lower</td><td>Bounce possivel</td><td style="color:var(--green);">+20</td></tr>
                  <tr><td>Preco &ge; Boll Upper</td><td>Topo possivel</td><td style="color:var(--red);">-20</td></tr>
                </table>
                <br>&#x2022; Score &gt; +60: <strong>COMPRA FORTE</strong> | &gt; +40: <strong>COMPRA</strong>
                <br>&#x2022; Score &lt; -60: <strong>VENDA FORTE</strong> | &lt; -40: <strong>VENDA</strong>
                <br>&#x2022; Entre -40 e +40: <strong>MANTER</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== EXEMPLOS PRATICOS ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4D6; Exemplos Praticos: Por que Comprar ou Vender?
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>Abaixo estao cenarios reais que explicam a logica por tras de cada decisao do bot.</p>

            <!-- EXEMPLO 1: COMPRA FORTE -->
            <div class="help-param" style="border-left:3px solid var(--green);padding-left:16px;margin-top:16px;">
              <div class="help-param-name" style="color:var(--green);font-size:15px;">&#x2705; Exemplo 1: COMPRA FORTE (Score +70)</div>
              <div class="help-param-desc">
                <strong>Cenario:</strong> BTCUSDT caiu 15% nos ultimos 3 dias, mas comecou a se recuperar nas ultimas horas.
                <br><br>
                <table class="help-table">
                  <tr><th>Indicador</th><th>Valor</th><th>Interpretacao</th><th>Pts</th></tr>
                  <tr><td>RSI</td><td style="color:var(--green);">24.5</td><td>Muito sobrevendido &mdash; o mercado vendeu demais, provavel correcao para cima</td><td style="color:var(--green);">+30</td></tr>
                  <tr><td>MACD Hist</td><td style="color:var(--green);">+0.5</td><td>Histograma virou positivo &mdash; forca compradora crescendo</td><td style="color:var(--green);">+15</td></tr>
                  <tr><td>MACD vs Signal</td><td style="color:var(--green);">Acima</td><td>MACD cruzou acima do Signal &mdash; "cruzamento de alta"</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>Preco vs SMA20</td><td style="color:var(--red);">Abaixo</td><td>Preco ainda abaixo da media &mdash; esperado apos queda forte</td><td style="color:var(--red);">-10</td></tr>
                  <tr><td>SMA20 vs SMA50</td><td style="color:var(--red);">Abaixo</td><td>Media curta abaixo da longa &mdash; tendencia macro ainda de baixa</td><td style="color:var(--red);">-15</td></tr>
                  <tr><td>Bollinger</td><td style="color:var(--green);">Na banda inferior</td><td>Preco tocou Bollinger inferior &mdash; forte indicacao de "bounce" (rebote)</td><td style="color:var(--green);">+20</td></tr>
                </table>
                <br>
                <strong>Total: +50 pontos</strong> &rarr; Sinal: <strong style="color:var(--green);">COMPRA</strong>
                <br><br>
                <div class="help-tip">
                  <strong>&#x1F4A1; Por que comprar quando tudo parece ruim?</strong><br>
                  RSI sobrevendido (&lt;30) significa que o ativo caiu muito rapido. Historicamente, esses niveis extremos tendem a reverter.
                  Quando o MACD vira positivo ao mesmo tempo, confirma que os compradores estao voltando. O toque na Bollinger inferior
                  reforca: o preco esta estatisticamente "barato" em relacao a media recente. E um ponto de alta probabilidade de bounce.
                </div>
              </div>
            </div>

            <!-- EXEMPLO 2: VENDA FORTE -->
            <div class="help-param" style="border-left:3px solid var(--red);padding-left:16px;margin-top:20px;">
              <div class="help-param-name" style="color:var(--red);font-size:15px;">&#x1F534; Exemplo 2: VENDA FORTE (Score -65)</div>
              <div class="help-param-desc">
                <strong>Cenario:</strong> OMUSDT subiu 45% em 24h. O bot detecta esse cenario:
                <br><br>
                <table class="help-table">
                  <tr><th>Indicador</th><th>Valor</th><th>Interpretacao</th><th>Pts</th></tr>
                  <tr><td>RSI</td><td style="color:var(--red);">82.3</td><td>Muito sobrecomprado &mdash; subiu rapido demais, provavel correcao para baixo</td><td style="color:var(--red);">-30</td></tr>
                  <tr><td>MACD Hist</td><td style="color:var(--green);">+2.1</td><td>Ainda positivo (forca residual do pump)</td><td style="color:var(--green);">+15</td></tr>
                  <tr><td>MACD vs Signal</td><td style="color:var(--green);">Acima</td><td>MACD ainda acima do signal</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>Preco vs SMA20</td><td style="color:var(--green);">Acima</td><td>Preco muito acima da media</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>SMA20 vs SMA50</td><td style="color:var(--red);">Abaixo</td><td>Pump recente; SMA20 nao alcancou a SMA50 ainda</td><td style="color:var(--red);">-15</td></tr>
                  <tr><td>Bollinger</td><td style="color:var(--red);">Na banda superior</td><td>Preco tocou/ultrapassou Bollinger superior &mdash; estatisticamente "caro"</td><td style="color:var(--red);">-20</td></tr>
                </table>
                <br>
                <strong>Total: -30 pontos</strong> &rarr; Neste caso seria <strong>HOLD</strong> (entre -40 e +40).
                <br>Mas se SMA20&lt;SMA50 e MACD comecar a cair, o score piora para <strong style="color:var(--red);">-50 a -65</strong> &rarr; VENDA FORTE.
                <br><br>
                <div class="help-warning">
                  <strong>&#x26A0;&#xFE0F; Por que vender uma moeda que subiu muito?</strong><br>
                  Subidas de 40-50% em um dia sao frequentemente seguidas de correcoes de 15-30%.
                  RSI acima de 80 indica que quase todos os movimentos recentes foram de alta &mdash; nao ha mais compradores faceis.
                  O preco na Bollinger superior significa que esta 2 desvios acima da media. Estatisticamente, tende a voltar para a media.
                  O bot vende para <strong>proteger o lucro</strong> antes que a correcao aconteca.
                </div>
              </div>
            </div>

            <!-- EXEMPLO 3: HOLD -->
            <div class="help-param" style="border-left:3px solid var(--text-muted);padding-left:16px;margin-top:20px;">
              <div class="help-param-name" style="color:var(--accent);font-size:15px;">&#x23F8;&#xFE0F; Exemplo 3: HOLD / MANTER (Score -15)</div>
              <div class="help-param-desc">
                <strong>Cenario:</strong> ETHUSDT em consolidacao lateral, sem tendencia clara.
                <br><br>
                <table class="help-table">
                  <tr><th>Indicador</th><th>Valor</th><th>Interpretacao</th><th>Pts</th></tr>
                  <tr><td>RSI</td><td>48.2</td><td>Neutro &mdash; sem sobrecompra nem sobrevenda</td><td>0</td></tr>
                  <tr><td>MACD Hist</td><td style="color:var(--red);">-0.3</td><td>Levemente negativo</td><td style="color:var(--red);">-15</td></tr>
                  <tr><td>MACD vs Signal</td><td style="color:var(--red);">Abaixo</td><td>Leve pressao vendedora</td><td style="color:var(--red);">-10</td></tr>
                  <tr><td>Preco vs SMA20</td><td style="color:var(--green);">Acima</td><td>Preco proximo a media, levemente acima</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>SMA20 vs SMA50</td><td style="color:var(--green);">Acima</td><td>Tendencia de medio prazo em alta</td><td style="color:var(--green);">+15</td></tr>
                  <tr><td>Bollinger</td><td>Entre bandas</td><td>Preco no meio &mdash; sem extremos</td><td>0</td></tr>
                </table>
                <br>
                <strong>Total: 0 pontos</strong> &rarr; Sinal: <strong style="color:var(--accent);">HOLD</strong>
                <br><br>
                <div class="help-tip">
                  <strong>&#x1F4A1; Quando o bot nao faz nada?</strong><br>
                  Scores entre -40 e +40 indicam que nao ha consenso claro entre os indicadores.
                  Operar nessa zona tem alta probabilidade de ser "50/50" &mdash; o bot prefere <strong>preservar capital</strong>
                  e esperar um sinal mais forte. Paciencia e uma das melhores estrategias de trading.
                </div>
              </div>
            </div>

            <!-- EXEMPLO 4: COMPRA em recuperacao -->
            <div class="help-param" style="border-left:3px solid #00bcd4;padding-left:16px;margin-top:20px;">
              <div class="help-param-name" style="color:#00bcd4;font-size:15px;">&#x1F4C8; Exemplo 4: Moeda em Recuperacao (O Cenario Ideal)</div>
              <div class="help-param-desc">
                <strong>Cenario:</strong> SOLUSDT caiu 25% em 3 dias, mas nas ultimas 6h subiu 8%. O scanner detectou como "moeda em recuperacao".
                <br><br>
                <table class="help-table">
                  <tr><th>Indicador</th><th>Valor</th><th>Interpretacao</th><th>Pts</th></tr>
                  <tr><td>RSI</td><td style="color:var(--green);">35.4</td><td>Proximo de sobrevendido &mdash; ainda tem espaco para subir</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>MACD Hist</td><td style="color:var(--green);">+0.8</td><td>Histograma acabou de virar positivo &mdash; momentum de alta</td><td style="color:var(--green);">+15</td></tr>
                  <tr><td>MACD vs Signal</td><td style="color:var(--green);">Acima</td><td>Cruzamento de alta confirmado</td><td style="color:var(--green);">+10</td></tr>
                  <tr><td>Preco vs SMA20</td><td style="color:var(--red);">Abaixo</td><td>Ainda abaixo, mas se aproximando (sinal de que vai cruzar)</td><td style="color:var(--red);">-10</td></tr>
                  <tr><td>SMA20 vs SMA50</td><td style="color:var(--red);">Abaixo</td><td>Tendencia macro ainda bearish</td><td style="color:var(--red);">-15</td></tr>
                  <tr><td>Bollinger</td><td style="color:var(--green);">Proximo ao Lower</td><td>Preco na regiao inferior &mdash; possivel bounce</td><td style="color:var(--green);">+20</td></tr>
                </table>
                <br>
                <strong>Total: +30 pontos</strong> &rarr; Sinal: <strong style="color:var(--accent);">HOLD</strong> (proximo de COMPRA)
                <br>Se o RSI cair para &lt;30, o score sobe para <strong style="color:var(--green);">+50 &rarr; COMPRA</strong>.
                <br><br>
                <div class="help-tip">
                  <strong>&#x1F4A1; Este e o cenario que o bot procura!</strong><br>
                  O Scanner busca moedas com <strong>variacao positiva no periodo configurado</strong> (padrao 24h, ajustavel em Configuracoes). A ideia e:
                  <br>1. A moeda caiu bastante (periodo anterior)
                  <br>2. Comecou a se recuperar (variacao +% no periodo selecionado)
                  <br>3. Os indicadores confirmam que a reversao esta acontecendo (RSI baixo + MACD cruzando + Bollinger inferior)
                  <br>4. O bot compra na confirmacao e o trailing stop protege a posicao
                  <br><br>
                  A <strong>estrategia ideal</strong> e: comprar quando os indicadores confirmam a reversao (nao antes), e vender quando RSI fica sobrecomprado (&gt;70).
                </div>
              </div>
            </div>

            <!-- RESUMO VISUAL -->
            <div style="margin-top:24px;padding:16px;background:var(--bg-card);border-radius:8px;border:1px solid var(--border);">
              <div style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:12px;">&#x1F3AF; Resumo: Quando o Bot Age</div>
              <table class="help-table" style="width:100%;">
                <tr>
                  <th>Score</th>
                  <th>Sinal</th>
                  <th>Acao do Bot</th>
                  <th>Logica</th>
                </tr>
                <tr>
                  <td style="color:var(--green);font-weight:700;">&gt; +60</td>
                  <td style="color:var(--green);">COMPRA FORTE</td>
                  <td>Compra automatica</td>
                  <td>Multiplos indicadores confirmam alta &mdash; confianca elevada</td>
                </tr>
                <tr>
                  <td style="color:var(--green);">+40 a +60</td>
                  <td style="color:var(--green);">COMPRA</td>
                  <td>Compra automatica</td>
                  <td>Maioria dos indicadores aponta para alta</td>
                </tr>
                <tr>
                  <td>-40 a +40</td>
                  <td style="color:var(--accent);">HOLD</td>
                  <td>Nao faz nada</td>
                  <td>Sinais mistos &mdash; melhor esperar clareza</td>
                </tr>
                <tr>
                  <td style="color:var(--red);">-60 a -40</td>
                  <td style="color:var(--red);">VENDA</td>
                  <td>Venda automatica</td>
                  <td>Maioria dos indicadores aponta para baixa</td>
                </tr>
                <tr>
                  <td style="color:var(--red);font-weight:700;">&lt; -60</td>
                  <td style="color:var(--red);">VENDA FORTE</td>
                  <td>Venda automatica</td>
                  <td>Multiplos indicadores confirmam queda &mdash; proteger capital</td>
                </tr>
              </table>
              <br>
              <div style="font-size:12px;color:var(--text-muted);">
                &#x26A0;&#xFE0F; O Auto-Trade so executa se: (1) Bot estiver rodando, (2) Auto-Trade habilitado,
                (3) Confianca &ge; minima configurada, e (4) O sinal for <strong>diferente</strong> do ultimo trade executado (protecao contra trades repetidos).
              </div>
            </div>

          </div>
        </div>

        <!-- ===== ABA TRADING ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4B9; Aba Trading
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>A aba Trading permite executar operacoes manuais e controlar o bot automatico.</p>

            <div class="help-param">
              <div class="help-param-name">&#x1F4B5; Valor por Trade (USDT)</div>
              <div class="help-param-desc">
                Valor em USDT que sera usado em cada operacao. O sistema calcula automaticamente a quantidade do ativo dividindo o valor pelo preco atual.
                <br><strong>Exemplo:</strong> Trade de 100 USDT com BTC a $50.000 = compra de 0.00200000 BTC
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name" style="color:var(--green);">&#x25B2; Botao COMPRAR</div>
              <div class="help-param-desc">
                Executa uma ordem de <strong>compra a mercado (MARKET)</strong> da moeda selecionada.
                <br>&#x2022; Pede confirmacao antes de executar
                <br>&#x2022; Requer moeda selecionada e preco valido
                <br>&#x2022; A quantidade e calculada automaticamente: <strong>Valor USDT / Preco atual</strong>
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name" style="color:var(--red);">&#x25BC; Botao VENDER</div>
              <div class="help-param-desc">
                Executa uma ordem de <strong>venda a mercado (MARKET)</strong> da moeda selecionada.
                <br>&#x2022; Pede confirmacao antes de executar
                <br>&#x2022; Voce precisa ter saldo suficiente do ativo na sua conta Binance
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name" style="color:var(--blue);">&#x1F916; Bot Automatico</div>
              <div class="help-param-desc">
                O bot opera no seguinte ciclo automatico (a cada intervalo configurado):
                <br><br><strong>1.</strong> Verifica <strong>Trailing Stop</strong> em todas as posicoes abertas (urgente)
                <br><strong>2.</strong> Verifica <strong>DCA</strong> &mdash; compra mais se preco caiu nos degraus configurados
                <br><strong>3.</strong> Verifica <strong>Timeout Lateral</strong> &mdash; vende se posicao esta parada ha muito tempo
                <br><strong>4.</strong> Escaneia o mercado (top N moedas)
                <br><strong>5.</strong> Analisa TODAS as top coins: indicadores tecnicos + IA
                <br><strong>6.</strong> Se o sinal for COMPRA/VENDA e confianca &ge; minimo:
                <br>&nbsp;&nbsp;&nbsp;&nbsp;&#x2192; Executa a ordem automaticamente (se Auto-Trade estiver ativo)
                <br><strong>7.</strong> Envia <strong>notificacao Telegram</strong> (se configurado)
                <br><strong>8.</strong> Aguarda o intervalo configurado e repete
              </div>
            </div>

            <div class="help-warning">&#x26A0; <strong>ATENCAO:</strong> O bot so executa trades automaticamente se o <strong>Auto-Trade</strong> estiver habilitado nas Configuracoes. Caso contrario, ele apenas analisa e exibe sinais. Use a <strong>Testnet</strong> para testar antes de operar com dinheiro real!</div>

            <div class="help-param">
              <div class="help-param-name">&#x1F4B0; Saldo</div>
              <div class="help-param-desc">
                Mostra o saldo da sua conta para o ativo base (ex: BTC) e o ativo cotado (ex: USDT), incluindo valores <strong>livres</strong> e <strong>bloqueados</strong> em ordens abertas.
                <br>Atualizado automaticamente apos cada trade e ao testar a conexao.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">&#x1F4C3; Historico de Trades</div>
              <div class="help-param-desc">
                Tabela com todas as ordens executadas, mostrando: data/hora, par (formato BASE-QUOTE), lado (compra/venda), preco, quantidade, sinal da IA que gerou o trade e confianca. Os trades sao <strong>persistidos em banco de dados SQLite</strong> e sobrevivem ao reiniciar o programa. Cada modo (Testnet/Producao) tem seu proprio banco de dados independente.
              </div>
            </div>
          </div>
        </div>

        <!-- ===== CONFIGURACOES ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x2699;&#xFE0F; Configuracoes (Todos os Parametros)
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">

            <p style="font-weight:600;color:var(--accent);font-size:14px;margin-bottom:10px;">&#x1F511; Binance API</p>

            <div class="help-param">
              <div class="help-param-name">Modo de Operacao (Testnet / Producao)</div>
              <div class="help-param-desc">
                O sistema suporta <strong>dois conjuntos de chaves API</strong> independentes:
                <br>&#x2022; <strong>Testnet (padrao):</strong> Usa a rede de teste (<strong>testnet.binance.vision</strong>). Trades sao simulados, sem dinheiro real. Gere suas chaves em <strong>testnet.binance.vision</strong>.
                <br>&#x2022; <strong>Producao:</strong> Usa a rede real (<strong>api.binance.com</strong>). Trades sao executados com dinheiro REAL.
                <br><br>Cada modo tem seu proprio <strong>banco de dados SQLite separado</strong> (trades, posicoes e snapshots nao se misturam entre os modos). Ao alternar o modo, os dados do modo selecionado sao carregados automaticamente.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">API Key e Secret Key <span class="badge required">Obrigatorio</span></div>
              <div class="help-param-desc">
                Cada modo (Testnet e Producao) tem seus proprios campos de API Key e Secret Key.
                <br>&#x2022; <strong>API Key:</strong> Chave publica da sua conta. <strong>Como obter:</strong> Binance &gt; Configuracoes &gt; Gerenciamento de API &gt; Criar API
                <br>&#x2022; <strong>Secret Key:</strong> Chave secreta que assina requisicoes. <strong>Nunca compartilhe.</strong> Mostrada apenas uma vez ao criar.
                <br>&#x2022; <strong>Permissoes necessarias:</strong> Leitura + Spot Trading
                <br><br><strong>Importante:</strong> As chaves da Testnet e da Producao sao diferentes! Chaves da Testnet nao funcionam na Producao e vice-versa.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">&#x1F50C; Testar Conexao</div>
              <div class="help-param-desc">
                Testa a conexao de rede (ping) e valida a API Key (consulta autenticada em /v3/account). Mostra resultado no indicador superior:
                <br>&#x2022; <strong style="color:var(--green);">Conectado:</strong> Rede OK e API Key validada com sucesso
                <br>&#x2022; <strong style="color:var(--red);">API Key Invalida:</strong> Conexao OK mas a chave foi rejeitada
                <br>&#x2022; <strong style="color:var(--red);">Desconectado:</strong> Falha na conexao de rede
              </div>
            </div>

            <p style="font-weight:600;color:var(--accent);font-size:14px;margin:20px 0 10px;">&#x1F9E0; IA / LLM</p>

            <div class="help-param">
              <div class="help-param-name">API Key IA <span class="badge optional">Opcional</span></div>
              <div class="help-param-desc">
                Chave de API do provedor de IA escolhido (OpenAI, Anthropic, DeepSeek, etc).
                <br>Se nao fornecida, o sistema usa o <strong>Score Tecnico</strong> como fallback para gerar sinais automaticamente.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Modelo</div>
              <div class="help-param-desc">
                Modelo de IA a ser usado para analise. Opcoes disponiveis:
                <table class="help-table">
                  <tr><th>Modelo</th><th>Provedor</th><th>Caracteristica</th></tr>
                  <tr><td>GPT-4o &#x1F441;</td><td>OpenAI</td><td>Mais inteligente, visao + texto, mais caro</td></tr>
                  <tr><td>GPT-4o Mini &#x1F441;</td><td>OpenAI</td><td>Equilibrio custo/qualidade, visao (padrao)</td></tr>
                  <tr><td>GPT-4 Turbo</td><td>OpenAI</td><td>Alta performance, texto</td></tr>
                  <tr><td>GPT-3.5 Turbo</td><td>OpenAI</td><td>Mais barato, menor qualidade</td></tr>
                  <tr><td>Claude Sonnet</td><td>Anthropic</td><td>Analise detalhada</td></tr>
                  <tr><td>Claude Haiku</td><td>Anthropic</td><td>Rapido e barato</td></tr>
                  <tr><td>DeepSeek Chat</td><td>DeepSeek</td><td>Alternativa economica</td></tr>
                  <tr><td><strong>Qwen3-VL-8B &#x1F441;</strong></td><td>LM Studio</td><td><strong>Local, gratuito, visao + texto</strong></td></tr>
                  <tr><td>Qwen3-8B</td><td>LM Studio</td><td>Local, gratuito, texto</td></tr>
                  <tr><td>Custom</td><td>Qualquer</td><td>Modelo personalizado (preencha a Base URL)</td></tr>
                </table>
                <div class="help-tip" style="margin-top:8px;">&#x1F441; = Modelo com <strong>Visao (Vision)</strong>: recebe um grafico de candles gerado automaticamente (800x450px com candles, SMA20, SMA50 e volume) para analise visual de padroes como tendencias, suportes, resistencias, doji, martelo, engolfo, etc.</div>
                <div class="help-tip" style="margin-top:6px;">&#x1F4BB; <strong>LM Studio (Qwen3-VL-8B):</strong> Modelo 100% local e gratuito. Instale o <a href="https://lmstudio.ai" target="_blank" style="color:var(--accent);">LM Studio</a>, baixe o modelo <code>qwen3-vl-8b</code>, inicie o servidor local e use o preset "LM Studio" na configuracao. Requer ~8GB de VRAM (GPU).</div>
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Base URL <span class="badge optional">Opcional</span></div>
              <div class="help-param-desc">
                URL base do endpoint da API. Padrao: <strong>https://api.openai.com/v1</strong>
                <br>Altere para usar provedores alternativos compativeis com a API OpenAI:
                <br>&#x2022; Anthropic (via proxy): configure o proxy URL
                <br>&#x2022; DeepSeek: <strong>https://api.deepseek.com/v1</strong>
                <br>&#x2022; <strong>LM Studio: http://localhost:1234/v1</strong> (API Key: qualquer valor)
                <br>&#x2022; Ollama local: <strong>http://localhost:11434/v1</strong> (API Key: qualquer valor)
                <br><br>Use os botoes de <strong>Preset Rapido</strong> para configurar automaticamente.
              </div>
            </div>

            <p style="font-weight:600;color:var(--accent);font-size:14px;margin:20px 0 10px;">&#x1F4C9; Parametros de Trading</p>

            <div class="help-param">
              <div class="help-param-name">Valor por Trade (USDT)</div>
              <div class="help-param-desc">
                Quantidade em USDT usada em cada operacao de compra ou venda.
                <br><strong>Padrao:</strong> 100 USDT
                <br><strong>Minimo recomendado:</strong> 10 USDT (limite minimo da maioria dos pares na Binance)
                <br>Valores menores reduzem risco mas tambem o lucro potencial.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Trailing Stop (%) <span class="badge danger">Risco</span></div>
              <div class="help-param-desc">
                Percentual de queda a partir do preco maximo atingido (pico) que aciona a venda automatica. Diferente do stop fixo, o trailing stop "sobe" junto com o preco.
                <br><strong>Padrao:</strong> 3%
                <br><strong>Calculo:</strong> Vende quando: (Pico - Atual) / Pico >= TrailingStop%
                <br><strong>Exemplo:</strong> Compra em $100, preco sobe ate $120 (pico), trailing 3% = vende se cair para $116.40
                <br><br>&#x2022; Valores menores (1-2%): Protege lucro rapido, mas pode sair cedo
                <br>&#x2022; Valores maiores (3-5%): Mais espaco para respirar, captura movimentos maiores
                <br><br><strong>Vantagem:</strong> Se o preco subir 10% e depois cair, voce protege a maior parte do lucro em vez de esperar voltar ao preco de compra.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Take Profit (%)</div>
              <div class="help-param-desc">
                Percentual de lucro alvo para sugerir saida da posicao.
                <br><strong>Padrao:</strong> 4%
                <br><strong>Calculo:</strong> Preco de entrada x (1 + TakeProfit/100)
                <br><strong>Exemplo:</strong> Entrada em $100 com TP 4% = Take Profit em $104
                <br><br><strong>Regra de ouro:</strong> Mantenha uma relacao <strong>Risco:Retorno de pelo menos 1:2</strong>.
                <br>Se seu Trailing Stop e 2%, o Take Profit deve ser pelo menos 4%.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Confianca Minima (%)</div>
              <div class="help-param-desc">
                Nivel minimo de confianca exigido da IA para o bot executar um trade automatico.
                <br><strong>Padrao:</strong> 70%
                <br>&#x2022; <strong>50-60%:</strong> Agressivo &mdash; mais trades, mas mais sinais falsos
                <br>&#x2022; <strong>70-80%:</strong> Moderado &mdash; equilibrio (recomendado)
                <br>&#x2022; <strong>85-100%:</strong> Conservador &mdash; poucos trades, apenas sinais muito fortes
                <br><br>Se a IA retornar confianca abaixo deste valor, o bot registra no log mas <strong>nao executa</strong> o trade.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Score Minimo (pre-filtro IA)</div>
              <div class="help-param-desc">
                Score tecnico minimo para enviar uma moeda para analise pela IA. Moedas com score abaixo deste valor sao puladas (economia de tokens).
                O score e calculado localmente a partir dos indicadores (RSI, MACD, SMA, Bollinger) e vai de 0 a 100 (valor absoluto).
                <br><strong>Padrao:</strong> 25
                <br>&#x2022; <strong>10-20:</strong> Mais permissivo &mdash; envia quase tudo para IA, gasta mais tokens mas pega sinais fracos
                <br>&#x2022; <strong>25-35:</strong> Equilibrado (recomendado) &mdash; filtra ruido obvio, deixa IA decidir nos casos intermediarios
                <br>&#x2022; <strong>40-60:</strong> Restritivo &mdash; so envia para IA sinais tecnicos ja fortes, economiza tokens mas perde oportunidades
                <br><br><strong>Se nenhum trade ocorre em dias:</strong> Reduza este valor. Se o mercado esta lateral, a maioria das moedas tera score 10-20.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Intervalo do Bot (segundos)</div>
              <div class="help-param-desc">
                Tempo em segundos entre cada ciclo de analise do bot automatico.
                <br><strong>Padrao:</strong> 300 segundos (5 minutos)
                <br>&#x2022; <strong>30-60s:</strong> Muito frequente &mdash; consome mais API, bom para scalping
                <br>&#x2022; <strong>300s (5min):</strong> Moderado (recomendado)
                <br>&#x2022; <strong>900-3600s:</strong> Pouco frequente &mdash; para swing trading
                <br><br><strong>Atencao:</strong> Intervalos muito curtos podem esgotar o rate limit da API da Binance ou da IA.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Intervalo de Candles</div>
              <div class="help-param-desc">
                Periodo de tempo de cada candle no grafico e nos calculos de indicadores.
                <table class="help-table">
                  <tr><th>Valor</th><th>Uso recomendado</th></tr>
                  <tr><td><strong>1h</strong></td><td>Day trading / Swing trading &mdash; mais sinais, reage rapido</td></tr>
                  <tr><td><strong>4h (padrao)</strong></td><td>Swing trading &mdash; equilibrio entre sinais e confiabilidade</td></tr>
                  <tr><td><strong>1d</strong></td><td>Position trading &mdash; sinais mais confiaveis, operacoes de dias/semanas</td></tr>
                </table>
                <br><strong>Dica:</strong> Intervalos maiores geram sinais mais confiaveis mas menos frequentes. O padrao de 4h e o melhor equilibrio para a maioria dos cenarios.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Modo de Scan</div>
              <div class="help-param-desc">
                Define como o scanner seleciona moedas para analise. Cada modo usa criterios e fontes de dados diferentes.
                <br><br><strong>Padrao:</strong> Recuperacao

                <table class="help-table" style="margin-top:10px;">
                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:8px 0 4px;">&#x1F3C6; Recuperacao</td></tr>
                  <tr><td colspan="2">
                    Busca moedas com <strong>maior variacao positiva</strong> no periodo configurado (padrao 24h). Ideal para identificar ativos em recuperacao apos quedas.
                    <br><strong>Fonte:</strong> Endpoint <code>/v3/ticker</code> com janela configuravel.
                    <br><strong>Filtro:</strong> Apenas pares USDT com variacao &gt; 0%. Ordena por variacao descendente.
                    <br><strong>Coluna:</strong> Mostra a variacao percentual do periodo.
                    <br><strong>Melhor para:</strong> Pegar moedas que ja iniciaram um movimento de alta &mdash; a IA avalia se o movimento continua.
                  </td></tr>

                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:12px 0 4px;">&#x1F4CA; Volume</td></tr>
                  <tr><td colspan="2">
                    Busca as moedas <strong>mais negociadas</strong> (maior volume em USDT), independente de direcao. Inclui moedas em alta e em baixa.
                    <br><strong>Fonte:</strong> Endpoint <code>/v3/ticker</code> com janela configuravel.
                    <br><strong>Filtro:</strong> Todos os pares USDT. Ordena por volume cotado (quoteVolume) descendente.
                    <br><strong>Coluna:</strong> Mostra a variacao 24h.
                    <br><strong>Melhor para:</strong> Maxima liquidez. Combine com confianca minima alta (70%+) &mdash; a IA filtra a direcao.
                  </td></tr>

                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:12px 0 4px;">&#x1F534; RSI Extremos</td></tr>
                  <tr><td colspan="2">
                    Busca moedas com <strong>RSI abaixo de 30</strong> (sobrevendido) ou <strong>acima de 70</strong> (sobrecomprado). O RSI (Relative Strength Index) mede a forca do movimento recente &mdash; valores extremos indicam possivel reversao.
                    <br><strong>Fonte:</strong> Calculo local via klines (candles). Pre-filtra as top 50 por volume e calcula RSI de cada uma.
                    <br><strong>Filtro:</strong> RSI &lt; 30 ou RSI &gt; 70. Ordena por distancia do centro (|RSI - 50|), priorizando os mais extremos.
                    <br><strong>Coluna:</strong> Mostra o valor do RSI (verde se &lt; 30, vermelho se &gt; 70).
                    <br><strong>Melhor para:</strong> Estrategia de reversao a media. RSI &lt; 30 = possivel fundo (compra). RSI &gt; 70 = possivel topo (venda se posicionado).
                    <br><strong>Exemplo:</strong> RSI = 22 &rarr; moeda muito sobrevendida, probabilidade alta de bounce.
                  </td></tr>

                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:12px 0 4px;">&#x1F4A5; Breakout (Bollinger Squeeze)</td></tr>
                  <tr><td colspan="2">
                    Busca moedas com <strong>Bandas de Bollinger comprimidas</strong> (squeeze) onde o preco esta rompendo uma das bandas. Quando as bandas se estreitam, a volatilidade esta baixa &mdash; o rompimento tende a gerar um movimento explosivo.
                    <br><strong>Fonte:</strong> Calculo local via klines. Pre-filtra as top 50 por volume e calcula Bollinger de cada uma.
                    <br><strong>Filtro:</strong> Largura das bandas &lt; 4% da banda media E preco rompendo a banda superior ou inferior. Ordena por largura (mais apertado = melhor).
                    <br><strong>Coluna:</strong> Mostra a largura do squeeze em percentual (quanto menor, mais comprimido).
                    <br><strong>Melhor para:</strong> Capturar inicio de movimentos fortes. O squeeze indica acumulo de energia &mdash; o rompimento indica a direcao.
                    <br><strong>Exemplo:</strong> Squeeze 1.8% com preco acima da banda superior &rarr; rompimento de alta provavel.
                  </td></tr>

                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:12px 0 4px;">&#x1F504; MACD Crossover</td></tr>
                  <tr><td colspan="2">
                    Busca moedas onde o <strong>histograma MACD acabou de trocar de sinal</strong> (cruzamento recente entre a linha MACD e a linha Signal). Cruzamentos sinalizam mudanca de momentum.
                    <br><strong>Fonte:</strong> Calculo local via klines. Pre-filtra as top 50 por volume e calcula MACD de cada uma.
                    <br><strong>Filtro:</strong> Histograma MACD atual e anterior com sinais opostos (positivo &rarr; negativo ou vice-versa). Ordena pela forca do histograma (valor absoluto).
                    <br><strong>Coluna:</strong> Mostra a forca do MACD (verde se positivo/bullish, vermelho se negativo/bearish).
                    <br><strong>Melhor para:</strong> Pegar o inicio de uma nova tendencia. Histograma virando positivo = momentum de alta. Virando negativo = momentum de baixa.
                    <br><strong>Exemplo:</strong> Histograma passou de -0.0003 para +0.0001 &rarr; cruzamento bullish fresco.
                  </td></tr>

                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:12px 0 4px;">&#x1F680; Momentum</td></tr>
                  <tr><td colspan="2">
                    Busca moedas com <strong>multiplos indicadores alinhados</strong> na mesma direcao, gerando um score composto. Quanto mais indicadores concordam, mais forte a tendencia.
                    <br><strong>Fonte:</strong> Calculo local via klines. Pre-filtra as top 50 por volume e calcula todos os indicadores.
                    <br><strong>Filtro:</strong> Score composto &ge; 50 pontos (de 0 a 100). Ordena por score descendente.
                    <br><strong>Composicao do score:</strong>
                    <br>&nbsp;&nbsp;&#x2022; SMA20 &gt; SMA50 (media curta acima da longa) = <strong>+25 pts</strong>
                    <br>&nbsp;&nbsp;&#x2022; RSI entre 50 e 70 (forca sem sobrecompra) = <strong>+20 pts</strong>
                    <br>&nbsp;&nbsp;&#x2022; Histograma MACD &gt; 0 (momentum positivo) = <strong>+25 pts</strong>
                    <br>&nbsp;&nbsp;&#x2022; Preco acima da SMA20 = <strong>+15 pts</strong>
                    <br>&nbsp;&nbsp;&#x2022; EMA12 &gt; EMA26 (cruzamento rapido bullish) = <strong>+15 pts</strong>
                    <br><strong>Coluna:</strong> Mostra o score total em pontos (verde se &ge; 70, vermelho se &lt; 50).
                    <br><strong>Melhor para:</strong> Encontrar tendencias ja confirmadas com alta probabilidade de continuacao. Score 80+ = alinhamento quase perfeito.
                    <br><strong>Exemplo:</strong> Score 85 pts &rarr; todos os indicadores exceto um confirmam alta.
                  </td></tr>

                  <tr><td colspan="2" style="font-weight:700;color:var(--accent);padding:12px 0 4px;">&#x26A1; Flash Dip</td></tr>
                  <tr><td colspan="2">
                    Busca moedas que tiveram <strong>queda abrupta na ultima hora</strong> (&ge; 5%). Quedas subitas podem representar oportunidades de compra se forem exageradas (panic selling).
                    <br><strong>Fonte:</strong> Endpoint <code>/v3/ticker</code> com janela fixa de <strong>1 hora</strong>.
                    <br><strong>Filtro:</strong> Variacao &le; -5% na ultima hora. Ordena pela queda mais acentuada.
                    <br><strong>Coluna:</strong> Mostra a queda percentual em 1h (sempre vermelho).
                    <br><strong>Melhor para:</strong> Estrategia "buy the dip" &mdash; capturar bounces apos quedas exageradas. Use com confianca minima alta (70%+) pois nem toda queda reverte.
                    <br><strong>Cuidado:</strong> Quedas fortes podem continuar (knife catching). A IA ajuda a distinguir entre dips compraveis e quedas estruturais.
                    <br><strong>Exemplo:</strong> Moeda caiu -8.5% em 1h &rarr; possivel panic selling, avaliar bounce.
                  </td></tr>
                </table>
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Periodo de Recuperacao (horas)</div>
              <div class="help-param-desc">
                Janela de tempo usada pelo scanner para calcular a variacao de preco das moedas. <strong>Visivel apenas no modo Recuperacao.</strong>
                <br><strong>Padrao:</strong> 24 horas
                <br><strong>Minimo:</strong> 1 hora | <strong>Maximo:</strong> 168 horas (7 dias)
                <br><br>&#x2022; <strong>1-4h:</strong> Recuperacoes rapidas (scalping) &mdash; mais sinais, mais ruido
                <br>&#x2022; <strong>12-24h:</strong> Recuperacoes de curto prazo (padrao recomendado)
                <br>&#x2022; <strong>48-168h:</strong> Recuperacoes de medio prazo &mdash; tendencias mais solidas
                <br><br>O titulo do scanner e o cabecalho da tabela atualizam automaticamente para refletir o periodo selecionado (ex: "Top Recovery Coins (4h)").
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Moedas no Scanner (top N)</div>
              <div class="help-param-desc">
                Quantidade de moedas exibidas no ranking de recuperacao do scanner.
                <br><strong>Padrao:</strong> 30
                <br><strong>Minimo:</strong> 1 | <strong>Maximo:</strong> 100
                <br>Valores maiores mostram mais opcoes mas podem incluir moedas com recuperacao fraca.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Timeout Lateralizacao (horas)</div>
              <div class="help-param-desc">
                Tempo maximo que uma posicao aberta pode ficar sem movimento significativo (&lt;3% de variacao) antes do bot vender automaticamente para liberar capital. Veja a secao "Timeout de Lateralizacao" para detalhes completos.
                <br><strong>Padrao:</strong> 24 horas | <strong>Min:</strong> 1h | <strong>Max:</strong> 168h
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Cooldown entre Trades (minutos)</div>
              <div class="help-param-desc">
                Tempo minimo de espera entre operacoes (compra ou venda) no mesmo par de moedas. Evita que o bot fique comprando e vendendo rapidamente quando os indicadores oscilam na fronteira entre sinais.
                <br><strong>Padrao:</strong> 30 min | <strong>Min:</strong> 5 min | <strong>Max:</strong> 1440 min (24h)
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Snapshot Carteira (minutos)</div>
              <div class="help-param-desc">
                Intervalo em minutos entre cada snapshot automatico do valor total da carteira. Os snapshots sao salvos no banco de dados e usados para gerar o grafico de evolucao na aba Carteira.
                <br><strong>Padrao:</strong> 30 minutos | <strong>Min:</strong> 5 min | <strong>Max:</strong> 1440 min (24h)
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Auto-Trade <span class="badge danger">Cuidado</span></div>
              <div class="help-param-desc">
                Quando ativado, o bot executa ordens de compra e venda automaticamente baseado nos sinais da IA.
                <br>&#x2022; <strong>Desativado (padrao):</strong> O bot apenas analisa e mostra sinais &mdash; voce decide manualmente
                <br>&#x2022; <strong>Ativado:</strong> O bot executa trades reais se o sinal e confianca atingirem os criterios
              </div>
            </div>

            <div class="help-warning">&#x26A0; <strong>RISCO:</strong> Com Auto-Trade ativado e Testnet desativado, o bot executara ordens com <strong>dinheiro real</strong>. Use por sua conta e risco. Sempre comece com valores pequenos e monitore ativamente.</div>

            <div class="help-param">
              <div class="help-param-name">&#x1F4BE; Salvar Configuracoes</div>
              <div class="help-param-desc">
                Salva todas as configuracoes no arquivo <strong>BinanceTrader.ini</strong> ao lado do executavel.
                As configuracoes sao carregadas automaticamente ao iniciar o programa.
              </div>
            </div>
          </div>
        </div>

        <!-- ===== TIMEOUT LATERALIZACAO ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x23F1; Timeout de Lateralizacao (Auto-venda)
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p><strong>O que e lateralizacao?</strong> E quando o preco de uma moeda fica "andando de lado", sem subir nem descer significativamente. O capital fica preso sem gerar retorno.</p>

            <p><strong>Como funciona:</strong> O bot monitora todas as posicoes abertas (compras realizadas). Se uma posicao ficar aberta por mais de X horas e a variacao de preco for menor que 3%, o bot considera que a moeda esta lateral e vende automaticamente para liberar o capital.</p>

            <table class="help-table">
              <tr><th>Parametro</th><th>Padrao</th><th>Descricao</th></tr>
              <tr><td><strong>Timeout Lateralizacao</strong></td><td>24 horas</td><td>Tempo maximo que uma posicao pode ficar aberta sem movimento significativo</td></tr>
              <tr><td><strong>Cooldown entre Trades</strong></td><td>30 minutos</td><td>Tempo minimo entre operacoes no mesmo par. Evita que o bot compre e venda rapidamente no mesmo ativo</td></tr>
              <tr><td><strong>Limiar de variacao</strong></td><td>3%</td><td>Se a variacao absoluta do preco desde a compra for menor que 3%, considera-se lateral</td></tr>
            </table>

            <p><strong>Exemplo pratico:</strong></p>
            <div class="help-param">
              <div class="help-param-name">Cenario</div>
              <div class="help-param-desc">
                Voce comprou XRPUSDT a $0.50 as 10:00 de segunda-feira.<br>
                Passaram-se 24 horas. O preco atual e $0.505 (variacao de +1%).<br>
                Como 1% &lt; 3% e o tempo excedeu 24h, o bot detecta lateralizacao.<br>
                <strong>Acao:</strong> O bot vende XRPUSDT automaticamente e registra no log: "LATERALIZACAO DETECTADA".<br>
                O capital e liberado para ser investido em moedas com mais potencial.
              </div>
            </div>

            <p><strong>Quando NAO vende:</strong></p>
            <div class="help-param">
              <div class="help-param-name">Moeda subiu ou caiu mais de 3%</div>
              <div class="help-param-desc">
                Se a moeda subiu 5% desde a compra, mesmo apos 24h, o bot NAO vende por lateralizacao (ela nao esta lateral, esta em lucro). Nesse caso, o bot aguarda o sinal normal de SELL da analise tecnica + IA.
              </div>
            </div>

            <p><strong>Configuracao:</strong> Va em Configuracoes &rarr; "Timeout Lateralizacao (horas)" e ajuste o valor. O minimo e 1 hora, maximo 168 horas (1 semana).</p>

            <div class="help-warning">&#x26A0; Esta funcao so atua em posicoes abertas pelo bot. Se o timeout for 0 ou negativo, a funcao e desativada.</div>
          </div>
        </div>

        <!-- ===== TRAILING STOP ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F6D1; Trailing Stop Loss
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p><strong>O que e?</strong> Diferente do stop loss fixo (que vende num preco predefinido), o <strong>trailing stop</strong> "sobe" junto com o preco. Ele rastreia o <strong>preco maximo atingido</strong> (pico) e vende apenas quando o preco cai um percentual a partir desse pico.</p>

            <div class="help-tip">&#x1F4A1; O trailing stop protege lucros ja conquistados. Se o preco subir 10% e depois cair, voce vende perto do topo ao inves de esperar cair ate o preco de compra.</div>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Como funciona:</p>
            <table class="help-table">
              <tr><th>Passo</th><th>O que acontece</th></tr>
              <tr><td><strong>1. Compra</strong></td><td>Bot compra ETH a $2000. Pico = $2000.</td></tr>
              <tr><td><strong>2. Sobe</strong></td><td>Preco sobe para $2200. Pico atualiza para $2200.</td></tr>
              <tr><td><strong>3. Sobe mais</strong></td><td>Preco sobe para $2500. Pico atualiza para $2500.</td></tr>
              <tr><td><strong>4. Cai</strong></td><td>Preco cai para $2450. Queda = 2% do pico. Trailing 3%? Nao acionou. Aguarda.</td></tr>
              <tr><td><strong>5. Cai mais</strong></td><td>Preco cai para $2425. Queda = 3% do pico ($2500). <strong style="color:var(--red);">TRAILING STOP ACIONADO!</strong> Vende a $2425.</td></tr>
            </table>
            <p style="margin-top:8px;">Resultado: Comprou a $2000, vendeu a $2425. <strong style="color:var(--green);">Lucro: +$425 (+21.25%)</strong>. Sem trailing stop, poderia ter esperado cair mais.</p>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Parametros:</p>
            <table class="help-table">
              <tr><th>Parametro</th><th>Padrao</th><th>Descricao</th></tr>
              <tr><td><strong>Trailing Stop (%)</strong></td><td>3%</td><td>Percentual de queda a partir do pico que aciona a venda</td></tr>
              <tr><td><strong>Delay</strong></td><td>5 min</td><td>Nao aciona nos primeiros 5 minutos apos a compra (evita volatilidade inicial)</td></tr>
            </table>

            <p style="margin-top:12px;font-weight:600;">Recomendacoes de valor:</p>
            <table class="help-table">
              <tr><th>Valor</th><th>Perfil</th><th>Uso</th></tr>
              <tr><td>1-2%</td><td>Conservador</td><td>Protege lucro rapido, mas pode sair cedo em movimentos volateis</td></tr>
              <tr><td>3% (padrao)</td><td>Moderado</td><td>Equilibrio entre protecao e espaco para respirar</td></tr>
              <tr><td>4-5%</td><td>Agressivo</td><td>Mais espaco, captura movimentos maiores, mas devolve mais lucro na queda</td></tr>
            </table>

            <div class="help-param" style="margin-top:14px;">
              <div class="help-param-name">Persistencia</div>
              <div class="help-param-desc">O preco maximo (pico) de cada posicao e <strong>salvo no banco de dados</strong>. Se voce fechar e reabrir o programa, o pico nao se perde. O bot continua rastreando de onde parou.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Interacao com DCA</div>
              <div class="help-param-desc">Quando ha multiplas posicoes de DCA no mesmo symbol, o trailing stop usa o <strong>preco medio ponderado</strong> de todas as posicoes e o <strong>pico global</strong> (maior pico entre todas as posicoes). Ao acionar, vende <strong>tudo</strong> de uma vez.</div>
            </div>
          </div>
        </div>

        <!-- ===== DCA ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F504; DCA (Dollar Cost Averaging)
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p><strong>O que e?</strong> Quando o preco cai apos a compra, o bot compra mais em <strong>degraus de queda</strong> para baixar o preco medio de entrada. Isso aumenta a chance de recuperar o investimento quando o preco voltar a subir.</p>

            <div class="help-tip">&#x1F4A1; DCA transforma uma posicao perdedora em uma posicao que precisa subir <strong>menos</strong> para dar lucro. O preco medio cai a cada compra adicional.</div>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Exemplo pratico:</p>
            <table class="help-table">
              <tr><th>Evento</th><th>Preco ETH</th><th>Queda</th><th>Acao</th><th>Investido</th><th>Preco Medio</th></tr>
              <tr><td>Compra inicial</td><td>$2000</td><td>--</td><td>Compra $100</td><td>$100</td><td>$2000</td></tr>
              <tr><td>DCA #1</td><td>$1940</td><td>-3%</td><td>Compra $100</td><td>$200</td><td>$1970</td></tr>
              <tr><td>DCA #2</td><td>$1900</td><td>-5%</td><td>Compra $100</td><td>$300</td><td>$1947</td></tr>
              <tr><td>DCA #3</td><td>$1840</td><td>-8%</td><td>Compra $100</td><td>$400</td><td>$1920</td></tr>
            </table>
            <p style="margin-top:8px;">Sem DCA: precisaria subir ate $2000 para breakeven. Com DCA: breakeven em <strong>$1920</strong> (-4% mais facil).</p>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Parametros:</p>
            <table class="help-table">
              <tr><th>Parametro</th><th>Padrao</th><th>Descricao</th></tr>
              <tr><td><strong>DCA Automatico</strong></td><td>Desativado</td><td>Toggle para habilitar/desabilitar o DCA</td></tr>
              <tr><td><strong>Max DCA</strong></td><td>3</td><td>Numero maximo de compras extras (1-3)</td></tr>
              <tr><td><strong>DCA 1 (%)</strong></td><td>3%</td><td>Queda do preco de entrada para acionar a 1a compra extra</td></tr>
              <tr><td><strong>DCA 2 (%)</strong></td><td>5%</td><td>Queda para acionar a 2a compra extra</td></tr>
              <tr><td><strong>DCA 3 (%)</strong></td><td>8%</td><td>Queda para acionar a 3a compra extra</td></tr>
            </table>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Comportamento:</p>
            <div class="help-param">
              <div class="help-param-name">Referencia de queda</div>
              <div class="help-param-desc">Os percentuais de queda sao calculados a partir do <strong>preco da primeira compra</strong> (entry original), nao do preco atual. Isso garante niveis fixos e previsiveis.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Valor de cada DCA</div>
              <div class="help-param-desc">Cada compra DCA usa o mesmo <strong>Valor por Trade</strong> configurado. Se o trade amount e $100, cada DCA tambem sera de $100.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Cooldown</div>
              <div class="help-param-desc">Ha um cooldown de <strong>5 minutos</strong> entre cada DCA do mesmo symbol, e apenas <strong>1 DCA por ciclo do bot</strong> e executado (evita compras simultaneas).</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Verificacao de saldo</div>
              <div class="help-param-desc">Antes de cada DCA, o bot verifica se ha saldo USDT suficiente. Se o saldo for menor que o valor do trade, o DCA nao e executado.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Venda total</div>
              <div class="help-param-desc">Quando ocorre venda (trailing stop, take profit, IA ou lateral), o bot vende <strong>todas as posicoes</strong> do symbol de uma vez &mdash; nao vende parcialmente.</div>
            </div>

            <div class="help-warning">&#x26A0; <strong>Risco:</strong> DCA aumenta a exposicao ao ativo. Se a moeda continuar caindo alem dos niveis de DCA, o prejuizo sera maior. Use em conjunto com trailing stop para limitar perdas.</div>
          </div>
        </div>

        <!-- ===== TELEGRAM ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4F1; Notificacoes Telegram
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>Receba alertas no celular em tempo real quando o bot executa acoes importantes. As notificacoes sao enviadas via <strong>Telegram Bot API</strong>.</p>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Eventos notificados:</p>
            <table class="help-table">
              <tr><th>Evento</th><th>Icone</th><th>Quando</th></tr>
              <tr><td><strong>Compra executada</strong></td><td style="color:var(--green);">&#x1F7E2;</td><td>Bot compra uma moeda (manual, auto-trade ou DCA)</td></tr>
              <tr><td><strong>Venda executada</strong></td><td style="color:var(--red);">&#x1F534;</td><td>Bot vende uma moeda (manual, auto-trade, trailing stop ou take profit)</td></tr>
              <tr><td><strong>Trailing Stop</strong></td><td>&#x26A0;</td><td>Trailing stop acionado &mdash; preco caiu X% do pico</td></tr>
              <tr><td><strong>Take Profit</strong></td><td>&#x1F4B0;</td><td>Take profit atingido &mdash; lucro alvo alcancado</td></tr>
              <tr><td><strong>DCA</strong></td><td>&#x1F504;</td><td>Compra DCA executada em degrau de queda</td></tr>
              <tr><td><strong>Oportunidade</strong></td><td>&#x1F50D;</td><td>Sinal COMPRA FORTE detectado com confianca acima do minimo</td></tr>
            </table>

            <p style="margin-top:14px;font-weight:600;color:var(--accent);">Como configurar:</p>
            <div class="help-param">
              <div class="help-param-name">Passo 1: Criar o Bot no Telegram</div>
              <div class="help-param-desc">
                1. Abra o Telegram e procure <strong>@BotFather</strong><br>
                2. Envie o comando <code>/newbot</code><br>
                3. Escolha um nome e um username para o bot<br>
                4. O BotFather vai retornar um <strong>Token</strong> no formato: <code>123456789:ABCdefGHIjklMNOpqrsTUVwxyz</code><br>
                5. Copie esse token e cole no campo <strong>"Bot Token"</strong> nas Configuracoes
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Passo 2: Obter seu Chat ID</div>
              <div class="help-param-desc">
                1. Abra o Telegram e procure o bot que voce acabou de criar pelo username<br>
                2. Envie <code>/start</code> para o bot (obrigatorio, senao o bot nao consegue enviar mensagens)<br>
                3. Acesse no navegador: <code>https://api.telegram.org/bot&lt;SEU_TOKEN&gt;/getUpdates</code><br>
                4. Procure o campo <code>"chat":{"id":123456789}</code> &mdash; esse numero e seu <strong>Chat ID</strong><br>
                5. Cole o Chat ID no campo correspondente nas Configuracoes
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Passo 3: Testar</div>
              <div class="help-param-desc">
                Ative o toggle <strong>"Notificacoes Telegram"</strong>, preencha Token e Chat ID, e clique <strong>"Enviar Teste"</strong>. Se tudo estiver correto, voce recebera uma mensagem de confirmacao no Telegram.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Parametros</div>
              <div class="help-param-desc">
                <table class="help-table">
                  <tr><th>Campo</th><th>Descricao</th></tr>
                  <tr><td><strong>Notificacoes Telegram</strong></td><td>Toggle para habilitar/desabilitar (padrao: desativado)</td></tr>
                  <tr><td><strong>Bot Token</strong></td><td>Token do bot fornecido pelo @BotFather</td></tr>
                  <tr><td><strong>Chat ID</strong></td><td>ID numerico do chat/usuario que recebera as mensagens</td></tr>
                </table>
              </div>
            </div>

            <div class="help-tip">&#x1F4A1; Voce tambem pode usar um <strong>grupo do Telegram</strong>: adicione o bot ao grupo, envie uma mensagem, e use o Chat ID do grupo (que sera um numero negativo, ex: <code>-1001234567890</code>).</div>
          </div>
        </div>

        <!-- ===== ABA LOG ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4CB; Aba Log
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>Registro em tempo real de todas as atividades do sistema. Cada entrada tem um horario, uma tag colorida e a mensagem.</p>

            <table class="help-table">
              <tr><th>Tag</th><th>Cor</th><th>Significado</th></tr>
              <tr><td><strong>BINANCE</strong></td><td style="color:var(--accent);">Amarelo</td><td>Comunicacao com a API da Binance (requisicoes, respostas)</td></tr>
              <tr><td><strong>IA</strong></td><td style="color:var(--purple);">Roxo</td><td>Comunicacao com a API de IA (envio, resposta, erros)</td></tr>
              <tr><td><strong>BOT</strong></td><td style="color:var(--blue);">Azul</td><td>Acoes do bot (scan, analise, sinais, decisoes)</td></tr>
              <tr><td><strong>TRADE</strong></td><td style="color:var(--green);">Verde</td><td>Execucao de ordens (compra, venda, confirmacao)</td></tr>
              <tr><td><strong>TRAILINGSTOP</strong></td><td style="color:var(--red);">Vermelho</td><td>Trailing stop acionado (preco caiu X% do pico)</td></tr>
              <tr><td><strong>TAKEPROFIT</strong></td><td style="color:var(--green);">Verde</td><td>Take profit atingido (lucro alvo alcancado)</td></tr>
              <tr><td><strong>DCA</strong></td><td style="color:var(--blue);">Azul</td><td>Compra DCA executada em degrau de queda</td></tr>
              <tr><td><strong>POSICAO</strong></td><td style="color:var(--text-primary);">Branco</td><td>Abertura/fechamento de posicoes</td></tr>
              <tr><td><strong>TELEGRAM</strong></td><td style="color:var(--accent);">Amarelo</td><td>Status de envio de notificacoes Telegram</td></tr>
              <tr><td><strong>CARTEIRA</strong></td><td style="color:var(--text-primary);">Branco</td><td>Snapshots e atualizacoes da carteira</td></tr>
              <tr><td><strong>ERRO</strong></td><td style="color:var(--red);">Vermelho</td><td>Erros e falhas (conexao, API, validacao)</td></tr>
              <tr><td><strong>SCANNER</strong></td><td style="color:var(--text-muted);">Cinza</td><td>Progresso do scanner de mercado</td></tr>
              <tr><td><strong>SISTEMA</strong></td><td style="color:var(--text-muted);">Cinza</td><td>Eventos do sistema (inicio, config, interface)</td></tr>
            </table>

            <div class="help-tip">&#x1F4A1; O log e essencial para depurar problemas. Se algo nao funcionar, verifique as mensagens de ERRO no log. O log mantem ate 500 entradas na sessao.</div>
          </div>
        </div>

        <!-- ===== ABA CARTEIRA ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4B0; Aba Carteira
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>Visao consolidada de todos os ativos da sua conta Binance com valores convertidos para USDT.</p>

            <div class="help-param">
              <div class="help-param-name">Saldos por Ativo</div>
              <div class="help-param-desc">
                Tabela com todos os ativos que possuem saldo, mostrando: ativo, quantidade livre, quantidade bloqueada e valor estimado em USDT.
                <br>A conversao para USDT e feita usando o preco atual de mercado de cada par.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Total em USDT</div>
              <div class="help-param-desc">
                Soma de todos os ativos convertidos para USDT. Inclui stablecoins (USDT, USDC, BUSD, FDUSD) e cripto convertida via preco de mercado.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Grafico de Evolucao</div>
              <div class="help-param-desc">
                Mini grafico mostrando a evolucao do valor total da carteira ao longo do tempo, baseado nos <strong>snapshots automaticos</strong>.
                <br>Snapshots sao salvos periodicamente (intervalo configuravel em Configuracoes, padrao 30 min) e persistem no banco de dados entre sessoes.
              </div>
            </div>

            <div class="help-tip">&#x1F4A1; Use o botao "Atualizar" para forcar uma atualizacao imediata dos saldos e gerar um novo snapshot.</div>
          </div>
        </div>

        <!-- ===== ABA DESEMPENHO ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4CA; Aba Desempenho
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>Metricas detalhadas de performance do bot, calculadas a partir do historico de trades persistido.</p>

            <div class="help-param">
              <div class="help-param-name">Cards de Resumo</div>
              <div class="help-param-desc">
                &#x2022; <strong>Total de Trades:</strong> Quantidade total de ordens executadas (compras + vendas)
                <br>&#x2022; <strong>P&amp;L Total:</strong> Lucro/prejuizo total em USDT (verde = lucro, vermelho = prejuizo)
                <br>&#x2022; <strong>Win Rate:</strong> Percentual de trades lucrativos (calculado dos trades pareados compra-venda)
                <br>&#x2022; <strong>Melhor/Pior Trade:</strong> Maior lucro e maior prejuizo individual
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Curva de Equity</div>
              <div class="help-param-desc">
                Grafico mostrando a evolucao acumulada do P&amp;L ao longo do tempo. Cada ponto representa o lucro/prejuizo acumulado apos cada trade pareado (compra + venda).
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Desempenho por Moeda</div>
              <div class="help-param-desc">
                Tabela agrupando os resultados por par (ex: BTC-USDT), mostrando: quantidade de trades, P&amp;L total e win rate por moeda. Ordenado por P&amp;L decrescente.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Posicoes Abertas</div>
              <div class="help-param-desc">
                Lista de compras que ainda nao foram vendidas. Mostra o par, preco de entrada, quantidade, valor estimado atual e preco pico (para trailing stop). As posicoes abertas sao <strong>persistidas no banco de dados</strong> e sobrevivem ao reiniciar o programa.
                <br>Quando DCA esta ativo, um mesmo symbol pode ter <strong>multiplas posicoes</strong> (compra original + DCAs). A tabela mostra cada posicao individualmente, e o trailing stop/take profit usa o preco medio ponderado de todas.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Trades Pareados</div>
              <div class="help-param-desc">
                Tabela detalhada de cada operacao completa (compra + venda casadas), mostrando: par, preco de entrada e saida, quantidade, P&amp;L em USDT, P&amp;L percentual, duracao e sinal que gerou o trade.
              </div>
            </div>
          </div>
        </div>

        <!-- ===== SINAIS DA IA ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F916; Sinais da IA (Detalhado)
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">
            <p>A IA recebe todos os indicadores tecnicos e os ultimos 20 candles, e retorna uma analise estruturada.</p>

            <table class="help-table">
              <tr><th>Sinal</th><th>Significado</th><th>Acao do Bot</th></tr>
              <tr><td style="color:var(--green);font-weight:700;">COMPRA FORTE</td><td>Multiplos indicadores apontam alta com alta confianca</td><td>Compra automatica (se Auto-Trade ativo)</td></tr>
              <tr><td style="color:var(--green);">COMPRA</td><td>Indicadores moderadamente positivos</td><td>Compra automatica (se Auto-Trade ativo)</td></tr>
              <tr><td style="color:var(--accent);">MANTER</td><td>Sem sinal claro; mercado indeciso ou lateralizado</td><td>Nenhuma acao</td></tr>
              <tr><td style="color:var(--red);">VENDA</td><td>Indicadores moderadamente negativos</td><td>Venda automatica (se Auto-Trade ativo)</td></tr>
              <tr><td style="color:var(--red);font-weight:700;">VENDA FORTE</td><td>Multiplos indicadores apontam queda com alta confianca</td><td>Venda automatica (se Auto-Trade ativo)</td></tr>
            </table>

            <div class="help-param">
              <div class="help-param-name">Confianca</div>
              <div class="help-param-desc">
                Percentual de 0 a 100 indicando o quao certo a IA esta sobre o sinal.
                <br>&#x2022; <strong>0-40%:</strong> Sinal fraco &mdash; melhor ignorar
                <br>&#x2022; <strong>40-70%:</strong> Sinal moderado &mdash; considere com cautela
                <br>&#x2022; <strong>70-100%:</strong> Sinal forte &mdash; maior probabilidade de acerto
                <br><br>O bot so executa trades quando a confianca &ge; <strong>Confianca Minima</strong> configurada.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Precos Sugeridos</div>
              <div class="help-param-desc">
                <br>&#x2022; <strong>Entrada:</strong> Preco ideal para abrir a posicao (geralmente proximo ao preco atual)
                <br>&#x2022; <strong>Stop Loss:</strong> Preco para fechar a posicao com perda limitada
                <br>&#x2022; <strong>Take Profit:</strong> Preco para fechar a posicao com lucro
                <br><br>Estes sao <strong>sugestoes</strong> da IA. As ordens executadas sao sempre a <strong>mercado</strong> (MARKET) no preco atual.
              </div>
            </div>

            <div class="help-param">
              <div class="help-param-name">Reasoning (Raciocinio)</div>
              <div class="help-param-desc">
                Explicacao textual da IA sobre porque chegou naquele sinal. Util para entender a logica e aprender analise tecnica.
                <br>Quando nao ha IA configurada, mostra o Score Tecnico calculado localmente.
              </div>
            </div>
          </div>
        </div>

        <!-- ===== DICAS E BOAS PRATICAS ===== -->
        <div class="help-section">
          <div class="help-section-header" onclick="toggleHelpSection(this)">
            &#x1F4A1; Dicas e Boas Praticas
            <span class="chevron">&#x25BC;</span>
          </div>
          <div class="help-section-body">

            <div class="help-param">
              <div class="help-param-name">1. Comece pela Testnet</div>
              <div class="help-param-desc">Sempre teste suas configuracoes na Testnet antes de usar dinheiro real. Crie chaves API de teste em <strong>testnet.binance.vision</strong>.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">2. Comece com valores pequenos</div>
              <div class="help-param-desc">Ao migrar para a conta real, comece com trades de 10-20 USDT para validar que tudo funciona corretamente antes de aumentar os valores.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">3. Monitore o bot ativamente</div>
              <div class="help-param-desc">Mesmo com Auto-Trade, nao deixe o bot operando sem supervisao por longos periodos. Mercado cripto e extremamente volatil e eventos inesperados podem causar perdas rapidas.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">4. Respeite a relacao Risco:Retorno</div>
              <div class="help-param-desc">Configure Take Profit como pelo menos <strong>2x o Stop Loss</strong>. Ex: SL 2% + TP 4%. Isso significa que voce pode errar 50% das vezes e ainda ter lucro.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">5. Diversifique</div>
              <div class="help-param-desc">Nao coloque todo seu capital em uma unica moeda. O scanner mostra N opcoes (configuravel em Configuracoes, padrao 30) justamente para voce poder distribuir o risco.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">6. Confianca Minima alta no inicio</div>
              <div class="help-param-desc">Comece com confianca minima de 80% e va ajustando conforme ganha experiencia com o sistema. Mais confianca = menos trades = menos risco.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">7. Verifique o Log</div>
              <div class="help-param-desc">Se algo nao funcionar como esperado, a aba Log tem todas as informacoes necessarias para diagnosticar o problema.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">8. Configure o Telegram</div>
              <div class="help-param-desc">Ative as notificacoes Telegram para monitorar o bot pelo celular. Voce recebe alertas de compras, vendas, trailing stops, DCA e oportunidades sem precisar ficar olhando a tela.</div>
            </div>

            <div class="help-param">
              <div class="help-param-name">9. Use DCA com moderacao</div>
              <div class="help-param-desc">DCA ajuda a baixar o preco medio, mas aumenta a exposicao. Configure niveis conservadores (-3%, -5%, -8%) e mantenha o trailing stop ativo para limitar perdas totais. Nunca invista mais do que pode perder.</div>
            </div>

            <div class="help-warning">&#x26A0; <strong>AVISO LEGAL:</strong> Este software e fornecido "como esta", sem garantias. Trading de criptomoedas envolve risco significativo de perda financeira. Voce e o unico responsavel pelas suas decisoes de investimento. Performance passada nao garante resultados futuros.</div>

          </div>
        </div>

      </div>
    </div>

    <!-- ==================== PERFORMANCE TAB ==================== -->
    <div class="tab-panel perf-panel" data-tab-panel="performance">

      <!-- Summary Cards -->
      <div class="perf-cards-row">
        <div class="perf-card">
          <div class="perf-card-label">Total Trades</div>
          <div class="perf-card-value neutral" id="perf-total-trades">0</div>
        </div>
        <div class="perf-card">
          <div class="perf-card-label">Compras / Vendas</div>
          <div class="perf-card-value neutral" id="perf-buy-sell">0 / 0</div>
        </div>
        <div class="perf-card">
          <div class="perf-card-label">P&amp;L Total (USDT)</div>
          <div class="perf-card-value neutral" id="perf-total-pnl">0.00</div>
        </div>
        <div class="perf-card">
          <div class="perf-card-label">Win Rate</div>
          <div class="perf-card-value neutral" id="perf-win-rate">--</div>
        </div>
        <div class="perf-card">
          <div class="perf-card-label">Melhor Trade</div>
          <div class="perf-card-value positive" id="perf-best-trade">--</div>
        </div>
        <div class="perf-card">
          <div class="perf-card-label">Pior Trade</div>
          <div class="perf-card-value negative" id="perf-worst-trade">--</div>
        </div>
      </div>

      <!-- Equity Curve Chart -->
      <div class="perf-chart-card">
        <span class="card-title">Curva de Equity (P&amp;L acumulado)</span>
        <canvas id="equity-canvas"></canvas>
      </div>

      <!-- Tables row -->
      <div class="perf-tables-row">
        <!-- Per-symbol stats -->
        <div class="perf-table-card">
          <span class="card-title">Performance por Moeda</span>
          <table class="data-table">
            <thead>
              <tr><th>Moeda</th><th>Trades</th><th>P&amp;L (USDT)</th><th>Win Rate</th></tr>
            </thead>
            <tbody id="perf-symbol-tbody">
              <tr><td colspan="4" class="placeholder-text">Sem dados.</td></tr>
            </tbody>
          </table>
        </div>
        <!-- Open positions -->
        <div class="perf-table-card">
          <span class="card-title">Posicoes Abertas (sem venda)</span>
          <table class="data-table">
            <thead>
              <tr><th>Moeda</th><th>Preco Entrada</th><th>Quantidade</th><th>Valor (USDT)</th></tr>
            </thead>
            <tbody id="perf-open-tbody">
              <tr><td colspan="4" class="placeholder-text">Nenhuma posicao aberta.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Paired trades table (full width) -->
      <div class="perf-tables-row">
        <div class="perf-table-card perf-full-width">
          <span class="card-title">Trades Pareados (Entrada &rarr; Saida)</span>
          <table class="data-table">
            <thead>
              <tr><th>Moeda</th><th>Entrada</th><th>Saida</th><th>Qtd</th><th>P&amp;L (USDT)</th><th>P&amp;L (%)</th><th>Duracao</th><th>Sinal</th></tr>
            </thead>
            <tbody id="perf-pairs-tbody">
              <tr><td colspan="8" class="placeholder-text">Nenhum trade pareado.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- ==================== WALLET TAB ==================== -->
    <div class="tab-panel wallet-panel" data-tab-panel="wallet">

      <div class="wallet-summary-card">
        <div style="flex-shrink:0;">
          <div class="wallet-total-label">Saldo Total Estimado</div>
          <div class="wallet-total-value" id="wallet-total-usdt">$0.00</div>
          <div class="wallet-total-sub" id="wallet-asset-count">0 ativos</div>
        </div>
        <div style="flex:1;margin:0 20px;min-width:0;">
          <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Evolucao do Portfolio</div>
          <canvas id="wallet-mini-chart" style="width:100%;height:60px;display:block;"></canvas>
          <div style="display:flex;justify-content:space-between;margin-top:3px;">
            <span style="font-size:10px;color:var(--text-muted);" id="wallet-chart-info">0 snapshots</span>
            <span style="font-size:11px;font-weight:600;" id="wallet-chart-pnl">$0.00</span>
          </div>
        </div>
        <div style="flex-shrink:0;">
          <button class="btn btn-accent" id="wallet-refresh-btn" onclick="sendToDelphi('refreshWallet')">&#x1F504; Atualizar</button>
        </div>
      </div>

      <div class="wallet-loading" id="wallet-loading" style="display:none;">Carregando saldos...</div>

      <div class="wallet-table-card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
          <span class="card-title" style="margin-bottom:0;">Ativos com Saldo</span>
          <div style="display:flex; align-items:center; gap:8px;">
            <label style="font-size:12px; color:var(--text-muted);">Filtro minimo:</label>
            <input type="number" id="wallet-min-filter" value="0.02" min="0" step="0.01"
              style="width:80px; padding:4px 8px; background:var(--bg-card); border:1px solid var(--border); border-radius:4px; color:var(--text); font-size:12px; text-align:right;"
              onchange="renderWalletTable()" oninput="renderWalletTable()">
            <span style="font-size:12px; color:var(--text-muted);">USDT</span>
          </div>
        </div>
        <table class="data-table" id="wallet-table">
          <thead>
            <tr>
              <th>Ativo</th>
              <th>Livre</th>
              <th>Bloqueado</th>
              <th>Total</th>
              <th>Valor em USDT</th>
            </tr>
          </thead>
          <tbody id="wallet-tbody">
            <tr><td colspan="5" class="placeholder-text">Clique em "Atualizar" para carregar a carteira.</td></tr>
          </tbody>
        </table>
      </div>

    </div>

    <!-- ==================== CHAT TAB ==================== -->
    <div class="tab-panel chat-panel" data-tab-panel="chat">
      <div class="chat-header">
        <span class="chat-title">Chat com IA - Especialista em Trade</span>
        <button class="btn btn-sm btn-outline" onclick="clearChatHistory()" title="Limpar historico">Limpar</button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-welcome">
          <div class="chat-welcome-icon">&#x1F916;</div>
          <div class="chat-welcome-text">Ola! Sou seu assistente especialista em trading na Binance.<br>Pergunte sobre analise tecnica, estrategias, gestao de risco ou qualquer duvida sobre cripto.</div>
        </div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="Digite sua pergunta sobre trading..." rows="1" onkeydown="chatInputKeydown(event)"></textarea>
        <button class="btn btn-accent chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()">Enviar</button>
      </div>
    </div>

    <!-- COIN HISTORY MODAL -->
    <div class="modal-overlay" id="coin-history-modal" onclick="closeCoinHistoryModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <div class="modal-header-left">
            <span class="modal-symbol" id="modal-symbol">--</span>
            <span class="modal-price" id="modal-price">--</span>
            <span class="modal-change" id="modal-change">--</span>
          </div>
          <button class="modal-close-btn" onclick="closeCoinHistoryModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-loading" id="modal-loading">Carregando historico...</div>
          <div id="modal-data" style="display:none;">
            <div class="modal-tf-btns">
              <button class="modal-tf-btn active" id="modal-tf-1h" onclick="switchModalTimeframe('1h')">1h</button>
              <button class="modal-tf-btn" id="modal-tf-24h" onclick="switchModalTimeframe('24h')">24h</button>
            </div>
            <div class="modal-chart-wrapper">
              <canvas id="modal-chart-canvas" style="width:100%;height:200px;display:block;"></canvas>
            </div>
            <div class="modal-stats">
              <div class="modal-stat-item">
                <div class="modal-stat-label">Alta 24h</div>
                <div class="modal-stat-value" style="color:var(--green);" id="modal-high">--</div>
              </div>
              <div class="modal-stat-item">
                <div class="modal-stat-label">Baixa 24h</div>
                <div class="modal-stat-value" style="color:var(--red);" id="modal-low">--</div>
              </div>
              <div class="modal-stat-item">
                <div class="modal-stat-label">Volume 24h</div>
                <div class="modal-stat-value" id="modal-volume">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- COIN SELECTOR MODAL -->
    <div class="modal-overlay" id="coin-selector-modal" onclick="closeCoinSelectorModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;">
        <div class="modal-header">
          <span style="font-weight:700;font-size:15px;">&#x1F50D; Selecionar Moeda</span>
          <button class="modal-close-btn" onclick="closeCoinSelectorModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:0;">
          <div style="padding:12px 14px;">
            <input type="text" id="coin-search-input" placeholder="Buscar... (ex: BTC, ETH, DOGE, KAIA)"
                   oninput="filterCoinSelector()"
                   style="width:100%;box-sizing:border-box;padding:10px 12px;font-size:14px;background:var(--bg-primary);border:1px solid var(--border);color:var(--text-primary);border-radius:8px;outline:none;">
          </div>
          <div id="coin-selector-loading" style="text-align:center;padding:30px;color:var(--text-muted);display:none;">
            <div style="font-size:14px;">Carregando pares USDT...</div>
          </div>
          <div id="coin-selector-list" style="max-height:420px;overflow-y:auto;padding:0 4px 8px 4px;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="footer">
  <span>Binance Recovery Bot v1.0</span>
  <span id="footer-clock" class="accent"></span>
</div>

<script>
// =====================================================================
// STATE
// =====================================================================
var state = {
  selectedCoin: null,
  coins: [],
  candles: [],
  indicators: {},
  signal: null,
  connected: false,
  testnet: false,
  botRunning: false,
  autoTrade: false,
  analyzing: false,
  trades: [],
  walletSnapshots: [],
  scanMode: 'recovery',
  recoveryHours: 24,
  balance: {
    baseAsset: '--',
    quoteAsset: 'USDT',
    baseFree: '0.00',
    baseLocked: '0.00',
    quoteFree: '0.00',
    quoteLocked: '0.00'
  },
  aiKeys: { openai: '', groq: '', mistral: '', cerebras: '', deepseek: '' },
  chatHistory: [],
  chatWaiting: false
};

// =====================================================================
// TAB NAVIGATION
// =====================================================================
document.querySelectorAll('.tab-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var tabName = this.getAttribute('data-tab');
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    this.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
    var panel = document.querySelector('[data-tab-panel="' + tabName + '"]');
    if (panel) {
      panel.classList.add('active');
    }
    if (tabName === 'scanner' && state.candles.length > 0) {
      setTimeout(function() { drawChart(); }, 50);
    }
    if (tabName === 'performance') {
      setTimeout(function() { renderPerformance(); }, 50);
    }
    if (tabName === 'wallet') {
      var wtbody = document.getElementById('wallet-tbody');
      if (wtbody && wtbody.querySelector('.placeholder-text')) {
        sendToDelphi('refreshWallet');
      }
      setTimeout(function() { drawWalletMiniChart(); }, 50);
    }
  });
});

// =====================================================================
// HELP / MANUAL: collapsible sections
// =====================================================================
function toggleHelpSection(headerEl) {
  var section = headerEl.parentElement;
  section.classList.toggle('open');
}

// =====================================================================
// COMMUNICATION: JS -> DELPHI
// =====================================================================
function sendToDelphi(action, data) {
  try {
    window.chrome.webview.postMessage(JSON.stringify({ action: action, data: data || {} }));
  } catch (e) {
    console.log('[sendToDelphi] Bridge not available:', action, data);
  }
}

// =====================================================================
// COMMUNICATION: DELPHI -> JS (via ExecuteScript with JS object literal)
// =====================================================================
function handleDelphiMessage(msg) {
  if (!msg || !msg.action) return;
  var action = msg.action;
  var data = msg.data || {};

  switch (action) {
    case 'topCoins':        onTopCoins(data); break;
    case 'updatePrice':     onUpdatePrice(data); break;
    case 'updateIndicators': onUpdateIndicators(data); break;
    case 'updateSignal':    onUpdateSignal(data); break;
    case 'updateBalance':   onUpdateBalance(data); break;
    case 'updateCandles':   onUpdateCandles(data); break;
    case 'addLog':          onAddLog(data); break;
    case 'addTrade':        onAddTrade(data); break;
    case 'connectionStatus': onConnectionStatus(data); break;
    case 'botStatus':       onBotStatus(data); break;
    case 'analyzing':       onAnalyzing(data); break;
    case 'loadConfig':      onLoadConfig(data); break;
    case 'scanProgress':    onScanProgress(data); break;
    case 'selectedCoin':    onSelectedCoin(data); break;
    case 'walletData':      onWalletData(data); break;
    case 'walletLoading':   onWalletLoading(data); break;
    case 'loadTrades':      onLoadTrades(data); break;
    case 'tradeError':      onTradeError(data); break;
    case 'walletSnapshots': onWalletSnapshots(data); break;
    case 'walletSnapshotAdd': onWalletSnapshotAdd(data); break;
    case 'optimizeProgress':  onOptimizeProgress(data); break;
    case 'optimizeResult':    onOptimizeResult(data); break;
    case 'optimizeApplied':   onOptimizeApplied(data); break;
    case 'testAIResult':      onTestAIResult(data); break;
    case 'aiStats':           onAIStats(data); break;
    case 'coinHistoryData':   onCoinHistoryData(data); break;
    case 'allSymbols':        onAllSymbols(data); break;
    case 'chatResponse':      onChatResponse(data); break;
    case 'chatToolCall':      onChatToolCall(data); break;
    default: break;
  }
}

// Also listen for WebView2 postMessage from Delphi
if (window.chrome && window.chrome.webview) {
  window.chrome.webview.addEventListener('message', function(event) {
    var msg = event.data;
    if (typeof msg === 'string') {
      try { msg = JSON.parse(msg); } catch (e) { return; }
    }
    handleDelphiMessage(msg);
  });
}

// =====================================================================
// HANDLERS: DELPHI -> JS
// =====================================================================
function onTopCoins(data) {
  var coins = data.coins || [];
  state.coins = coins;
  renderCoinsTable();
  document.getElementById('last-scan-time').textContent = 'Ultimo scan: ' + formatTime(new Date());
  document.getElementById('scan-progress-bar').textContent = '';
}

function onUpdatePrice(data) {
  if (data.symbol && data.symbol === state.selectedCoin) {
    document.getElementById('detail-price').textContent = formatPrice(data.price);
    document.getElementById('trade-selected-price').textContent = formatPrice(data.price) + ' USDT';
  }
  for (var i = 0; i < state.coins.length; i++) {
    if (state.coins[i].symbol === data.symbol) {
      state.coins[i].price = data.price;
      break;
    }
  }
  renderCoinsTable();
}

function onUpdateIndicators(data) {
  state.indicators = data;
  renderIndicators();
}

function onUpdateSignal(data) {
  state.signal = data;
  renderSignal();
}

function onUpdateBalance(data) {
  state.balance = data;
  renderBalance();
}

function onUpdateCandles(data) {
  state.candles = data.candles || [];
  drawChart();
}

function onAddLog(data) {
  appendLog(data.tag, data.message, data.time);
  if (data.tag === 'Erro') playErrorSound();
}

function onAddTrade(data) {
  state.trades.unshift(data);
  renderTrades();
  playTradeSound(data.side || 'BUY');
  // Limpar banner de erro ao trade bem sucedido
  var banner = document.getElementById('trade-error-banner');
  if (banner) banner.style.display = 'none';
  // Update performance tab if it's active
  var perfPanel = document.querySelector('[data-tab-panel="performance"]');
  if (perfPanel && perfPanel.classList.contains('active')) {
    renderPerformance();
  }
  // Update wallet mini chart if visible
  var walletPanel = document.querySelector('[data-tab-panel="wallet"]');
  if (walletPanel && walletPanel.classList.contains('active')) {
    drawWalletMiniChart();
  }
}

function onLoadTrades(data) {
  var trades = data.trades || [];
  state.trades = trades;
  renderTrades();
  // Recalcula performance com dados atualizados
  var perfPanel = document.querySelector('[data-tab-panel="performance"]');
  if (perfPanel) renderPerformance();
}

function onTradeError(data) {
  var banner = document.getElementById('trade-error-banner');
  if (!banner) return;
  banner.textContent = data.message || 'Erro desconhecido no trade';
  banner.style.display = 'block';
  // Auto-hide apos 15s
  setTimeout(function() { banner.style.display = 'none'; }, 15000);
}

function onConnectionStatus(data) {
  state.connected = data.connected;
  state.testnet = data.testnet;
  var dot = document.getElementById('conn-dot');
  var text = document.getElementById('conn-text');
  var badge = document.getElementById('net-badge');

  if (data.connected) {
    dot.className = 'status-dot online';
    text.textContent = 'Conectado';
  } else if (data.authOK === false && data.connected === false) {
    dot.className = 'status-dot offline';
    text.textContent = 'API Key Invalida';
    text.style.color = 'var(--red)';
  } else {
    dot.className = 'status-dot offline';
    text.textContent = 'Desconectado';
    text.style.color = '';
  }

  if (data.testnet) {
    badge.style.display = 'inline-block';
    badge.className = 'badge badge-testnet';
    badge.textContent = 'TESTNET';
  } else if (data.connected) {
    badge.style.display = 'inline-block';
    badge.className = 'badge badge-mainnet';
    badge.textContent = 'MAINNET';
  } else {
    badge.style.display = 'none';
  }
}

function onBotStatus(data) {
  state.botRunning = data.running;
  var dot = document.getElementById('bot-dot');
  var text = document.getElementById('bot-status-text');
  var btnStart = document.getElementById('btn-start-bot');
  var btnStop = document.getElementById('btn-stop-bot');

  if (data.running) {
    dot.className = 'status-dot online';
    text.textContent = 'Bot rodando';
    btnStart.disabled = true;
    btnStop.disabled = false;
  } else {
    dot.className = 'status-dot offline';
    text.textContent = 'Bot parado';
    btnStart.disabled = false;
    btnStop.disabled = true;
  }
}

function onAnalyzing(data) {
  state.analyzing = data.active;
  var btn = document.getElementById('btn-analyze');
  if (data.active) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Analisando...';
  } else {
    btn.disabled = false;
    btn.innerHTML = '&#x1F9E0; Analisar com IA';
  }
}

function onLoadConfig(data) {
  setInputVal('cfg-apiKeyTest', data.apiKeyTest);
  setInputVal('cfg-secretKeyTest', data.secretKeyTest);
  setInputVal('cfg-apiKeyProd', data.apiKeyProd);
  setInputVal('cfg-secretKeyProd', data.secretKeyProd);
  setToggle('cfg-testnet', data.testnet);
  setInputVal('cfg-aiKey', data.aiKey);
  // Set AI model: check if it's a known option, else use custom
  var aiModelSel = document.getElementById('cfg-aiModel');
  var modelFound = false;
  if (aiModelSel && data.aiModel) {
    for (var i = 0; i < aiModelSel.options.length; i++) {
      if (aiModelSel.options[i].value === data.aiModel) { modelFound = true; break; }
    }
    if (modelFound) {
      aiModelSel.value = data.aiModel;
    } else {
      aiModelSel.value = 'custom';
      setInputVal('cfg-aiModelCustom', data.aiModel);
    }
  }
  setInputVal('cfg-aiBaseURL', data.aiBaseURL);
  setInputVal('cfg-aiCacheMins', data.aiCacheMins ?? 15);
  // Restaura keys por provedor
  if (!state.aiKeys) state.aiKeys = {};
  state.aiKeys.openai = data.aiKeyOpenai || '';
  state.aiKeys.groq = data.aiKeyGroq || '';
  state.aiKeys.mistral = data.aiKeyMistral || '';
  state.aiKeys.cerebras = data.aiKeyCerebras || '';
  state.aiKeys.deepseek = data.aiKeyDeepseek || '';
  var visionChk = document.getElementById('cfg-aiVision');
  if (visionChk) visionChk.checked = !!data.aiVision;
  onAIModelChange();
  highlightAIPreset(detectAIProvider());
  setInputVal('cfg-tradeAmount', data.tradeAmount);
  setInputVal('cfg-trailingStop', data.trailingStop);
  setInputVal('cfg-takeProfit', data.takeProfit);
  setInputVal('cfg-minConfidence', data.minConfidence);
  setInputVal('cfg-minScore', data.minScore);
  setInputVal('cfg-botInterval', data.botInterval);
  setInputVal('cfg-recoveryHours', data.recoveryHours);
  setInputVal('cfg-topCoins', data.topCoins);
  setInputVal('cfg-lateralTimeout', data.lateralTimeout);
  setInputVal('cfg-tradeCooldown', data.tradeCooldown);
  setInputVal('cfg-snapshotInterval', data.snapshotInterval);
  setToggle('cfg-autoTrade', data.autoTrade);
  setToggle('cfg-dcaEnabled', data.dcaEnabled);
  setInputVal('cfg-dcaMax', data.dcaMax);
  setInputVal('cfg-dcaLevel1', data.dcaLevel1);
  setInputVal('cfg-dcaLevel2', data.dcaLevel2);
  setInputVal('cfg-dcaLevel3', data.dcaLevel3);
  setToggle('cfg-telegramEnabled', data.telegramEnabled);
  setInputVal('cfg-telegramToken', data.telegramToken);
  setInputVal('cfg-telegramChatId', data.telegramChatId);
  setInputVal('cfg-interval', data.interval);
  // Scan mode
  var selMode = document.getElementById('cfg-scanMode');
  if (selMode && data.scanMode) selMode.value = data.scanMode;
  state.scanMode = data.scanMode || 'recovery';
  state.recoveryHours = parseInt(data.recoveryHours) || 24;
  updateApiKeyVisibility();
  updateScanModeUI();
  updateRecoveryLabel();
}

function updateScanModeUI() {
  var mode = (document.getElementById('cfg-scanMode') || {}).value || 'recovery';
  state.scanMode = mode;
  var grp = document.getElementById('group-recoveryHours');
  if (grp) grp.style.display = (mode === 'recovery') ? '' : 'none';
  updateRecoveryLabel();
}

function updateRecoveryLabel() {
  var mode = state.scanMode || 'recovery';
  var th = document.getElementById('th-variation');
  var title = document.getElementById('scanner-title');

  var labels = {
    'multi':     { col: 'Confluencias', title: '&#x1F529; Multi-Scan (Confluencia)' },
    'recovery':  { col: 'Variacao', title: '&#x1F3C6; Top Recovery Coins' },
    'volume':    { col: 'Variacao 24h', title: '&#x1F4CA; Top Coins por Volume' },
    'rsi':       { col: 'RSI', title: '&#x1F534; RSI Extremos' },
    'breakout':  { col: 'Squeeze %', title: '&#x1F4A5; Breakout (Bollinger)' },
    'macd':      { col: 'MACD Forca', title: '&#x1F504; MACD Crossover' },
    'momentum':  { col: 'Score', title: '&#x1F680; Momentum' },
    'flashdip':  { col: 'Queda 1h', title: '&#x26A1; Flash Dip' },
    'aiselect':  { col: 'Variacao 24h', title: '&#x1F916; AI Select (Sentiment)' }
  };
  var cfg = labels[mode] || labels['recovery'];

  if (mode === 'recovery') {
    var h = state.recoveryHours || 24;
    var p;
    if (h < 24) p = h + 'h'; else { var d = Math.floor(h / 24); p = d + 'd'; }
    cfg.col = 'Variacao ' + p;
    cfg.title = cfg.title + ' (' + p + ')';
  }

  if (th) th.textContent = cfg.col;
  if (title) title.innerHTML = cfg.title;
}

function updateApiKeyVisibility() {
  var isTestnet = getToggle('cfg-testnet');
  var testGrp = document.getElementById('keys-testnet-group');
  var prodGrp = document.getElementById('keys-prod-group');
  var label = document.getElementById('cfg-mode-label');
  if (isTestnet) {
    testGrp.style.opacity = '1';
    prodGrp.style.opacity = '0.4';
    if (label) label.textContent = 'Testnet (rede de teste)';
  } else {
    testGrp.style.opacity = '0.4';
    prodGrp.style.opacity = '1';
    if (label) label.textContent = 'Producao (dinheiro real!)';
    if (label) label.style.color = '#f6465d';
  }
  if (isTestnet) { if (label) label.style.color = 'var(--text-muted)'; }
}

function onScanProgress(data) {
  document.getElementById('scan-progress-bar').textContent = data.message || '';
}

function onSelectedCoin(data) {
  selectCoinUI(data.symbol);
}

// =====================================================================
// ACTIONS: JS -> DELPHI
// =====================================================================
function doScan() {
  document.getElementById('scan-progress-bar').textContent = 'Escaneando...';
  sendToDelphi('scanNow');
}

function doSelectCoin(symbol) {
  sendToDelphi('selectCoin', { symbol: symbol });
  selectCoinUI(symbol);
}

function doAnalyze() {
  if (!state.selectedCoin) return;
  sendToDelphi('analyze');
}

function doBuy() {
  var amount = document.getElementById('trade-amount').value;
  if (!amount || parseFloat(amount) <= 0) return;
  sendToDelphi('buy', { amount: parseFloat(amount) });
}

function doSell() {
  var amount = document.getElementById('trade-amount').value;
  if (!amount || parseFloat(amount) <= 0) return;
  sendToDelphi('sell', { amount: parseFloat(amount) });
}

function doRegisterPosition() {
  var sym = state.selectedCoin;
  if (!sym) { alert('Selecione uma moeda primeiro'); return; }
  if (!confirm('Registrar posicao para ' + sym + '?\n\nO bot vai buscar seu saldo atual e preco, e registrar como posicao aberta para monitoramento (stop loss, take profit, IA).')) return;
  sendToDelphi('registerPosition', { symbol: sym });
}

function sendChartToTelegram() {
  if (!state.selectedCoin) { alert('Selecione uma moeda primeiro'); return; }
  sendToDelphi('sendChartTelegram', { symbol: state.selectedCoin });
}

function doStartBot() {
  sendToDelphi('startBot');
}

function doStopBot() {
  sendToDelphi('stopBot');
}

function doTestConnection() {
  sendToDelphi('testConnection');
}

// =====================================================================
// GENETIC ALGORITHM OPTIMIZER
// =====================================================================
var gaLastResult = null;

function doStartOptimize() {
  document.getElementById('ga-progress-area').style.display = 'block';
  document.getElementById('btn-start-ga').style.display = 'none';
  document.getElementById('btn-cancel-ga').style.display = '';
  document.getElementById('ga-results-card').style.display = 'none';
  document.getElementById('ga-progress-msg').textContent = 'Iniciando...';
  document.getElementById('ga-progress-pct').textContent = '0%';
  document.getElementById('ga-progress-fill').style.width = '0%';
  document.getElementById('ga-status').textContent = 'Executando...';
  document.getElementById('ga-status').style.color = 'var(--accent)';
  sendToDelphi('startOptimize');
}

function doCancelOptimize() {
  sendToDelphi('cancelOptimize');
  document.getElementById('ga-status').textContent = 'Cancelando...';
}

function onOptimizeProgress(data) {
  var status = data.status || '';
  var pct = parseFloat(data.progress) || 0;
  var msg = data.message || '';

  document.getElementById('ga-progress-msg').textContent = msg;
  document.getElementById('ga-progress-pct').textContent = Math.round(pct) + '%';
  document.getElementById('ga-progress-fill').style.width = pct + '%';

  if (status === 'cancelled' || status === 'error') {
    document.getElementById('btn-start-ga').style.display = '';
    document.getElementById('btn-cancel-ga').style.display = 'none';
    document.getElementById('ga-status').textContent = status === 'error' ? 'Erro: ' + msg : 'Cancelado';
    document.getElementById('ga-status').style.color = 'var(--red)';
    setTimeout(function() {
      document.getElementById('ga-progress-area').style.display = 'none';
    }, 4000);
  }
}

function onOptimizeResult(data) {
  gaLastResult = data;
  document.getElementById('ga-progress-area').style.display = 'none';
  document.getElementById('btn-start-ga').style.display = '';
  document.getElementById('btn-cancel-ga').style.display = 'none';
  document.getElementById('ga-results-card').style.display = '';
  document.getElementById('ga-status').textContent = 'Concluido';
  document.getElementById('ga-status').style.color = 'var(--green)';

  var np = parseFloat(data.netProfit) || 0;
  document.getElementById('ga-net-profit').textContent = np.toFixed(2) + '%';
  document.getElementById('ga-net-profit').style.color = np >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('ga-num-trades').textContent = data.numTrades || 0;
  document.getElementById('ga-max-dd').textContent = (parseFloat(data.maxDrawdown) || 0).toFixed(2) + '%';
  document.getElementById('ga-win-rate').textContent = (parseFloat(data.winRate) || 0).toFixed(1) + '%';
  document.getElementById('ga-fitness').textContent = (parseFloat(data.fitness) || 0).toFixed(1);
  document.getElementById('ga-symbols-used').textContent = data.symbolsUsed || 0;

  document.getElementById('ga-param-sl').textContent = (parseFloat(data.stopLoss) || 0).toFixed(1);
  document.getElementById('ga-param-tp').textContent = (parseFloat(data.takeProfit) || 0).toFixed(1);
  document.getElementById('ga-param-ms').textContent = Math.round(parseFloat(data.minScore) || 0);
  document.getElementById('ga-param-rsi-os').textContent = Math.round(parseFloat(data.rsiOversold) || 30);
  document.getElementById('ga-param-rsi-ob').textContent = Math.round(parseFloat(data.rsiOverbought) || 70);
  document.getElementById('ga-param-wrsi').textContent = (parseFloat(data.wRSI) || 0).toFixed(1);
  document.getElementById('ga-param-wmacdh').textContent = (parseFloat(data.wMACDHist) || 0).toFixed(1);
  document.getElementById('ga-param-wmacds').textContent = (parseFloat(data.wMACDSignal) || 0).toFixed(1);
  document.getElementById('ga-param-wpsma').textContent = (parseFloat(data.wPriceSMA) || 0).toFixed(1);
  document.getElementById('ga-param-wsmat').textContent = (parseFloat(data.wSMATrend) || 0).toFixed(1);
  document.getElementById('ga-param-wboll').textContent = (parseFloat(data.wBollinger) || 0).toFixed(1);
}

function doApplyOptimizedParams() {
  if (!gaLastResult) return;
  sendToDelphi('applyOptimizedParams', {
    stopLoss: gaLastResult.stopLoss,
    takeProfit: gaLastResult.takeProfit,
    minScore: gaLastResult.minScore
  });
}

function onOptimizeApplied(data) {
  var slEl = document.getElementById('cfg-trailingStop');
  var tpEl = document.getElementById('cfg-takeProfit');
  var msEl = document.getElementById('cfg-minScore');
  if (slEl) slEl.value = data.trailingStop || '';
  if (tpEl) tpEl.value = data.takeProfit || '';
  if (msEl) msEl.value = data.minScore || '';
  document.getElementById('ga-status').textContent = 'Parametros aplicados!';
  document.getElementById('ga-status').style.color = 'var(--green)';
}

function doTestAI() {
  var btn = document.getElementById('btn-test-ai');
  var res = document.getElementById('ai-test-result');
  btn.disabled = true;
  btn.textContent = 'Testando...';
  res.textContent = 'Aguardando resposta...';
  res.style.color = 'var(--text-muted)';
  sendToDelphi('testAI', {
    aiKey: getInputVal('cfg-aiKey'),
    aiModel: getEffectiveAIModel(),
    aiBaseURL: getInputVal('cfg-aiBaseURL')
  });
}

function onAIStats(data) {
  var bar = document.getElementById('ai-stats-bar');
  if (!bar) return;
  bar.style.display = '';
  document.getElementById('ai-st-calls').textContent = data.calls || 0;
  var avg = data.avgTimeSec || 0;
  document.getElementById('ai-st-avg').textContent = avg.toFixed(1) + 's';
  document.getElementById('ai-st-tkin').textContent = formatTokens(data.tokensIn || 0);
  document.getElementById('ai-st-tkout').textContent = formatTokens(data.tokensOut || 0);
  var cavg = data.costAvg || 0;
  var ctotal = data.costTotal || 0;
  document.getElementById('ai-st-cavg').textContent = '$' + cavg.toFixed(6);
  document.getElementById('ai-st-ctotal').textContent = '$' + ctotal.toFixed(4);
}
function formatTokens(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toString();
}

function onTestAIResult(data) {
  var btn = document.getElementById('btn-test-ai');
  var res = document.getElementById('ai-test-result');
  btn.disabled = false;
  btn.textContent = 'Testar Conexao IA';
  if (data.success) {
    res.textContent = 'OK! ' + (data.message || '');
    res.style.color = 'var(--green)';
  } else {
    res.textContent = 'Falhou: ' + (data.message || 'Erro desconhecido');
    res.style.color = 'var(--red)';
  }
}

function isVisionModel(model) {
  var m = (model || '').toLowerCase();
  return m.indexOf('vl') >= 0 || m.indexOf('vision') >= 0 ||
         m.indexOf('gpt-4o') >= 0 || m.indexOf('gemini') >= 0;
}

function onAIModelChange() {
  var sel = document.getElementById('cfg-aiModel');
  var val = sel.value;
  var customGrp = document.getElementById('ai-custom-model-group');
  var badge = document.getElementById('ai-vision-badge');
  var info = document.getElementById('ai-vision-info');
  var visionChk = document.getElementById('cfg-aiVision');
  customGrp.style.display = val === 'custom' ? '' : 'none';
  var modelName = val === 'custom' ? getInputVal('cfg-aiModelCustom') : val;
  var supportsVision = isVisionModel(modelName);
  var visionEnabled = visionChk && visionChk.checked;
  badge.style.display = (supportsVision && visionEnabled) ? '' : 'none';
  info.style.display = visionEnabled ? '' : 'none';
}

function highlightAIPreset(preset) {
  document.querySelectorAll('.ai-preset-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-preset') === preset);
  });
}

// Detecta provedor atual pela baseURL
function detectAIProvider() {
  var url = getInputVal('cfg-aiBaseURL').toLowerCase();
  if (url.indexOf('groq.com') >= 0) return 'groq';
  if (url.indexOf('mistral.ai') >= 0) return 'mistral';
  if (url.indexOf('cerebras.ai') >= 0) return 'cerebras';
  if (url.indexOf('deepseek.com') >= 0) return 'deepseek';
  if (url.indexOf('localhost') >= 0 || url.indexOf('127.0.0.1') >= 0) return 'local';
  return 'openai';
}

// Salva key atual no slot do provedor detectado
function saveCurrentAIKey() {
  var prov = detectAIProvider();
  var key = getInputVal('cfg-aiKey');
  if (key && key !== 'lm-studio' && key !== 'ollama') {
    if (!state.aiKeys) state.aiKeys = {};
    state.aiKeys[prov] = key;
  }
}

function applyAIPreset(preset) {
  var sel = document.getElementById('cfg-aiModel');
  var url = document.getElementById('cfg-aiBaseURL');
  var key = document.getElementById('cfg-aiKey');
  if (!state.aiKeys) state.aiKeys = {};

  // Salva key do provedor atual antes de trocar
  saveCurrentAIKey();

  switch (preset) {
    case 'openai':
      sel.value = 'gpt-4o-mini';
      url.value = 'https://api.openai.com/v1';
      key.value = state.aiKeys.openai || '';
      key.placeholder = 'sk-...';
      break;
    case 'groq':
      sel.value = 'llama-3.1-8b-instant';
      url.value = 'https://api.groq.com/openai/v1';
      key.value = state.aiKeys.groq || '';
      key.placeholder = 'gsk_...';
      break;
    case 'mistral':
      sel.value = 'mistral-small-latest';
      url.value = 'https://api.mistral.ai/v1';
      key.value = state.aiKeys.mistral || '';
      key.placeholder = 'api key mistral...';
      break;
    case 'cerebras':
      sel.value = 'llama-3.3-70b';
      url.value = 'https://api.cerebras.ai/v1';
      key.value = state.aiKeys.cerebras || '';
      key.placeholder = 'csk-...';
      break;
    case 'deepseek':
      sel.value = 'deepseek-chat';
      url.value = 'https://api.deepseek.com/v1';
      key.value = state.aiKeys.deepseek || '';
      key.placeholder = 'sk-...';
      break;
    case 'lmstudio':
      sel.value = 'qwen3-vl-8b';
      url.value = 'http://localhost:1234/v1';
      key.value = 'lm-studio';
      break;
    case 'ollama':
      sel.value = 'custom';
      document.getElementById('cfg-aiModelCustom').value = 'qwen3:8b';
      url.value = 'http://localhost:11434/v1';
      key.value = 'ollama';
      break;
  }
  onAIModelChange();
  highlightAIPreset(preset);
}

function getEffectiveAIModel() {
  var sel = document.getElementById('cfg-aiModel');
  if (sel.value === 'custom') return getInputVal('cfg-aiModelCustom');
  return sel.value;
}

function doSaveConfig() {
  // Salva key atual no slot do provedor antes de gravar
  saveCurrentAIKey();
  if (!state.aiKeys) state.aiKeys = {};
  var cfg = {
    apiKeyTest: getInputVal('cfg-apiKeyTest'),
    secretKeyTest: getInputVal('cfg-secretKeyTest'),
    apiKeyProd: getInputVal('cfg-apiKeyProd'),
    secretKeyProd: getInputVal('cfg-secretKeyProd'),
    testnet: getToggle('cfg-testnet'),
    aiKey: getInputVal('cfg-aiKey'),
    aiModel: getEffectiveAIModel(),
    aiVision: document.getElementById('cfg-aiVision').checked,
    aiBaseURL: getInputVal('cfg-aiBaseURL'),
    aiCacheMins: intVal(getInputVal('cfg-aiCacheMins'), 15),
    aiKeyOpenai: state.aiKeys.openai || '',
    aiKeyGroq: state.aiKeys.groq || '',
    aiKeyMistral: state.aiKeys.mistral || '',
    aiKeyCerebras: state.aiKeys.cerebras || '',
    aiKeyDeepseek: state.aiKeys.deepseek || '',
    tradeAmount: numVal(getInputVal('cfg-tradeAmount'), 10),
    trailingStop: numVal(getInputVal('cfg-trailingStop'), 3),
    takeProfit: numVal(getInputVal('cfg-takeProfit'), 3),
    minConfidence: numVal(getInputVal('cfg-minConfidence'), 70),
    minScore: intVal(getInputVal('cfg-minScore'), 25),
    botInterval: intVal(getInputVal('cfg-botInterval'), 60),
    scanMode: (document.getElementById('cfg-scanMode') || {}).value || 'recovery',
    recoveryHours: intVal(getInputVal('cfg-recoveryHours'), 24),
    topCoins: intVal(getInputVal('cfg-topCoins'), 30),
    lateralTimeout: intVal(getInputVal('cfg-lateralTimeout'), 24),
    tradeCooldown: intVal(getInputVal('cfg-tradeCooldown'), 30),
    snapshotInterval: intVal(getInputVal('cfg-snapshotInterval'), 30),
    autoTrade: getToggle('cfg-autoTrade'),
    interval: getInputVal('cfg-interval'),
    dcaEnabled: getToggle('cfg-dcaEnabled'),
    dcaMax: intVal(getInputVal('cfg-dcaMax'), 3),
    dcaLevel1: numVal(getInputVal('cfg-dcaLevel1'), 3),
    dcaLevel2: numVal(getInputVal('cfg-dcaLevel2'), 5),
    dcaLevel3: numVal(getInputVal('cfg-dcaLevel3'), 8),
    telegramEnabled: getToggle('cfg-telegramEnabled'),
    telegramToken: getInputVal('cfg-telegramToken'),
    telegramChatId: getInputVal('cfg-telegramChatId')
  };
  state.scanMode = cfg.scanMode;
  state.recoveryHours = cfg.recoveryHours;
  updateScanModeUI();
  sendToDelphi('saveConfig', cfg);
}

function doTestTelegram() {
  doSaveConfig();
  setTimeout(function() { sendToDelphi('testTelegram', {}); }, 500);
}

function toggleAutoTrade() {
  var el = document.getElementById('toggle-autotrade');
  var isActive = el.classList.toggle('active');
  state.autoTrade = isActive;
  document.getElementById('autotrade-warning').style.display = isActive ? 'block' : 'none';
}

function toggleConfigSwitch(id) {
  document.getElementById(id).classList.toggle('active');
}

// =====================================================================
// UI RENDERING: COINS TABLE
// =====================================================================
function selectCoinUI(symbol) {
  state.selectedCoin = symbol;
  state.candles = [];
  state.indicators = {};
  state.signal = null;

  document.getElementById('no-coin-selected').style.display = 'none';
  document.getElementById('coin-detail').style.display = 'block';
  document.getElementById('detail-symbol').textContent = symbol;
  document.getElementById('detail-price').textContent = '--';
  document.getElementById('detail-change').textContent = '';
  document.getElementById('detail-change').className = 'coin-change';

  document.getElementById('trade-selected-coin').textContent = symbol;
  document.getElementById('trade-selected-price').textContent = '--';

  var coin = null;
  for (var i = 0; i < state.coins.length; i++) {
    if (state.coins[i].symbol === symbol) { coin = state.coins[i]; break; }
  }
  if (coin) {
    document.getElementById('detail-price').textContent = formatPrice(coin.price);
    var pct = parseFloat(coin.changePercent) || 0;
    var changeClass = pct >= 0 ? 'positive' : 'negative';
    var changePrefix = pct >= 0 ? '+' : '';
    document.getElementById('detail-change').textContent = changePrefix + pct.toFixed(2) + '%';
    document.getElementById('detail-change').className = 'coin-change ' + changeClass;
    document.getElementById('trade-selected-price').textContent = formatPrice(coin.price) + ' USDT';
  }

  renderIndicators();
  renderSignal();
  drawChart();
  renderCoinsTable();
}

function renderCoinsTable() {
  var tbody = document.getElementById('coins-tbody');
  if (state.coins.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="placeholder-text">Clique em "Scan Now" para buscar moedas.</td></tr>';
    return;
  }

  var mode = state.scanMode || 'recovery';
  var html = '';
  for (var i = 0; i < state.coins.length; i++) {
    var coin = state.coins[i];
    var isSelected = coin.symbol === state.selectedCoin;
    var metric = parseFloat(coin.scanMetric) || 0;
    var change = parseFloat(coin.changePercent) || 0;
    var metricText, metricClass;

    if (mode === 'rsi') {
      metricClass = metric < 30 ? 'positive' : (metric > 70 ? 'negative' : '');
      metricText = metric.toFixed(1);
    } else if (mode === 'breakout') {
      metricClass = 'positive';
      metricText = metric.toFixed(2) + '%';
    } else if (mode === 'macd') {
      metricClass = metric >= 0 ? 'positive' : 'negative';
      metricText = metric.toFixed(6);
    } else if (mode === 'momentum') {
      metricClass = metric >= 70 ? 'positive' : (metric < 50 ? 'negative' : '');
      metricText = metric.toFixed(0) + ' pts';
    } else if (mode === 'flashdip') {
      metricClass = 'negative';
      metricText = change.toFixed(2) + '%';
    } else {
      // recovery, volume, aiselect
      metricClass = change >= 0 ? 'positive' : 'negative';
      metricText = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
    }

    var rowClass = isSelected ? 'selected-row' : '';

    html += '<tr class="' + rowClass + '" onclick="doSelectCoin(\'' + escapeAttr(coin.symbol) + '\')">';
    html += '<td>' + (i + 1) + '</td>';
    html += '<td style="font-weight:600;color:var(--accent);">' + escapeHtml(formatSymbol(coin.symbol)) + '</td>';
    html += '<td>' + formatPrice(coin.price) + '</td>';
    html += '<td class="' + metricClass + '">' + metricText + '</td>';
    html += '<td>' + formatVolume(coin.quoteVolume || coin.volume) + '</td>';
    html += '<td><button class="btn btn-accent btn-sm" onclick="event.stopPropagation();doSelectCoin(\'' + escapeAttr(coin.symbol) + '\')">Selecionar</button></td>';
    html += '</tr>';
  }

  tbody.innerHTML = html;
}

// =====================================================================
// UI RENDERING: INDICATORS
// =====================================================================
function renderIndicators() {
  var d = state.indicators;
  setElText('ind-rsi', d.rsi != null ? parseFloat(d.rsi).toFixed(2) : '--');
  setElText('ind-macd', d.macd != null ? parseFloat(d.macd).toFixed(6) : '--');
  setElText('ind-sma20', d.sma20 != null ? formatPrice(d.sma20) : '--');
  setElText('ind-sma50', d.sma50 != null ? formatPrice(d.sma50) : '--');
  setElText('ind-boll-up', d.bollingerUpper != null ? formatPrice(d.bollingerUpper) : '--');
  setElText('ind-boll-low', d.bollingerLower != null ? formatPrice(d.bollingerLower) : '--');
  setElText('ind-ema12', d.ema12 != null ? formatPrice(d.ema12) : '--');
  setElText('ind-atr', d.atr != null ? parseFloat(d.atr).toFixed(6) : '--');

  var rsiEl = document.getElementById('ind-rsi');
  if (d.rsi != null) {
    var rsi = parseFloat(d.rsi);
    if (rsi < 30) rsiEl.style.color = 'var(--green)';
    else if (rsi > 70) rsiEl.style.color = 'var(--red)';
    else rsiEl.style.color = 'var(--text)';
  } else {
    rsiEl.style.color = 'var(--text)';
  }

  var macdEl = document.getElementById('ind-macd');
  if (d.macd != null) {
    macdEl.style.color = parseFloat(d.macd) >= 0 ? 'var(--green)' : 'var(--red)';
  } else {
    macdEl.style.color = 'var(--text)';
  }
}

// =====================================================================
// UI RENDERING: SIGNAL
// =====================================================================
function renderSignal() {
  var container = document.getElementById('signal-content');
  var card = document.getElementById('signal-card');
  var s = state.signal;

  card.className = 'card signal-card';

  if (!s || !s.signal) {
    container.innerHTML = '<div class="placeholder-text">Clique em "Analisar com IA" para gerar sinal.</div>';
    return;
  }

  card.classList.add(s.signal);

  var confidence = parseFloat(s.confidence) || 0;
  var barColor = 'var(--accent)';
  if (s.signal === 'STRONG_BUY' || s.signal === 'BUY') barColor = 'var(--green)';
  else if (s.signal === 'SELL' || s.signal === 'STRONG_SELL') barColor = 'var(--red)';

  var signalLabels = {
    'STRONG_BUY': '&#x1F7E2; COMPRA FORTE',
    'BUY': '&#x1F7E2; COMPRA',
    'HOLD': '&#x1F7E1; MANTER',
    'SELL': '&#x1F534; VENDA',
    'STRONG_SELL': '&#x1F534; VENDA FORTE'
  };

  var html = '';
  html += '<div class="signal-name ' + s.signal + '">' + (signalLabels[s.signal] || s.signal) + '</div>';
  html += '<div style="font-size:12px;color:var(--text-muted);">Confianca: ' + confidence.toFixed(1) + '%</div>';
  html += '<div class="confidence-bar-bg"><div class="confidence-bar-fill" style="width:' + confidence + '%;background:' + barColor + ';"></div></div>';

  if (s.reasoning) {
    html += '<div class="signal-reasoning">"' + escapeHtml(s.reasoning) + '"</div>';
  }

  html += '<div class="signal-prices">';
  html += '<div class="signal-price-item"><div class="signal-price-label">&#x1F3AF; Entrada</div><div class="signal-price-value">' + formatPrice(s.entry) + '</div></div>';
  html += '<div class="signal-price-item"><div class="signal-price-label">&#x1F6D1; Stop Loss</div><div class="signal-price-value" style="color:var(--red);">' + formatPrice(s.stopLoss) + '</div></div>';
  html += '<div class="signal-price-item"><div class="signal-price-label">&#x1F3C6; Take Profit</div><div class="signal-price-value" style="color:var(--green);">' + formatPrice(s.takeProfit) + '</div></div>';
  html += '</div>';

  container.innerHTML = html;
}

// =====================================================================
// UI RENDERING: BALANCE
// =====================================================================
function renderBalance() {
  var b = state.balance;
  setElText('bal-base-asset', b.baseAsset || '--');
  setElText('bal-quote-asset', b.quoteAsset || 'USDT');
  setElText('bal-base-free', formatNum(b.baseFree));
  setElText('bal-base-locked', formatNum(b.baseLocked));
  setElText('bal-quote-free', formatNum(b.quoteFree));
  setElText('bal-quote-locked', formatNum(b.quoteLocked));
}

// =====================================================================
// UI RENDERING: TRADES
// =====================================================================
function formatDateTime(date) {
  if (!date || isNaN(date.getTime())) return '--';
  var dd = String(date.getDate()).padStart(2, '0');
  var mm = String(date.getMonth() + 1).padStart(2, '0');
  var yy = String(date.getFullYear());
  var h = String(date.getHours()).padStart(2, '0');
  var m = String(date.getMinutes()).padStart(2, '0');
  var s = String(date.getSeconds()).padStart(2, '0');
  return dd + '/' + mm + '/' + yy + ' ' + h + ':' + m + ':' + s;
}

function renderTrades() {
  var tbody = document.getElementById('trades-tbody');
  if (state.trades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="placeholder-text">Nenhum trade registrado.</td></tr>';
    return;
  }

  // Ordena por data descendente (mais recente primeiro)
  var sorted = state.trades.slice().sort(function(a, b) {
    return parseTradeTimestamp(b.timestamp) - parseTradeTimestamp(a.timestamp);
  });

  var html = '';
  for (var i = 0; i < sorted.length; i++) {
    var t = sorted[i];
    var sideClass = t.side === 'BUY' ? 'positive' : 'negative';
    var sideLabel = t.side === 'BUY' ? 'Compra' : 'Venda';
    var time = t.timestamp ? formatDateTime(parseTradeTimestamp(t.timestamp)) : '--';

    html += '<tr>';
    html += '<td style="font-size:11px;">' + escapeHtml(time) + '</td>';
    html += '<td style="font-weight:600;">' + escapeHtml(formatSymbol(t.symbol)) + '</td>';
    html += '<td class="' + sideClass + '">' + sideLabel + '</td>';
    html += '<td>' + formatPrice(t.price) + '</td>';
    html += '<td>' + formatQty(t.quantity) + '</td>';
    html += '<td>' + escapeHtml(t.signal || '--') + ' (' + (t.confidence != null ? parseFloat(t.confidence).toFixed(0) + '%' : '--') + ')</td>';
    html += '</tr>';
  }

  tbody.innerHTML = html;
}

// =====================================================================
// LOG
// =====================================================================
var _logPaused = false;
var _logBuffer = [];

function appendLog(tag, message, time) {
  var timeStr = time || formatTime(new Date());

  if (_logPaused) {
    _logBuffer.push({ tag: tag, message: message, time: timeStr });
    var countEl = document.getElementById('log-pause-count');
    if (countEl) {
      countEl.style.display = '';
      countEl.textContent = _logBuffer.length + ' pendente' + (_logBuffer.length !== 1 ? 's' : '');
    }
    return;
  }

  _appendLogEntry(tag, message, timeStr);
}

function _appendLogEntry(tag, message, timeStr) {
  var container = document.getElementById('log-container');
  var entry = document.createElement('div');
  entry.className = 'log-entry';

  var tagLower = (tag || 'system').toLowerCase();

  entry.innerHTML =
    '<span class="log-time">' + escapeHtml(timeStr) + '</span>' +
    '<span class="log-tag ' + escapeAttr(tagLower) + '">' + escapeHtml(tag || 'SYSTEM') + '</span>' +
    '<span class="log-message">' + escapeHtml(message || '') + '</span>';

  var isNearBottom = (container.scrollHeight - container.scrollTop - container.clientHeight) < 60;
  container.appendChild(entry);
  if (isNearBottom) {
    container.scrollTop = container.scrollHeight;
  }

  while (container.children.length > 500) {
    container.removeChild(container.firstChild);
  }
}

function toggleLogPause() {
  _logPaused = !_logPaused;
  var btn = document.getElementById('log-pause-btn');
  var countEl = document.getElementById('log-pause-count');

  if (_logPaused) {
    btn.innerHTML = '&#x25B6; Retomar';
    btn.style.borderColor = 'var(--accent)';
    btn.style.color = 'var(--accent)';
  } else {
    // Flush buffer
    for (var i = 0; i < _logBuffer.length; i++) {
      _appendLogEntry(_logBuffer[i].tag, _logBuffer[i].message, _logBuffer[i].time);
    }
    _logBuffer = [];
    btn.innerHTML = '&#x23F8; Pausar';
    btn.style.borderColor = '';
    btn.style.color = '';
    if (countEl) countEl.style.display = 'none';
    // Scroll to bottom after flush
    var container = document.getElementById('log-container');
    container.scrollTop = container.scrollHeight;
  }
}

function clearLogs() {
  document.getElementById('log-container').innerHTML = '';
  _logBuffer = [];
  var countEl = document.getElementById('log-pause-count');
  if (countEl) countEl.style.display = 'none';
}

// =====================================================================
// CANDLESTICK CHART (Pure Canvas API)
// =====================================================================
var chartCanvas = document.getElementById('candle-chart');
var chartCtx = chartCanvas.getContext('2d');
var chartTooltipEl = document.getElementById('chart-tooltip');
var chartHoveredIndex = -1;

function drawChart() {
  var wrapper = document.getElementById('chart-wrapper');
  if (!wrapper) return;

  var dpr = window.devicePixelRatio || 1;
  var w = wrapper.clientWidth;
  var h = 300;

  if (w <= 0) return;

  chartCanvas.width = w * dpr;
  chartCanvas.height = h * dpr;
  chartCanvas.style.width = w + 'px';
  chartCanvas.style.height = h + 'px';
  chartCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // Background
  chartCtx.fillStyle = '#0b0e11';
  chartCtx.fillRect(0, 0, w, h);

  var candles = state.candles;
  if (!candles || candles.length === 0) {
    chartCtx.fillStyle = '#848e9c';
    chartCtx.font = '14px Segoe UI, sans-serif';
    chartCtx.textAlign = 'center';
    chartCtx.textBaseline = 'middle';
    chartCtx.fillText('Sem dados de candles', w / 2, h / 2);
    chartTooltipEl.style.display = 'none';
    return;
  }

  // Take last 50
  var displayCandles = candles.slice(-50);
  var numCandles = displayCandles.length;

  var paddingTop = 20;
  var paddingBottom = 24;
  var paddingLeft = 10;
  var paddingRight = 65;
  var chartWidth = w - paddingLeft - paddingRight;
  var chartHeight = h - paddingTop - paddingBottom;

  // Compute min/max
  var minPrice = Infinity;
  var maxPrice = -Infinity;
  for (var i = 0; i < numCandles; i++) {
    var lo = parseFloat(displayCandles[i].l);
    var hi = parseFloat(displayCandles[i].h);
    if (lo < minPrice) minPrice = lo;
    if (hi > maxPrice) maxPrice = hi;
  }

  var priceRange = maxPrice - minPrice;
  if (priceRange === 0) priceRange = maxPrice * 0.01 || 1;
  minPrice -= priceRange * 0.05;
  maxPrice += priceRange * 0.05;
  priceRange = maxPrice - minPrice;

  var candleFullWidth = chartWidth / numCandles;
  var candleBodyWidth = Math.max(1, Math.floor(candleFullWidth * 0.65));
  if (candleBodyWidth % 2 === 0) candleBodyWidth = Math.max(1, candleBodyWidth - 1);

  function priceToY(price) {
    return paddingTop + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
  }

  // Grid lines + price axis
  var numGridLines = 6;
  chartCtx.textAlign = 'left';
  chartCtx.textBaseline = 'middle';
  for (var g = 0; g <= numGridLines; g++) {
    var gy = paddingTop + (chartHeight / numGridLines) * g;
    var gridPrice = maxPrice - (priceRange / numGridLines) * g;

    // Grid line
    chartCtx.strokeStyle = 'rgba(43,49,57,0.5)';
    chartCtx.lineWidth = 0.5;
    chartCtx.beginPath();
    chartCtx.moveTo(paddingLeft, gy);
    chartCtx.lineTo(w - paddingRight, gy);
    chartCtx.stroke();

    // Price label
    chartCtx.fillStyle = '#848e9c';
    chartCtx.font = '10px Segoe UI, sans-serif';
    chartCtx.fillText(formatPriceAxis(gridPrice), w - paddingRight + 6, gy);
  }

  // Draw candles
  for (var ci = 0; ci < numCandles; ci++) {
    var candle = displayCandles[ci];
    var o = parseFloat(candle.o);
    var cHi = parseFloat(candle.h);
    var cLo = parseFloat(candle.l);
    var cl = parseFloat(candle.c);
    var isUp = cl >= o;
    var color = isUp ? '#0ecb81' : '#f6465d';

    var cx = paddingLeft + ci * candleFullWidth + candleFullWidth / 2;
    var yOpen = priceToY(o);
    var yClose = priceToY(cl);
    var yHigh = priceToY(cHi);
    var yLow = priceToY(cLo);

    // Wick (shadow line)
    chartCtx.strokeStyle = color;
    chartCtx.lineWidth = 1;
    chartCtx.beginPath();
    chartCtx.moveTo(Math.round(cx) + 0.5, Math.round(yHigh));
    chartCtx.lineTo(Math.round(cx) + 0.5, Math.round(yLow));
    chartCtx.stroke();

    // Body
    var bodyTop = Math.min(yOpen, yClose);
    var bodyH = Math.abs(yClose - yOpen);
    if (bodyH < 1) bodyH = 1;

    if (isUp) {
      // Green candle: filled body
      chartCtx.fillStyle = color;
      chartCtx.fillRect(
        Math.round(cx - candleBodyWidth / 2),
        Math.round(bodyTop),
        candleBodyWidth,
        Math.max(1, Math.round(bodyH))
      );
    } else {
      // Red candle: filled body
      chartCtx.fillStyle = color;
      chartCtx.fillRect(
        Math.round(cx - candleBodyWidth / 2),
        Math.round(bodyTop),
        candleBodyWidth,
        Math.max(1, Math.round(bodyH))
      );
    }

    // Hover highlight
    if (ci === chartHoveredIndex) {
      chartCtx.strokeStyle = 'rgba(240,185,11,0.4)';
      chartCtx.lineWidth = 1;
      chartCtx.setLineDash([3, 3]);
      chartCtx.beginPath();
      chartCtx.moveTo(Math.round(cx) + 0.5, paddingTop);
      chartCtx.lineTo(Math.round(cx) + 0.5, paddingTop + chartHeight);
      chartCtx.stroke();
      chartCtx.setLineDash([]);
    }
  }

  // Bottom axis
  chartCtx.strokeStyle = 'rgba(43,49,57,0.8)';
  chartCtx.lineWidth = 1;
  chartCtx.beginPath();
  chartCtx.moveTo(paddingLeft, paddingTop + chartHeight);
  chartCtx.lineTo(w - paddingRight, paddingTop + chartHeight);
  chartCtx.stroke();

  // Tooltip
  if (chartHoveredIndex >= 0 && chartHoveredIndex < numCandles) {
    var hc = displayCandles[chartHoveredIndex];
    var tDate = hc.t ? new Date(hc.t) : null;
    var dateStr = tDate ? tDate.toLocaleString('pt-BR') : '--';
    var hcClose = parseFloat(hc.c);
    var hcOpen = parseFloat(hc.o);
    var candleDir = hcClose >= hcOpen ? '&#x1F7E2;' : '&#x1F534;';

    chartTooltipEl.innerHTML =
      '<div style="margin-bottom:2px;">' + candleDir + ' <strong>' + escapeHtml(dateStr) + '</strong></div>' +
      '<div>Abertura: <strong>' + formatPriceAxis(parseFloat(hc.o)) + '</strong></div>' +
      '<div>Maxima: <strong>' + formatPriceAxis(parseFloat(hc.h)) + '</strong></div>' +
      '<div>Minima: <strong>' + formatPriceAxis(parseFloat(hc.l)) + '</strong></div>' +
      '<div>Fechamento: <strong>' + formatPriceAxis(parseFloat(hc.c)) + '</strong></div>' +
      '<div>Volume: <strong>' + formatVolume(hc.v) + '</strong></div>';
    chartTooltipEl.style.display = 'block';
  } else {
    chartTooltipEl.style.display = 'none';
  }
}

// Chart mouse events
chartCanvas.addEventListener('mousemove', function(e) {
  if (!state.candles || state.candles.length === 0) return;

  var rect = chartCanvas.getBoundingClientRect();
  var mx = e.clientX - rect.left;

  var wrapper = document.getElementById('chart-wrapper');
  var w = wrapper.clientWidth;
  var paddingLeft = 10;
  var paddingRight = 65;
  var chartWidth = w - paddingLeft - paddingRight;
  var displayCandles = state.candles.slice(-50);
  var numCandles = displayCandles.length;
  if (numCandles === 0) return;

  var candleFullWidth = chartWidth / numCandles;
  var idx = Math.floor((mx - paddingLeft) / candleFullWidth);

  if (idx < 0 || idx >= numCandles) {
    if (chartHoveredIndex !== -1) {
      chartHoveredIndex = -1;
      drawChart();
    }
    return;
  }

  if (idx !== chartHoveredIndex) {
    chartHoveredIndex = idx;
    drawChart();
  }
});

chartCanvas.addEventListener('mouseleave', function() {
  if (chartHoveredIndex !== -1) {
    chartHoveredIndex = -1;
    drawChart();
  }
});

window.addEventListener('resize', function() {
  drawChart();
  var perfPanel = document.querySelector('[data-tab-panel="performance"]');
  if (perfPanel && perfPanel.classList.contains('active')) {
    renderPerformance();
  }
  var walletPanel = document.querySelector('[data-tab-panel="wallet"]');
  if (walletPanel && walletPanel.classList.contains('active')) {
    drawWalletMiniChart();
  }
});

// =====================================================================
// UTILITY FUNCTIONS
// =====================================================================
var audioCtx = null;

// Inicializa AudioContext no primeiro clique do usuario (exigencia do navegador)
document.addEventListener('click', function() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}, { once: false });

function playTradeSound(side) {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
    var now = audioCtx.currentTime;

    if (side === 'BUY') {
      // Tom ascendente duplo (compra - positivo)
      [440, 660].forEach(function(freq, i) {
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.18, now + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.25);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now + i * 0.15);
        osc.stop(now + i * 0.15 + 0.25);
      });
    } else {
      // Tom descendente duplo (venda - alerta)
      [660, 440].forEach(function(freq, i) {
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.18, now + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.25);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now + i * 0.15);
        osc.stop(now + i * 0.15 + 0.25);
      });
    }
  } catch(e) { console.warn('Audio error:', e); }
}

function playErrorSound() {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    var now = audioCtx.currentTime;
    // 3 tons descendentes curtos (erro)
    [520, 400, 300].forEach(function(freq, i) {
      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.12, now + i * 0.12);
      gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.12 + 0.15);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(now + i * 0.12);
      osc.stop(now + i * 0.12 + 0.15);
    });
  } catch(e) { console.warn('Audio error:', e); }
}

function formatPrice(val) {
  if (val == null || val === '' || val === '--') return '--';
  var n = parseFloat(val);
  if (isNaN(n)) return '--';
  if (n >= 1000) return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  if (n >= 1) return n.toFixed(4);
  if (n >= 0.01) return n.toFixed(6);
  return n.toFixed(8);
}

function formatPriceAxis(val) {
  if (val == null) return '--';
  var n = parseFloat(val);
  if (isNaN(n)) return '--';
  if (n >= 10000) return n.toFixed(1);
  if (n >= 1000) return n.toFixed(2);
  if (n >= 1) return n.toFixed(4);
  if (n >= 0.01) return n.toFixed(6);
  return n.toFixed(8);
}

function formatVolume(val) {
  if (val == null || val === '') return '--';
  var n = parseFloat(val);
  if (isNaN(n)) return '--';
  if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(2) + 'K';
  return n.toFixed(2);
}

function formatNum(val) {
  if (val == null || val === '') return '0.00';
  var n = parseFloat(val);
  if (isNaN(n)) return '0.00';
  return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 });
}

function formatQty(val) {
  if (val == null || val === '') return '0';
  var n = parseFloat(val);
  if (isNaN(n)) return '0';
  var dec;
  if (Math.abs(n) >= 1000000) dec = 0;
  else if (Math.abs(n) >= 1000) dec = 2;
  else if (Math.abs(n) >= 1) dec = 4;
  else if (Math.abs(n) >= 0.001) dec = 6;
  else dec = 8;
  return n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: dec });
}

function formatTime(date) {
  if (!date || isNaN(date.getTime())) return '--';
  var h = String(date.getHours()).padStart(2, '0');
  var m = String(date.getMinutes()).padStart(2, '0');
  var s = String(date.getSeconds()).padStart(2, '0');
  return h + ':' + m + ':' + s;
}

function formatSymbol(sym) {
  if (!sym) return '';
  var quotes = ['USDT','BUSD','USDC','FDUSD','BTC','ETH','BNB'];
  for (var i = 0; i < quotes.length; i++) {
    if (sym.endsWith(quotes[i]) && sym.length > quotes[i].length) {
      return sym.slice(0, -quotes[i].length) + '-' + quotes[i];
    }
  }
  return sym;
}

function escapeHtml(text) {
  if (text == null) return '';
  var str = String(text);
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeAttr(text) {
  if (text == null) return '';
  return String(text).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function setElText(id, val) {
  var el = document.getElementById(id);
  if (el) el.textContent = (val != null) ? val : '--';
}

function setInputVal(id, val) {
  var el = document.getElementById(id);
  if (el && val != null && val !== undefined) el.value = val;
}

function getInputVal(id) {
  var el = document.getElementById(id);
  return el ? el.value.trim() : '';
}

function numVal(str, def) {
  var v = parseFloat(str);
  return isNaN(v) ? def : v;
}

function intVal(str, def) {
  var v = parseInt(str, 10);
  return isNaN(v) ? def : v;
}

function setToggle(id, active) {
  var el = document.getElementById(id);
  if (!el) return;
  if (active) el.classList.add('active');
  else el.classList.remove('active');
}

function getToggle(id) {
  var el = document.getElementById(id);
  return el ? el.classList.contains('active') : false;
}

// =====================================================================
// WALLET (CARTEIRA) TAB
// =====================================================================
function onWalletLoading(data) {
  var loadingEl = document.getElementById('wallet-loading');
  var refreshBtn = document.getElementById('wallet-refresh-btn');
  if (data.loading) {
    if (loadingEl) loadingEl.style.display = 'block';
    if (refreshBtn) refreshBtn.disabled = true;
  } else {
    if (loadingEl) loadingEl.style.display = 'none';
    if (refreshBtn) refreshBtn.disabled = false;
  }
}

function onWalletSnapshots(data) {
  state.walletSnapshots = data.snapshots || [];
  drawWalletMiniChart();
}

function onWalletSnapshotAdd(data) {
  if (!data || !data.timestamp) return;
  state.walletSnapshots.push({ timestamp: data.timestamp, totalUSDT: data.totalUSDT || 0 });
  // Limitar a 500 snapshots no JS
  if (state.walletSnapshots.length > 500) state.walletSnapshots.shift();
  drawWalletMiniChart();
}

function drawWalletMiniChart() {
  var canvas = document.getElementById('wallet-mini-chart');
  if (!canvas) return;
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  if (rect.width === 0) return;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  var W = rect.width;
  var H = rect.height;

  ctx.fillStyle = '#0b0e11';
  ctx.fillRect(0, 0, W, H);

  var snaps = state.walletSnapshots;
  var infoEl = document.getElementById('wallet-chart-info');
  var pnlEl = document.getElementById('wallet-chart-pnl');

  if (snaps.length < 2) {
    if (infoEl) infoEl.textContent = snaps.length + ' snapshot' + (snaps.length !== 1 ? 's' : '');
    if (pnlEl) { pnlEl.textContent = '$0.00'; pnlEl.style.color = 'var(--text-muted)'; }
    ctx.fillStyle = '#848e9c';
    ctx.font = '11px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText('Aguardando snapshots...', W / 2, H / 2 + 4);
    return;
  }

  var firstVal = snaps[0].totalUSDT;
  var lastVal = snaps[snaps.length - 1].totalUSDT;
  var change = lastVal - firstVal;
  var changePct = firstVal > 0 ? (change / firstVal * 100) : 0;

  if (infoEl) infoEl.textContent = snaps.length + ' snapshots';
  if (pnlEl) {
    pnlEl.textContent = (change >= 0 ? '+' : '') + '$' + change.toFixed(2) +
      ' (' + (changePct >= 0 ? '+' : '') + changePct.toFixed(1) + '%)';
    pnlEl.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
  }

  var pad = 4;
  var cW = W - pad * 2;
  var cH = H - pad * 2;

  var minV = snaps[0].totalUSDT, maxV = snaps[0].totalUSDT;
  for (var i = 1; i < snaps.length; i++) {
    if (snaps[i].totalUSDT < minV) minV = snaps[i].totalUSDT;
    if (snaps[i].totalUSDT > maxV) maxV = snaps[i].totalUSDT;
  }
  var range = maxV - minV;
  if (range === 0) range = maxV * 0.01 || 10;
  minV -= range * 0.1;
  maxV += range * 0.1;

  function xP(idx) { return pad + (idx / (snaps.length - 1)) * cW; }
  function yP(val) { return pad + cH - ((val - minV) / (maxV - minV)) * cH; }

  // Baseline (primeiro valor) - linha pontilhada
  var baseY = yP(firstVal);
  ctx.save();
  ctx.strokeStyle = '#555';
  ctx.lineWidth = 0.5;
  ctx.setLineDash([2, 2]);
  ctx.beginPath();
  ctx.moveTo(pad, baseY);
  ctx.lineTo(W - pad, baseY);
  ctx.stroke();
  ctx.restore();

  // Area fill - verde acima da baseline, vermelho abaixo
  // Green area (acima da baseline)
  ctx.beginPath();
  ctx.moveTo(xP(0), Math.min(yP(snaps[0].totalUSDT), baseY));
  for (var i = 0; i < snaps.length; i++) ctx.lineTo(xP(i), Math.min(yP(snaps[i].totalUSDT), baseY));
  ctx.lineTo(xP(snaps.length - 1), baseY);
  ctx.lineTo(xP(0), baseY);
  ctx.closePath();
  ctx.fillStyle = 'rgba(14,203,129,0.15)';
  ctx.fill();
  // Red area (abaixo da baseline)
  ctx.beginPath();
  ctx.moveTo(xP(0), Math.max(yP(snaps[0].totalUSDT), baseY));
  for (var i = 0; i < snaps.length; i++) ctx.lineTo(xP(i), Math.max(yP(snaps[i].totalUSDT), baseY));
  ctx.lineTo(xP(snaps.length - 1), baseY);
  ctx.lineTo(xP(0), baseY);
  ctx.closePath();
  ctx.fillStyle = 'rgba(246,70,93,0.15)';
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(xP(0), yP(snaps[0].totalUSDT));
  for (var i = 1; i < snaps.length; i++) ctx.lineTo(xP(i), yP(snaps[i].totalUSDT));
  ctx.strokeStyle = change >= 0 ? '#0ecb81' : '#f6465d';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Last point dot
  ctx.beginPath();
  ctx.arc(xP(snaps.length - 1), yP(lastVal), 2.5, 0, Math.PI * 2);
  ctx.fillStyle = change >= 0 ? '#0ecb81' : '#f6465d';
  ctx.fill();
}

var _walletCache = { totalUSDT: 0, balances: [] };

function onWalletData(data) {
  _walletCache.totalUSDT = data.totalUSDT || 0;
  _walletCache.balances = (data.balances || []).slice();
  _walletCache.balances.sort(function(a, b) { return (b.valueUSDT || 0) - (a.valueUSDT || 0); });

  setElText('wallet-total-usdt', '$' + _walletCache.totalUSDT.toLocaleString('en-US', {
    minimumFractionDigits: 2, maximumFractionDigits: 2
  }));
  setElText('wallet-asset-count', _walletCache.balances.length + ' ativo' + (_walletCache.balances.length !== 1 ? 's' : ''));

  renderWalletTable();
  drawWalletMiniChart();
}

function renderWalletTable() {
  var tbody = document.getElementById('wallet-tbody');
  if (!tbody) return;

  var minFilter = parseFloat(document.getElementById('wallet-min-filter').value) || 0;
  var totalUSDT = _walletCache.totalUSDT;
  var balances = _walletCache.balances;

  var filtered = balances.filter(function(b) { return (b.valueUSDT || 0) >= minFilter; });

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="placeholder-text">Nenhum ativo acima de $' + minFilter.toFixed(2) + '</td></tr>';
    return;
  }

  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var b = filtered[i];
    var total = (b.free || 0) + (b.locked || 0);
    var valueUSDT = b.valueUSDT || 0;
    var pct = totalUSDT > 0 ? (valueUSDT / totalUSDT * 100) : 0;

    var isStable = ['USDT','BUSD','USDC','FDUSD'].indexOf(b.asset) >= 0;
    if (isStable) {
      html += '<tr>';
      html += '<td style="font-weight:600;">' + escapeHtml(b.asset) + '</td>';
    } else {
      html += '<tr class="wallet-row-clickable" style="cursor:pointer;" onclick="openCoinHistory(\'' + escapeAttr(b.asset) + '\')" title="Ver historico">';
      html += '<td style="font-weight:600;">' + escapeHtml(b.asset) + ' <span style="font-size:10px;color:var(--text-muted);">&#128200;</span></td>';
    }
    html += '<td>' + formatNum(b.free) + '</td>';
    html += '<td>' + formatNum(b.locked) + '</td>';
    html += '<td style="font-weight:600;">' + formatNum(total) + '</td>';
    html += '<td style="font-weight:600; color:var(--accent);">$' +
      valueUSDT.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) +
      '<span style="font-size:10px; color:var(--text-muted); margin-left:6px;">(' +
      pct.toFixed(1) + '%)</span></td>';
    html += '</tr>';
  }
  html += '<tr style="border-top:1px solid var(--border);"><td colspan="4" style="font-size:11px; color:var(--text-muted); text-align:right;">Exibindo ' + filtered.length + ' de ' + balances.length + ' ativos</td><td></td></tr>';
  tbody.innerHTML = html;
}

// =====================================================================
// PERFORMANCE TAB
// =====================================================================
function parseTradeTimestamp(ts) {
  if (!ts) return new Date(0);
  // Format: "dd/mm/yyyy hh:nn:ss"
  var parts = ts.split(' ');
  if (parts.length < 2) return new Date(0);
  var d = parts[0].split('/');
  var t = parts[1].split(':');
  if (d.length < 3 || t.length < 3) return new Date(0);
  return new Date(parseInt(d[2]), parseInt(d[1])-1, parseInt(d[0]), parseInt(t[0]), parseInt(t[1]), parseInt(t[2]));
}

function formatDuration(ms) {
  if (ms <= 0) return '--';
  var sec = Math.floor(ms / 1000);
  if (sec < 60) return sec + 's';
  var min = Math.floor(sec / 60);
  if (min < 60) return min + 'm ' + (sec % 60) + 's';
  var hrs = Math.floor(min / 60);
  if (hrs < 24) return hrs + 'h ' + (min % 60) + 'm';
  var days = Math.floor(hrs / 24);
  return days + 'd ' + (hrs % 24) + 'h';
}

function calculatePerformance() {
  var result = {
    totalTrades: 0,
    buys: 0,
    sells: 0,
    totalPnl: 0,
    wins: 0,
    losses: 0,
    bestTrade: null,
    worstTrade: null,
    pairs: [],
    openPositions: [],
    symbolStats: {},
    equityCurve: []
  };

  if (state.trades.length === 0) return result;

  // Sort chronologically (oldest first) - state.trades is newest first
  var sorted = state.trades.slice().sort(function(a, b) {
    return parseTradeTimestamp(a.timestamp) - parseTradeTimestamp(b.timestamp);
  });

  result.totalTrades = sorted.length;

  // Count buys/sells
  for (var i = 0; i < sorted.length; i++) {
    if (sorted[i].side === 'BUY') result.buys++;
    else result.sells++;
  }

  // FIFO matching: BUY queue per symbol
  var buyQueues = {};

  for (var i = 0; i < sorted.length; i++) {
    var t = sorted[i];
    var sym = t.symbol || 'UNKNOWN';
    var price = parseFloat(t.price) || 0;
    var qty = parseFloat(t.quantity) || 0;

    if (!buyQueues[sym]) buyQueues[sym] = [];

    if (t.side === 'BUY') {
      buyQueues[sym].push({
        price: price,
        quantity: qty,
        timestamp: t.timestamp,
        signal: t.signal,
        confidence: t.confidence,
        date: parseTradeTimestamp(t.timestamp)
      });
    } else if (t.side === 'SELL' && buyQueues[sym].length > 0) {
      // Match with oldest BUY
      var buy = buyQueues[sym].shift();
      var FEE_PCT = 0.2; // Round-trip fee: 0.1% buy + 0.1% sell
      var matchQty = Math.min(buy.quantity, qty);
      var grossPnl = (price - buy.price) * matchQty;
      var feeCost = (buy.price * matchQty + price * matchQty) * (FEE_PCT / 200); // 0.1% de cada lado
      var pnl = grossPnl - feeCost;
      var pnlPct = buy.price > 0 ? ((price - buy.price) / buy.price) * 100 - FEE_PCT : 0;
      var sellDate = parseTradeTimestamp(t.timestamp);
      var duration = sellDate - buy.date;

      var pair = {
        symbol: sym,
        entryPrice: buy.price,
        exitPrice: price,
        quantity: matchQty,
        pnl: pnl,
        pnlPct: pnlPct,
        duration: duration,
        entryTime: buy.timestamp,
        exitTime: t.timestamp,
        signal: buy.signal || t.signal
      };

      result.pairs.push(pair);
      result.totalPnl += pnl;

      if (pnl > 0) result.wins++;
      else result.losses++;

      if (result.bestTrade === null || pnl > result.bestTrade.pnl) result.bestTrade = pair;
      if (result.worstTrade === null || pnl < result.worstTrade.pnl) result.worstTrade = pair;

      // Symbol stats
      if (!result.symbolStats[sym]) result.symbolStats[sym] = { trades: 0, pnl: 0, wins: 0, losses: 0 };
      result.symbolStats[sym].trades++;
      result.symbolStats[sym].pnl += pnl;
      if (pnl > 0) result.symbolStats[sym].wins++;
      else result.symbolStats[sym].losses++;

      // Equity curve point
      result.equityCurve.push({
        date: sellDate,
        pnl: result.totalPnl
      });
    }
  }

  // Collect open positions (unmatched BUYs)
  for (var sym in buyQueues) {
    for (var j = 0; j < buyQueues[sym].length; j++) {
      var b = buyQueues[sym][j];
      result.openPositions.push({
        symbol: sym,
        price: b.price,
        quantity: b.quantity,
        value: b.price * b.quantity,
        timestamp: b.timestamp
      });
    }
  }

  return result;
}

function drawEquityCurve(data) {
  var canvas = document.getElementById('equity-canvas');
  if (!canvas) return;
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  var W = rect.width;
  var H = rect.height;

  // Background
  ctx.fillStyle = '#0b0e11';
  ctx.fillRect(0, 0, W, H);

  var curve = data.equityCurve;
  if (curve.length < 2) {
    ctx.fillStyle = '#848e9c';
    ctx.font = '13px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText('Necessario pelo menos 2 trades pareados para gerar o grafico.', W/2, H/2);
    return;
  }

  var pad = { top: 20, right: 20, bottom: 30, left: 65 };
  var cW = W - pad.left - pad.right;
  var cH = H - pad.top - pad.bottom;

  // Find min/max P&L
  var minPnl = 0, maxPnl = 0;
  for (var i = 0; i < curve.length; i++) {
    if (curve[i].pnl < minPnl) minPnl = curve[i].pnl;
    if (curve[i].pnl > maxPnl) maxPnl = curve[i].pnl;
  }
  // Add margin
  var range = maxPnl - minPnl;
  if (range === 0) range = 10;
  minPnl -= range * 0.1;
  maxPnl += range * 0.1;

  function xPos(idx) { return pad.left + (idx / (curve.length - 1)) * cW; }
  function yPos(val) { return pad.top + cH - ((val - minPnl) / (maxPnl - minPnl)) * cH; }

  // Grid lines
  ctx.strokeStyle = '#2b3139';
  ctx.lineWidth = 0.5;
  var gridSteps = 5;
  for (var g = 0; g <= gridSteps; g++) {
    var gVal = minPnl + (maxPnl - minPnl) * (g / gridSteps);
    var gy = yPos(gVal);
    ctx.beginPath();
    ctx.moveTo(pad.left, gy);
    ctx.lineTo(W - pad.right, gy);
    ctx.stroke();
    ctx.fillStyle = '#848e9c';
    ctx.font = '10px Consolas';
    ctx.textAlign = 'right';
    ctx.fillText(gVal.toFixed(2), pad.left - 6, gy + 3);
  }

  // Zero line (dashed)
  if (minPnl < 0 && maxPnl > 0) {
    var zy = yPos(0);
    ctx.save();
    ctx.strokeStyle = '#848e9c';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(pad.left, zy);
    ctx.lineTo(W - pad.right, zy);
    ctx.stroke();
    ctx.restore();
  }

  // Area fill: green above zero, red below zero
  var zeroY = yPos(0);
  // Green area (above zero)
  ctx.beginPath();
  ctx.moveTo(xPos(0), Math.min(yPos(curve[0].pnl), zeroY));
  for (var i = 0; i < curve.length; i++) {
    var y = yPos(curve[i].pnl);
    ctx.lineTo(xPos(i), Math.min(y, zeroY));
  }
  ctx.lineTo(xPos(curve.length - 1), zeroY);
  ctx.lineTo(xPos(0), zeroY);
  ctx.closePath();
  ctx.fillStyle = 'rgba(14,203,129,0.12)';
  ctx.fill();

  // Red area (below zero)
  ctx.beginPath();
  ctx.moveTo(xPos(0), Math.max(yPos(curve[0].pnl), zeroY));
  for (var i = 0; i < curve.length; i++) {
    var y = yPos(curve[i].pnl);
    ctx.lineTo(xPos(i), Math.max(y, zeroY));
  }
  ctx.lineTo(xPos(curve.length - 1), zeroY);
  ctx.lineTo(xPos(0), zeroY);
  ctx.closePath();
  ctx.fillStyle = 'rgba(246,70,93,0.12)';
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(curve[0].pnl));
  for (var i = 1; i < curve.length; i++) {
    ctx.lineTo(xPos(i), yPos(curve[i].pnl));
  }
  var lastPnl = curve[curve.length - 1].pnl;
  ctx.strokeStyle = lastPnl >= 0 ? '#0ecb81' : '#f6465d';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Dots
  for (var i = 0; i < curve.length; i++) {
    ctx.beginPath();
    ctx.arc(xPos(i), yPos(curve[i].pnl), 3, 0, Math.PI * 2);
    ctx.fillStyle = curve[i].pnl >= 0 ? '#0ecb81' : '#f6465d';
    ctx.fill();
  }

  // X-axis labels (trade numbers)
  ctx.fillStyle = '#848e9c';
  ctx.font = '10px Consolas';
  ctx.textAlign = 'center';
  var labelStep = Math.max(1, Math.floor(curve.length / 8));
  for (var i = 0; i < curve.length; i += labelStep) {
    ctx.fillText('#' + (i + 1), xPos(i), H - pad.bottom + 16);
  }
  // Always show last
  if ((curve.length - 1) % labelStep !== 0) {
    ctx.fillText('#' + curve.length, xPos(curve.length - 1), H - pad.bottom + 16);
  }
}

function renderPerformance() {
  var data = calculatePerformance();

  // Cards
  document.getElementById('perf-total-trades').textContent = data.totalTrades;
  document.getElementById('perf-buy-sell').textContent = data.buys + ' / ' + data.sells;

  var pnlEl = document.getElementById('perf-total-pnl');
  pnlEl.textContent = (data.totalPnl >= 0 ? '+' : '') + data.totalPnl.toFixed(2);
  pnlEl.className = 'perf-card-value ' + (data.totalPnl > 0 ? 'positive' : data.totalPnl < 0 ? 'negative' : 'neutral');

  var totalPaired = data.wins + data.losses;
  var wrEl = document.getElementById('perf-win-rate');
  if (totalPaired > 0) {
    var wr = (data.wins / totalPaired * 100).toFixed(1);
    wrEl.textContent = wr + '%';
    wrEl.className = 'perf-card-value ' + (parseFloat(wr) >= 50 ? 'positive' : 'negative');
  } else {
    wrEl.textContent = '--';
    wrEl.className = 'perf-card-value neutral';
  }

  var bestEl = document.getElementById('perf-best-trade');
  if (data.bestTrade) {
    bestEl.textContent = '+' + data.bestTrade.pnl.toFixed(2);
    bestEl.title = formatSymbol(data.bestTrade.symbol) + ' (' + data.bestTrade.pnlPct.toFixed(2) + '%)';
  } else { bestEl.textContent = '--'; }

  var worstEl = document.getElementById('perf-worst-trade');
  if (data.worstTrade) {
    worstEl.textContent = data.worstTrade.pnl.toFixed(2);
    worstEl.title = formatSymbol(data.worstTrade.symbol) + ' (' + data.worstTrade.pnlPct.toFixed(2) + '%)';
  } else { worstEl.textContent = '--'; }

  // Equity curve chart
  drawEquityCurve(data);

  // Per-symbol table
  var symTbody = document.getElementById('perf-symbol-tbody');
  var symKeys = Object.keys(data.symbolStats);
  if (symKeys.length === 0) {
    symTbody.innerHTML = '<tr><td colspan="4" class="placeholder-text">Sem dados.</td></tr>';
  } else {
    // Sort by P&L desc
    symKeys.sort(function(a, b) { return data.symbolStats[b].pnl - data.symbolStats[a].pnl; });
    var symHtml = '';
    for (var i = 0; i < symKeys.length; i++) {
      var s = data.symbolStats[symKeys[i]];
      var wr = s.trades > 0 ? (s.wins / s.trades * 100).toFixed(1) + '%' : '--';
      var rowCls = s.pnl >= 0 ? 'perf-row-positive' : 'perf-row-negative';
      symHtml += '<tr class="' + rowCls + '">';
      symHtml += '<td style="font-weight:600;">' + escapeHtml(formatSymbol(symKeys[i])) + '</td>';
      symHtml += '<td>' + s.trades + '</td>';
      symHtml += '<td class="' + (s.pnl >= 0 ? 'positive' : 'negative') + '">' + (s.pnl >= 0 ? '+' : '') + s.pnl.toFixed(2) + '</td>';
      symHtml += '<td>' + wr + '</td>';
      symHtml += '</tr>';
    }
    symTbody.innerHTML = symHtml;
  }

  // Open positions table (mais recentes primeiro)
  data.openPositions.sort(function(a, b) {
    var ta = a.timestamp ? new Date(a.timestamp).getTime() : 0;
    var tb = b.timestamp ? new Date(b.timestamp).getTime() : 0;
    return tb - ta;
  });
  var openTbody = document.getElementById('perf-open-tbody');
  if (data.openPositions.length === 0) {
    openTbody.innerHTML = '<tr><td colspan="4" class="placeholder-text">Nenhuma posicao aberta.</td></tr>';
  } else {
    var openHtml = '';
    for (var i = 0; i < data.openPositions.length; i++) {
      var p = data.openPositions[i];
      openHtml += '<tr>';
      openHtml += '<td style="font-weight:600;">' + escapeHtml(formatSymbol(p.symbol)) + '</td>';
      openHtml += '<td>' + formatPrice(p.price) + '</td>';
      openHtml += '<td>' + formatQty(p.quantity) + '</td>';
      openHtml += '<td>' + p.value.toFixed(2) + ' USDT</td>';
      openHtml += '</tr>';
    }
    openTbody.innerHTML = openHtml;
  }

  // Paired trades table
  var pairsTbody = document.getElementById('perf-pairs-tbody');
  if (data.pairs.length === 0) {
    pairsTbody.innerHTML = '<tr><td colspan="8" class="placeholder-text">Nenhum trade pareado.</td></tr>';
  } else {
    var pairsHtml = '';
    // Show newest first
    for (var i = data.pairs.length - 1; i >= 0; i--) {
      var pr = data.pairs[i];
      var rowCls = pr.pnl >= 0 ? 'perf-row-positive' : 'perf-row-negative';
      pairsHtml += '<tr class="' + rowCls + '">';
      pairsHtml += '<td style="font-weight:600;">' + escapeHtml(formatSymbol(pr.symbol)) + '</td>';
      pairsHtml += '<td style="font-size:11px;">' + formatPrice(pr.entryPrice) + '<br><span style="color:var(--text-muted);">' + escapeHtml(pr.entryTime) + '</span></td>';
      pairsHtml += '<td style="font-size:11px;">' + formatPrice(pr.exitPrice) + '<br><span style="color:var(--text-muted);">' + escapeHtml(pr.exitTime) + '</span></td>';
      pairsHtml += '<td>' + formatQty(pr.quantity) + '</td>';
      pairsHtml += '<td class="' + (pr.pnl >= 0 ? 'positive' : 'negative') + '" style="font-weight:600;">' + (pr.pnl >= 0 ? '+' : '') + pr.pnl.toFixed(2) + '</td>';
      pairsHtml += '<td class="' + (pr.pnlPct >= 0 ? 'positive' : 'negative') + '">' + (pr.pnlPct >= 0 ? '+' : '') + pr.pnlPct.toFixed(2) + '%</td>';
      pairsHtml += '<td>' + formatDuration(pr.duration) + '</td>';
      pairsHtml += '<td>' + escapeHtml(pr.signal || '--') + '</td>';
      pairsHtml += '</tr>';
    }
    pairsTbody.innerHTML = pairsHtml;
  }
}

// =====================================================================
// COIN HISTORY MODAL
// =====================================================================
var coinHistoryState = {
  symbol: '', asset: '', timeframe: '1h',
  candles1h: [], candles24h: [], ticker: null
};

function openCoinHistory(asset) {
  var symbol = asset + 'USDT';
  coinHistoryState.symbol = symbol;
  coinHistoryState.asset = asset;
  coinHistoryState.timeframe = '1h';
  coinHistoryState.candles1h = [];
  coinHistoryState.candles24h = [];
  coinHistoryState.ticker = null;

  var modal = document.getElementById('coin-history-modal');
  modal.classList.add('active');
  document.getElementById('modal-symbol').textContent = formatSymbol(symbol);
  document.getElementById('modal-price').textContent = '';
  document.getElementById('modal-change').textContent = '';
  document.getElementById('modal-loading').style.display = 'block';
  document.getElementById('modal-loading').textContent = 'Carregando historico...';
  document.getElementById('modal-data').style.display = 'none';
  document.getElementById('modal-tf-1h').classList.add('active');
  document.getElementById('modal-tf-24h').classList.remove('active');

  sendToDelphi('coinHistory', { symbol: symbol });
}

function closeCoinHistoryModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('coin-history-modal').classList.remove('active');
}

function onCoinHistoryData(data) {
  if (data.error) {
    document.getElementById('modal-loading').textContent = 'Erro: ' + data.error;
    return;
  }
  if (data.symbol !== coinHistoryState.symbol) return;

  coinHistoryState.candles1h = data.candles1h || [];
  coinHistoryState.candles24h = data.candles24h || [];

  // Header
  document.getElementById('modal-price').textContent = formatPrice(data.lastPrice);
  var changePct = data.priceChangePct || 0;
  var changeAbs = data.priceChange || 0;
  var changeEl = document.getElementById('modal-change');
  var isUp = changePct >= 0;
  var sign = isUp ? '+' : '';
  changeEl.textContent = sign + formatPrice(changeAbs) + ' (' + sign + changePct.toFixed(2) + '%)';
  changeEl.style.color = isUp ? 'var(--green)' : 'var(--red)';

  // Stats
  document.getElementById('modal-high').textContent = formatPrice(data.highPrice);
  document.getElementById('modal-low').textContent = formatPrice(data.lowPrice);
  var vol = data.quoteVolume || 0;
  document.getElementById('modal-volume').textContent =
    vol >= 1e6 ? (vol / 1e6).toFixed(2) + 'M' :
    vol >= 1e3 ? (vol / 1e3).toFixed(1) + 'K' : vol.toFixed(2);

  document.getElementById('modal-loading').style.display = 'none';
  document.getElementById('modal-data').style.display = 'block';
  drawModalChart();
}

function switchModalTimeframe(tf) {
  coinHistoryState.timeframe = tf;
  document.getElementById('modal-tf-1h').classList.toggle('active', tf === '1h');
  document.getElementById('modal-tf-24h').classList.toggle('active', tf === '24h');
  drawModalChart();
}

function drawModalChart() {
  var canvas = document.getElementById('modal-chart-canvas');
  if (!canvas) return;

  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  if (rect.width === 0) return;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  var W = rect.width, H = rect.height;

  ctx.fillStyle = '#0b0e11';
  ctx.fillRect(0, 0, W, H);

  var candles = coinHistoryState.timeframe === '1h'
    ? coinHistoryState.candles1h : coinHistoryState.candles24h;

  if (!candles || candles.length < 2) {
    ctx.fillStyle = '#848e9c';
    ctx.font = '12px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText('Sem dados disponiveis', W / 2, H / 2);
    return;
  }

  var prices = [], times = [];
  for (var i = 0; i < candles.length; i++) {
    prices.push(parseFloat(candles[i].c));
    times.push(candles[i].t);
  }

  var minP = Math.min.apply(null, prices);
  var maxP = Math.max.apply(null, prices);
  var range = maxP - minP;
  if (range === 0) range = maxP * 0.01 || 1;
  minP -= range * 0.08;
  maxP += range * 0.08;

  var pad = { top: 12, bottom: 20, left: 8, right: 60 };
  var cW = W - pad.left - pad.right;
  var cH = H - pad.top - pad.bottom;
  function xP(idx) { return pad.left + (idx / (prices.length - 1)) * cW; }
  function yP(val) { return pad.top + cH - ((val - minP) / (maxP - minP)) * cH; }

  var isUp = prices[prices.length - 1] >= prices[0];
  var lineColor = isUp ? '#0ecb81' : '#f6465d';
  var fillColor = isUp ? 'rgba(14,203,129,0.12)' : 'rgba(246,70,93,0.12)';

  // Area fill
  ctx.beginPath();
  ctx.moveTo(xP(0), yP(prices[0]));
  for (var i = 1; i < prices.length; i++) ctx.lineTo(xP(i), yP(prices[i]));
  ctx.lineTo(xP(prices.length - 1), pad.top + cH);
  ctx.lineTo(xP(0), pad.top + cH);
  ctx.closePath();
  ctx.fillStyle = fillColor;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(xP(0), yP(prices[0]));
  for (var i = 1; i < prices.length; i++) ctx.lineTo(xP(i), yP(prices[i]));
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Last point dot
  ctx.beginPath();
  ctx.arc(xP(prices.length - 1), yP(prices[prices.length - 1]), 3, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.fill();

  // Grid lines + price axis (right)
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  for (var g = 0; g <= 4; g++) {
    var gy = pad.top + (cH / 4) * g;
    var gPrice = maxP - ((maxP - minP) / 4) * g;
    ctx.strokeStyle = 'rgba(43,49,57,0.4)';
    ctx.lineWidth = 0.5;
    ctx.setLineDash([2, 2]);
    ctx.beginPath();
    ctx.moveTo(pad.left, gy);
    ctx.lineTo(W - pad.right, gy);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#848e9c';
    ctx.font = '10px Segoe UI';
    ctx.fillText(formatPriceAxis(gPrice), W - pad.right + 4, gy);
  }

  // Time axis (bottom)
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillStyle = '#848e9c';
  ctx.font = '10px Segoe UI';
  var timeIdxs = [0, Math.floor(prices.length / 4), Math.floor(prices.length / 2),
                  Math.floor(prices.length * 3 / 4), prices.length - 1];
  for (var ti = 0; ti < timeIdxs.length; ti++) {
    var idx = timeIdxs[ti];
    var dt = new Date(times[idx]);
    var label = ('0'+dt.getHours()).slice(-2) + ':' + ('0'+dt.getMinutes()).slice(-2);
    ctx.fillText(label, xP(idx), pad.top + cH + 4);
  }
}

// =====================================================================
// COIN SELECTOR MODAL
// =====================================================================
state.allSymbols = [];

function openCoinSelectorModal() {
  var modal = document.getElementById('coin-selector-modal');
  modal.classList.add('active');
  document.getElementById('coin-search-input').value = '';
  document.getElementById('coin-selector-list').innerHTML = '';
  document.getElementById('coin-selector-loading').style.display = 'block';
  setTimeout(function() {
    document.getElementById('coin-search-input').focus();
  }, 100);
  sendToDelphi('getAllSymbols', {});
}

function closeCoinSelectorModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('coin-selector-modal').classList.remove('active');
}

function onAllSymbols(data) {
  state.allSymbols = data.symbols || [];
  document.getElementById('coin-selector-loading').style.display = 'none';
  renderCoinSelectorList('');
}

function filterCoinSelector() {
  var query = (document.getElementById('coin-search-input').value || '').toUpperCase().trim();
  renderCoinSelectorList(query);
}

function renderCoinSelectorList(filter) {
  var list = state.allSymbols;
  if (!list || list.length === 0) {
    document.getElementById('coin-selector-list').innerHTML =
      '<div style="text-align:center;padding:20px;color:var(--text-muted);">Nenhum par encontrado</div>';
    return;
  }

  var filtered = [];
  for (var i = 0; i < list.length; i++) {
    var sym = list[i].symbol || '';
    var base = sym.replace('USDT', '');
    if (filter && sym.indexOf(filter) < 0 && base.indexOf(filter) < 0) continue;
    filtered.push(list[i]);
    if (filtered.length >= 100) break; // Limita a 100 para performance
  }

  if (filtered.length === 0) {
    document.getElementById('coin-selector-list').innerHTML =
      '<div style="text-align:center;padding:20px;color:var(--text-muted);">Nenhum resultado para "' + escapeHtml(filter) + '"</div>';
    return;
  }

  var html = '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
  html += '<thead><tr style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">';
  html += '<th style="text-align:left;padding:6px 12px;">Par</th>';
  html += '<th style="text-align:right;padding:6px 12px;">Preco</th>';
  html += '<th style="text-align:right;padding:6px 12px;">24h</th>';
  html += '<th style="text-align:right;padding:6px 12px;">Vol (USDT)</th>';
  html += '</tr></thead><tbody>';

  for (var j = 0; j < filtered.length; j++) {
    var item = filtered[j];
    var symbol = item.symbol || '';
    var price = parseFloat(item.price) || 0;
    var change = parseFloat(item.change) || 0;
    var vol = parseFloat(item.volume) || 0;
    var changeColor = change >= 0 ? 'var(--green)' : 'var(--red)';
    var changeSign = change >= 0 ? '+' : '';
    var isSelected = (symbol === state.selectedCoin);

    html += '<tr onclick="selectFromModal(\'' + escapeAttr(symbol) + '\')" ' +
      'style="cursor:pointer;border-top:1px solid var(--border);' +
      (isSelected ? 'background:rgba(0,200,255,0.1);' : '') + '" ' +
      'onmouseover="this.style.background=\'rgba(255,255,255,0.05)\'" ' +
      'onmouseout="this.style.background=\'' + (isSelected ? 'rgba(0,200,255,0.1)' : '') + '\'">';
    html += '<td style="padding:8px 12px;font-weight:600;">' + escapeHtml(symbol.replace('USDT', '')) +
      '<span style="color:var(--text-muted);font-weight:400;font-size:11px;"> /USDT</span></td>';
    html += '<td style="text-align:right;padding:8px 12px;">' + formatPrice(price) + '</td>';
    html += '<td style="text-align:right;padding:8px 12px;color:' + changeColor + ';">' + changeSign + change.toFixed(2) + '%</td>';
    html += '<td style="text-align:right;padding:8px 12px;color:var(--text-muted);">' + formatVolume(vol) + '</td>';
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('coin-selector-list').innerHTML = html;
}

function selectFromModal(symbol) {
  closeCoinSelectorModal();
  doSelectCoin(symbol);
}

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    var modal = document.getElementById('coin-history-modal');
    if (modal && modal.classList.contains('active')) closeCoinHistoryModal();
    var selectorModal = document.getElementById('coin-selector-modal');
    if (selectorModal && selectorModal.classList.contains('active')) closeCoinSelectorModal();
  }
});

// =====================================================================
// CHAT IA
// =====================================================================
function sendChatMessage() {
  var input = document.getElementById('chat-input');
  var text = input.value.trim();
  if (!text || state.chatWaiting) return;

  // Add user message to history and UI
  state.chatHistory.push({ role: 'user', content: text });
  renderChatMessage('user', text);
  input.value = '';
  input.style.height = 'auto';

  // Show typing indicator
  state.chatWaiting = true;
  document.getElementById('chat-send-btn').disabled = true;
  var typingEl = document.createElement('div');
  typingEl.className = 'chat-typing';
  typingEl.id = 'chat-typing';
  typingEl.innerHTML = 'Pensando<span class="chat-typing-dots"></span>';
  document.getElementById('chat-messages').appendChild(typingEl);
  scrollChatToBottom();

  // Send to Delphi with full history
  sendToDelphi('chatMessage', { history: state.chatHistory });
}

var toolLabels = {
  'get_price': 'Buscando preco',
  'get_ticker_24h': 'Buscando dados 24h',
  'get_top_gainers': 'Buscando maiores altas',
  'get_top_losers': 'Buscando maiores quedas',
  'get_technical_indicators': 'Calculando indicadores',
  'get_klines': 'Buscando candles',
  'get_open_positions': 'Verificando posicoes',
  'get_wallet_balance': 'Consultando carteira',
  'get_trade_history': 'Buscando historico',
  'get_order_book': 'Analisando livro de ofertas'
};

function onChatToolCall(data) {
  var typing = document.getElementById('chat-typing');
  if (typing) {
    var toolName = data.tool || '';
    var label = toolLabels[toolName] || ('Executando ' + toolName);
    typing.innerHTML = label + '<span class="chat-typing-dots"></span>';
  }
}

function onChatResponse(data) {
  state.chatWaiting = false;
  document.getElementById('chat-send-btn').disabled = false;

  // Remove typing indicator
  var typing = document.getElementById('chat-typing');
  if (typing) typing.remove();

  var content = data.content || '';
  var isError = content.startsWith('Erro:');

  // Add AI response to history
  if (!isError) {
    state.chatHistory.push({ role: 'assistant', content: content });
  }

  renderChatMessage('ai', content, isError);
  scrollChatToBottom();
}

function renderChatMessage(role, content, isError) {
  var container = document.getElementById('chat-messages');

  // Remove welcome message if present
  var welcome = container.querySelector('.chat-welcome');
  if (welcome) welcome.remove();

  var wrapper = document.createElement('div');

  if (role === 'user') {
    wrapper.className = 'chat-msg chat-msg-user';
    wrapper.textContent = content;
  } else {
    wrapper.className = 'chat-msg chat-msg-ai';
    if (isError) {
      wrapper.innerHTML = '<span class="chat-msg-error">' + escapeHtml(content) + '</span>';
    } else {
      wrapper.innerHTML = renderMarkdown(content);
    }
  }

  // Timestamp
  var timeEl = document.createElement('div');
  timeEl.className = 'chat-msg-time';
  timeEl.textContent = formatTime(new Date());
  wrapper.appendChild(timeEl);

  container.appendChild(wrapper);
  scrollChatToBottom();
}

function renderMarkdown(text) {
  // Simple markdown rendering
  var html = escapeHtml(text);
  // Bold: **text**
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic: *text*
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Inline code: `code`
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Unordered lists: - item or * item
  html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  // Ordered lists: 1. item
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  // Headers: ### text
  html = html.replace(/^### (.+)$/gm, '<strong style="font-size:14px;">$1</strong>');
  html = html.replace(/^## (.+)$/gm, '<strong style="font-size:15px;">$1</strong>');
  // Line breaks to paragraphs
  html = html.replace(/\n\n/g, '</p><p>');
  html = html.replace(/\n/g, '<br>');
  html = '<p>' + html + '</p>';
  // Clean empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');
  return html;
}

function clearChatHistory() {
  if (state.chatHistory.length === 0) return;
  if (!confirm('Limpar todo o historico do chat?')) return;
  state.chatHistory = [];
  state.chatWaiting = false;
  document.getElementById('chat-send-btn').disabled = false;
  document.getElementById('chat-messages').innerHTML =
    '<div class="chat-welcome">' +
    '<div class="chat-welcome-icon">&#x1F916;</div>' +
    '<div class="chat-welcome-text">Ola! Sou seu assistente especialista em trading na Binance.<br>' +
    'Pergunte sobre analise tecnica, estrategias, gestao de risco ou qualquer duvida sobre cripto.</div>' +
    '</div>';
}

function chatInputKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
  // Auto-resize textarea
  setTimeout(function() {
    var el = e.target;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }, 0);
}

function scrollChatToBottom() {
  var el = document.getElementById('chat-messages');
  setTimeout(function() { el.scrollTop = el.scrollHeight; }, 50);
}

// =====================================================================
// INITIALIZATION
// =====================================================================
// Relogio no rodape
function updateFooterClock() {
  var now = new Date();
  var d = ('0'+now.getDate()).slice(-2)+'/'+('0'+(now.getMonth()+1)).slice(-2)+'/'+now.getFullYear();
  var t = ('0'+now.getHours()).slice(-2)+':'+('0'+now.getMinutes()).slice(-2)+':'+('0'+now.getSeconds()).slice(-2);
  document.getElementById('footer-clock').textContent = d + '  ' + t;
}
updateFooterClock();
setInterval(updateFooterClock, 1000);

setTimeout(function() {
  sendToDelphi('pageReady');
  appendLog('SYSTEM', 'Interface carregada. Pronto para operar.', formatTime(new Date()));
}, 200);
</script>
</body>
</html>
